<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="description" content="Use the SpectroDraw web app to draw, visualize, and sculpt sound directly on the spectrogram. Free, browser-based sound design.">
  <meta property="og:title" content="SpectroDraw Web App - Interactive Spectrogram Editor">
  <meta property="og:description" content="Draw directly on audio with the SpectroDraw web app. Visual sound editing, real-time playback, and more — all in your browser.">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="canonical" href="https://spectrodraw.com/app">
  <title>SpectroDraw - Interactive spectrogram editor</title>
  <link rel="stylesheet" type="text/css" href="style.css">
  <link rel="icon" type="image/x-icon" href="/favicon.ico">
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4104479922308013"
     crossorigin="anonymous"></script>
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-FYGHLB1BCP"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-FYGHLB1BCP');
  </script>
</head>
<body>
  <script>
    let hasPro;
    (async function loadProUIInIframeOverlay() {
      try {
        function getCurrentUserEmail() {
          try {
            const raw = localStorage.getItem('spectrodraw_user');
            if (!raw) return null;
            const parsed = JSON.parse(raw);
            return parsed?.email || parsed?.user || parsed?.id || null;
          } catch (e) { return null; }
        }
        const email = getCurrentUserEmail();
        if (!email) return;
        const stored = (() => {
          try { return localStorage.getItem('spectrodraw_user'); }
          catch (e) { return null; }
        })();

        const headers = { 'Accept': 'application/json' };
        if (stored) headers['X-Spectrodraw-User'] = stored;

        let res;
        try {
          res = await fetch('https://api.spectrodraw.com/api/products', {
            method: 'GET',
            credentials: 'include',
            headers
          });
        } catch (err) {
          return;
        }
        if (!res || !res.ok) return;
        const j = await res.json().catch(()=>null);
        if (!j || !Array.isArray(j.products)) return;
        const found = j.products.some(entry =>
          entry && typeof entry.email === 'string' &&
          entry.email.toLowerCase() === email.toLowerCase() && entry.product === "SpectroDraw Pro"
        );
        if (!found) return;
        /////////////////////////////////
        
        hasPro = true;
        // Overlay
        const _overlay = document.createElement("div");
        Object.assign(_overlay.style, {
          position: "fixed",
          inset: "0",
          background: "rgba(0,0,0,0.6)",
          display: "flex",
          alignItems: "center",
          justifyContent: "center",
          zIndex: "10000"
        });

        // Modal box
        const modal = document.createElement("div");
        Object.assign(modal.style, {
          background: "#111",
          width: "400px",
          maxWidth: "90%",
          padding: "20px",
          borderRadius: "8px",
          position: "relative",
          boxShadow: "0 10px 30px rgba(255,255,255,0.3)",
          fontFamily: "sans-serif"
        });

        // Close button (X)
        const closeBtn = document.createElement("button");
        closeBtn.textContent = "✕";
        Object.assign(closeBtn.style, {
          position: "absolute",
          top: "10px",
          right: "10px",
          border: "none",
          color: "#aaa",
          background:"none",
          fontSize: "18px",
          cursor: "pointer"
        });
        const targetDate = new Date("February 15, 2026 00:00:00").getTime();

        const content = document.createElement("div");
        content.style.textAlign = "center";
        function updateCountdown() {
          const now = Date.now();
          let diff = targetDate - now;
          const days = Math.floor(diff / (1000 * 60 * 60 * 24));
          diff %= 1000 * 60 * 60 * 24;
          const hours = Math.floor(diff / (1000 * 60 * 60));
          diff %= 1000 * 60 * 60;
          const minutes = Math.floor(diff / (1000 * 60));
          diff %= 1000 * 60;
          const seconds = Math.floor(diff / 1000);
          content.innerHTML = `<br>
          <h2>Thank you for claiming SpectroDraw Pro!</h2>
          <p>This feature is currently in development and will be available soon. Follow me on social media for updates!</p>
          <div id="social-row" style="display:flex;gap:20px;flex-wrap:wrap;margin-top:8px;align-items:center;justify-content:center;">
            <button class="social-btn" title="YouTube" style="background:#FFFFFF;" onClick="window.open('https://www.youtube.com/@spectrodraw', '_blank')">
              <svg xmlns="http://www.w3.org/2000/svg" class="external-icon" viewBox="0 0 28.57  20" focusable="false">
                <svg viewBox="0 0 28.57 20" preserveAspectRatio="xMidYMid meet" xmlns="http://www.w3.org/2000/svg">
                  <g>
                    <path d="M27.9727 3.12324C27.6435 1.89323 26.6768 0.926623 25.4468 0.597366C23.2197 2.24288e-07 14.285 0 14.285 0C14.285 0 5.35042 2.24288e-07 3.12323 0.597366C1.89323 0.926623 0.926623 1.89323 0.597366 3.12324C2.24288e-07 5.35042 0 10 0 10C0 10 2.24288e-07 14.6496 0.597366 16.8768C0.926623 18.1068 1.89323 19.0734 3.12323 19.4026C5.35042 20 14.285 20 14.285 20C14.285 20 23.2197 20 25.4468 19.4026C26.6768 19.0734 27.6435 18.1068 27.9727 16.8768C28.5701 14.6496 28.5701 10 28.5701 10C28.5701 10 28.5677 5.35042 27.9727 3.12324Z" fill="#FF0000"></path>
                    <path d="M11.4253 14.2854L18.8477 10.0004L11.4253 5.71533V14.2854Z" fill="white"></path>
                  </g>
                </svg>
              </svg>  
            </button>
            <button class="social-btn" title="Tiktok" style="background:#000;" onClick="window.open('https://www.tiktok.com/@spectrodraw', '_blank')">
              <svg viewBox="0 0 96 96" fill="none" xmlns="http://www.w3.org/2000/svg">
                <rect width="96" height="96" rx="21" fill="black" style="fill:black;fill-opacity:1;"/>
                <path d="M73.31 25.7456C72.785 25.4743 72.274 25.1769 71.7788 24.8545C70.3389 23.9025 69.0186 22.7808 67.8465 21.5135C64.9139 18.158 63.8186 14.7538 63.4151 12.3705H63.4313C63.0943 10.3921 63.2337 9.11214 63.2547 9.11214H49.8974V60.7624C49.8974 61.4558 49.8974 62.1412 49.8682 62.8185C49.8682 62.9027 49.8601 62.9805 49.8553 63.0712C49.8553 63.1085 49.8553 63.1474 49.8472 63.1863C49.8472 63.196 49.8472 63.2057 49.8472 63.2154C49.7064 65.0686 49.1123 66.8588 48.1173 68.4286C47.1222 69.9983 45.7566 71.2994 44.1407 72.2175C42.4565 73.1757 40.5517 73.6782 38.614 73.6757C32.3906 73.6757 27.3468 68.6011 27.3468 62.334C27.3468 56.0669 32.3906 50.9923 38.614 50.9923C39.7921 50.9912 40.9629 51.1766 42.083 51.5415L42.0992 37.9412C38.6989 37.502 35.2444 37.7722 31.9538 38.7348C28.6631 39.6975 25.6077 41.3317 22.9802 43.5343C20.678 45.5346 18.7425 47.9214 17.2608 50.5872C16.6969 51.5594 14.5695 55.4658 14.3119 61.8058C14.1499 65.4044 15.2306 69.1326 15.7458 70.6734V70.7058C16.0699 71.6132 17.3256 74.7094 19.372 77.3197C21.0221 79.4135 22.9716 81.2527 25.1579 82.7783V82.7459L25.1903 82.7783C31.6567 87.1724 38.8263 86.884 38.8263 86.884C40.0674 86.8338 44.2249 86.884 48.9463 84.6464C54.183 82.1658 57.1642 78.47 57.1642 78.47C59.0688 76.2618 60.5832 73.7452 61.6426 71.0282C62.8513 67.8509 63.2547 64.0401 63.2547 62.5171V35.1155C63.4168 35.2127 65.5749 36.6401 65.5749 36.6401C65.5749 36.6401 68.6842 38.633 73.5352 39.9309C77.0155 40.8544 81.7045 41.0488 81.7045 41.0488V27.7887C80.0615 27.9669 76.7255 27.4485 73.31 25.7456Z" fill="white" style="fill:white;fill-opacity:1;"/>
              </svg>
            </button>
            
            <button class="social-btn" title="YouTube" style="background:#FE0381;" onClick="window.open('https://www.instagram.com/spectrodraw/', '_blank')">
              <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:sodipodi="http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape" viewBox="0 0 264.5833 264.5833" inkscape:version="1.0.1 (3bc2e813f5, 2020-09-07)" sodipodi:docname="Instagram_(2022).svg"><defs><radialGradient id="f" cx="158.429" cy="578.088" r="52.3515" xlink:href="#a" gradientUnits="userSpaceOnUse" gradientTransform="matrix(0 -4.03418 4.28018 0 -2332.2273 942.2356)" fx="158.429" fy="578.088"/><radialGradient inkscape:collect="always" xlink:href="#b" id="g" gradientUnits="userSpaceOnUse" gradientTransform="matrix(.67441 -1.16203 1.51283 .87801 -814.3657 -47.8354)" cx="172.6149" cy="600.6924" fx="172.6149" fy="600.6924" r="65"/><radialGradient inkscape:collect="always" xlink:href="#c" id="h" cx="144.012" cy="51.3367" fx="144.012" fy="51.3367" r="67.081" gradientTransform="matrix(-2.3989 .67549 -.23008 -.81732 464.9957 -26.4035)" gradientUnits="userSpaceOnUse"/><radialGradient inkscape:collect="always" xlink:href="#d" id="e" gradientUnits="userSpaceOnUse" gradientTransform="matrix(-3.10797 .87652 -.6315 -2.23914 1345.6503 1374.1983)" cx="199.7884" cy="628.4379" fx="199.7884" fy="628.4379" r="52.3515"/><linearGradient inkscape:collect="always" id="d"><stop offset="0" stop-color="#ff005f"/><stop offset="1" stop-color="#fc01d8"/></linearGradient><linearGradient id="c"><stop offset="0" stop-color="#780cff"/><stop stop-color="#820bff" offset="1" stop-opacity="0"/>
                </linearGradient><linearGradient inkscape:collect="always" id="b"><stop offset="0" stop-color="#fc0"/><stop offset="1" stop-color="#fc0" stop-opacity="0"/></linearGradient><linearGradient id="a"><stop offset="0" stop-color="#fc0"/><stop offset=".1242" stop-color="#fc0"/><stop offset=".5672" stop-color="#fe4a05"/><stop offset=".6942" stop-color="#ff0f3f"/><stop offset="1" stop-color="#fe0657" stop-opacity="0"/>
                </linearGradient></defs><sodipodi:namedview pagecolor="#ffffff" bordercolor="#666666" borderopacity="1" inkscape:pageopacity="0" inkscape:pageshadow="2" inkscape:zoom=".515" inkscape:cx="500" inkscape:cy="500" inkscape:document-units="mm" inkscape:current-layer="layer1" inkscape:document-rotation="0" showgrid="false" inkscape:window-width="1366" inkscape:window-height="705" inkscape:window-x="-8" inkscape:window-y="-8" inkscape:window-maximized="1"/><g inkscape:label="Layer 1" inkscape:groupmode="layer"><path d="M204.1503 18.1429c-55.2305 0-71.3834.057-74.5232.3175-11.3342.9424-18.387 2.7275-26.0708 6.554-5.9214 2.9413-10.5915 6.3506-15.2005 11.1298-8.3938 8.7157-13.481 19.4383-15.3226 32.1842-.8953 6.1877-1.1558 7.4496-1.2087 39.0558-.0203 10.5354 0 24.4007 0 42.9984 0 55.2008.061 71.3418.3256 74.4764.9157 11.032 2.6453 17.9728 6.3081 25.565 7 14.5329 20.369 25.4428 36.119 29.5137 5.4535 1.4044 11.4767 2.1779 19.2092 2.5442 3.2762.1425 36.6684.2443 70.081.2443 33.4127 0 66.8253-.0407 70.02-.2035 8.9535-.4214 14.1526-1.1195 19.9011-2.6054 15.8517-4.0912 28.9767-14.8383 36.119-29.5748 3.5916-7.409 5.4128-14.6144 6.237-25.0704.179-2.2796.2543-38.6263.2543-74.924 0-36.304-.0814-72.5835-.2605-74.8632-.8343-10.6249-2.6555-17.7692-6.363-25.3207-3.0421-6.1816-6.42-10.798-11.324-15.518-8.752-8.3616-19.4555-13.4502-32.2101-15.2902-6.18-.8936-7.411-1.1582-39.033-1.2131z" inkscape:connector-curvature="0" fill="url(#e)" transform="translate(-71.8155 -18.1429)"/><path d="M204.1503 18.1429c-55.2305 0-71.3834.057-74.5232.3175-11.3342.9424-18.387 2.7275-26.0708 6.554-5.9214 2.9413-10.5915 6.3506-15.2005 11.1298-8.3938 8.7157-13.481 19.4383-15.3226 32.1842-.8953 6.1877-1.1558 7.4496-1.2087 39.0558-.0203 10.5354 0 24.4007 0 42.9984 0 55.2008.061 71.3418.3256 74.4764.9157 11.032 2.6453 17.9728 6.3081 25.565 7 14.5329 20.369 25.4428 36.119 29.5137 5.4535 1.4044 11.4767 2.1779 19.2092 2.5442 3.2762.1425 36.6684.2443 70.081.2443 33.4127 0 66.8253-.0407 70.02-.2035 8.9535-.4214 14.1526-1.1195 19.9011-2.6054 15.8517-4.0912 28.9767-14.8383 36.119-29.5748 3.5916-7.409 5.4128-14.6144 6.237-25.0704.179-2.2796.2543-38.6263.2543-74.924 0-36.304-.0814-72.5835-.2605-74.8632-.8343-10.6249-2.6555-17.7692-6.363-25.3207-3.0421-6.1816-6.42-10.798-11.324-15.518-8.752-8.3616-19.4555-13.4502-32.2101-15.2902-6.18-.8936-7.411-1.1582-39.033-1.2131z" inkscape:connector-curvature="0" fill="url(#f)" transform="translate(-71.8155 -18.1429)"/>
                  <path d="M204.1503 18.1429c-55.2305 0-71.3834.057-74.5232.3175-11.3342.9424-18.387 2.7275-26.0708 6.554-5.9214 2.9413-10.5915 6.3506-15.2005 11.1298-8.3938 8.7157-13.481 19.4383-15.3226 32.1842-.8953 6.1877-1.1558 7.4496-1.2087 39.0558-.0203 10.5354 0 24.4007 0 42.9984 0 55.2008.061 71.3418.3256 74.4764.9157 11.032 2.6453 17.9728 6.3081 25.565 7 14.5329 20.369 25.4428 36.119 29.5137 5.4535 1.4044 11.4767 2.1779 19.2092 2.5442 3.2762.1425 36.6684.2443 70.081.2443 33.4127 0 66.8253-.0407 70.02-.2035 8.9535-.4214 14.1526-1.1195 19.9011-2.6054 15.8517-4.0912 28.9767-14.8383 36.119-29.5748 3.5916-7.409 5.4128-14.6144 6.237-25.0704.179-2.2796.2543-38.6263.2543-74.924 0-36.304-.0814-72.5835-.2605-74.8632-.8343-10.6249-2.6555-17.7692-6.363-25.3207-3.0421-6.1816-6.42-10.798-11.324-15.518-8.752-8.3616-19.4555-13.4502-32.2101-15.2902-6.18-.8936-7.411-1.1582-39.033-1.2131z" inkscape:connector-curvature="0" fill="url(#g)" transform="translate(-71.8155 -18.1429)"/>
                  <path d="M204.1503 18.1429c-55.2305 0-71.3834.057-74.5232.3175-11.3342.9424-18.387 2.7275-26.0708 6.554-5.9214 2.9413-10.5915 6.3506-15.2005 11.1298-8.3938 8.7157-13.481 19.4383-15.3226 32.1842-.8953 6.1877-1.1558 7.4496-1.2087 39.0558-.0203 10.5354 0 24.4007 0 42.9984 0 55.2008.061 71.3418.3256 74.4764.9157 11.032 2.6453 17.9728 6.3081 25.565 7 14.5329 20.369 25.4428 36.119 29.5137 5.4535 1.4044 11.4767 2.1779 19.2092 2.5442 3.2762.1425 36.6684.2443 70.081.2443 33.4127 0 66.8253-.0407 70.02-.2035 8.9535-.4214 14.1526-1.1195 19.9011-2.6054 15.8517-4.0912 28.9767-14.8383 36.119-29.5748 3.5916-7.409 5.4128-14.6144 6.237-25.0704.179-2.2796.2543-38.6263.2543-74.924 0-36.304-.0814-72.5835-.2605-74.8632-.8343-10.6249-2.6555-17.7692-6.363-25.3207-3.0421-6.1816-6.42-10.798-11.324-15.518-8.752-8.3616-19.4555-13.4502-32.2101-15.2902-6.18-.8936-7.411-1.1582-39.033-1.2131z" inkscape:connector-curvature="0" fill="url(#h)" transform="translate(-71.8155 -18.1429)"/>
                  <path d="M132.3452 33.973c-26.7167 0-30.0696.1167-40.5629.5939-10.4727.4792-17.6212 2.136-23.8762 4.567-6.4701 2.5107-11.9586 5.8693-17.4265 11.3352-5.472 5.464-8.8332 10.9483-11.354 17.4116-2.4389 6.2524-4.099 13.3976-4.5703 23.8585-.4693 10.4854-.5923 13.8379-.5923 40.5348 0 26.697.1189 30.0371.5943 40.5225.4817 10.465 2.1397 17.6082 4.5703 23.8585 2.5147 6.4654 5.8758 11.9497 11.3458 17.4136 5.466 5.468 10.9544 8.8349 17.4204 11.3456 6.259 2.4309 13.4097 4.0877 23.8803 4.567 10.4933.477 13.8441.5938 40.5588.5938 26.7188 0 30.0615-.1167 40.5547-.5939 10.4728-.4792 17.6295-2.136 23.8885-4.567 6.4681-2.5106 11.9484-5.8775 17.4143-11.3455 5.472-5.4639 8.8332-10.9482 11.354-17.4115 2.4183-6.2524 4.0784-13.3976 4.5703-23.8585.4713-10.4854.5943-13.8277.5943-40.5246 0-26.697-.123-30.0473-.5943-40.5328-.4919-10.465-2.152-17.6081-4.5703-23.8584-2.5208-6.4654-5.882-11.9498-11.354-17.4137-5.4721-5.468-10.9442-8.8266-17.4204-11.3353-6.2714-2.4309-13.424-4.0877-23.8967-4.5669-10.4933-.4772-13.8339-.5939-40.5588-.5939zm-8.825 17.7147c2.6193-.0041 5.5418 0 8.825 0 26.2659 0 29.379.0942 39.7513.5652 9.5915.4383 14.7971 2.0397 18.2648 3.3852 4.5908 1.7817 7.8638 3.9116 11.3048 7.3521 3.4431 3.4406 5.5745 6.7173 7.3617 11.3046 1.3465 3.461 2.9512 8.6628 3.3877 18.2472.4714 10.3625.5739 13.4754.5739 39.7095 0 26.234-.1025 29.347-.5739 39.7095-.4386 9.5843-2.0412 14.7861-3.3877 18.2471-1.783 4.5874-3.9186 7.8539-7.3617 11.2923-3.443 3.4406-6.712 5.5704-11.3048 7.3521-3.4636 1.3517-8.6733 2.949-18.2648 3.3873-10.3702.471-13.4854.5734-39.7513.5734-26.2679 0-29.381-.1024-39.7513-.5734-9.5914-.4423-14.797-2.0438-18.2668-3.3893-4.5908-1.7817-7.87-3.9116-11.313-7.3521-3.4431-3.4405-5.5745-6.709-7.3617-11.2985-1.3465-3.461-2.9512-8.6628-3.3877-18.2471-.4714-10.3626-.5657-13.4754-.5657-39.7259 0-26.2504.0943-29.347.5657-39.7095.4386-9.5844 2.0412-14.7861 3.3877-18.2512 1.783-4.5874 3.9186-7.8641 7.3617-11.3046 3.443-3.4406 6.7222-5.5704 11.313-7.3562 3.4677-1.3517 8.6754-2.949 18.2668-3.3894 9.075-.4096 12.5919-.5324 30.9264-.553zm61.3363 16.322c-6.5173 0-11.805 5.2776-11.805 11.792 0 6.5125 5.2877 11.7962 11.805 11.7962 6.5172 0 11.8049-5.2837 11.8049-11.7962 0-6.5124-5.2877-11.796-11.805-11.796zm-52.5113 13.7826c-27.8993 0-50.5191 22.6031-50.5191 50.4817 0 27.8786 22.6198 50.4714 50.5191 50.4714s50.511-22.5928 50.511-50.4714c0-27.8786-22.6137-50.4817-50.513-50.4817zm0 17.7147c18.109 0 32.7914 14.6694 32.7914 32.767 0 18.0956-14.6824 32.767-32.7914 32.767-18.111 0-32.7913-14.6714-32.7913-32.767 0-18.0976 14.6803-32.767 32.7913-32.767z" inkscape:connector-curvature="0" fill="#fff"/></g></svg>
            </button>
          </div>
          <h1 style="color:#9333ea;text-shadow: 0 0 20px rgba(250, 102, 234, 0.5);">${days}d ${hours}h ${minutes}m ${seconds}s</h1>
          `;
          }
          updateCountdown();
        const timer = setInterval(updateCountdown, 1000);
        function close() {
          document.body.removeChild(_overlay);
        }
        document.addEventListener("keydown",e=>{if (e.key==="Escape") close();});
        closeBtn.onclick = close;
        _overlay.onclick = (e) => {
          if (e.target === _overlay) close();
        };
        modal.appendChild(closeBtn);
        modal.appendChild(content);
        _overlay.appendChild(modal);
        document.body.appendChild(_overlay);
      

        /////////////////////////////////
        return;
        const overlay = document.createElement('div');
        overlay.id = 'spectrodraw-pro-iframe-overlay';
        overlay.setAttribute('role','dialog');
        overlay.setAttribute('aria-modal','true');
        overlay.innerHTML = `
          <div class="sd-pro__frame-wrap" role="document">
            <div class="sd-pro__loading" aria-hidden="true">
              <div class="sd-pro__spinner" aria-hidden="true"></div>
              <div class="sd-pro__text">Loading SpectroDraw Pro…</div>
            </div>
            <iframe class="sd-pro__iframe" title="SpectroDraw Pro"></iframe>
            <!--<button class="sd-pro__close" aria-label="Close SpectroDraw Pro">✕</button>-->
          </div>
          <style>
            #spectrodraw-pro-iframe-overlay{
              position:fixed;
              inset:0;
              display:flex;
              align-items:center;
              justify-content:center;
              background: rgba(0,0,0,0.45);
              z-index:2147483647;
              -webkit-font-smoothing:antialiased;
              -moz-osx-font-smoothing:grayscale;
            }
            .sd-pro__frame-wrap{
              width:100%;
              height:100%;
              max-width:100%;
              max-height:100%;
              position:relative;
            }
            .sd-pro__iframe{
              position:fixed;
              inset:0;
              width:100%;
              height:100%;
              border:0;
              background: rgba(0,0,0,0.72);
            }
            .sd-pro__loading{
              position: absolute;
              left:50%;
              top:48%;
              transform:translate(-50%,-50%);
              text-align:center;
              z-index:2147483650;
              pointer-events:none;
            }
            .sd-pro__spinner{
              width:52px;
              height:52px;
              border-radius:50%;
              border:6px solid rgba(255,255,255,0.08);
              border-top-color: rgba(255,255,255,0.6);
              animation: sd-spin 0.9s linear infinite;
              margin:0 auto 12px;
            }
            @keyframes sd-spin{ to{ transform: rotate(360deg); } }
            .sd-pro__text{ font-size:15px; color:#fff; 
              font-family: 'Inter', 'Segoe UI', sans-serif;}
          </style>
        `;
        try {
          (document.documentElement || document.body || document).appendChild(overlay);
        } catch (e) {
          window.addEventListener('load', ()=> document.body.appendChild(overlay), { once: true });
        }
        const iframe = overlay.querySelector('.sd-pro__iframe');
        const loadingEl = overlay.querySelector('.sd-pro__loading');
        let token;
        try {
          const tkRes = await fetch('https://api.spectrodraw.com/api/pro-token', {
            method: 'POST',
            credentials: 'include',
            headers
          });
          if (!tkRes || !tkRes.ok) {
            try { overlay.remove(); } catch (e) {}
            return;
          }
          const tkj = await tkRes.json().catch(()=>null);
          token = tkj && tkj.token;
          if (!token) {
            try { overlay.remove(); } catch (e) {}
            return;
          }
        } catch (err) {
          try { overlay.remove(); } catch (e) {}
          return;
        }
        iframe.src = 'https://api.spectrodraw.com/spectrodraw-pro/pro-ui-kv?t=' + encodeURIComponent(token);
        iframe.addEventListener('load', () => {
          if (loadingEl) loadingEl.style.display = 'none';
        });
        window.addEventListener('message', (ev) => {
          try {
            const allowedOrigin = new URL(iframe.src).origin;
            if (ev.origin !== allowedOrigin) return;
          } catch (e) { return; }
          if (!ev.data) return;
        }, false);
      } catch (err) {
        console.error('Error initializing SpectroDraw Pro overlay:', err);
      }
    })();
  </script>
<div class="app">
  <header class="top-bar">
    <a href="../index.html" id="home" title="Home" style="margin-left:10px;"><img src="../BannerLogo2.png" style="background:transparent; height: 32px;"></a>
    <button id="uploadBtn" title="Upload Audio" style="margin-left: 10px" class="top-btn">
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 20 20" fill="none" stroke="#333" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
        <line x1="10" y1="16" x2="10" y2="6" />
        <polyline points="6 10 10 6 14 10" />
        <line x1="4" y1="16" x2="16" y2="16" />
      </svg>
    </button>
    <button id="rec" title="Record (Ctrl + space)" class="top-btn"></button>
    <input id="file" title="Import audio (Ctrl + O)" type="file" accept="audio/*,video/*" style="display:none;"/>
    <svg xmlns="http://www.w3.org/2000/svg" width="5" height="36" viewBox="0 0 5 24" fill="none" style="margin-left:5px;margin-right:5px;"><line x1="2" y1="0" x2="2" y2="24" stroke="#999" stroke-width="2" stroke-linecap="round"/></svg>
    <button id="playPause" title="Play (space)" class="top-btn">
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="#333" viewBox="9 8 16 16"><path d="M16 0 M14 22V10l8 6z"/></svg>
    </button>
    <button id="stop" title="Stop" class="top-btn">
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="#333" viewBox="0 0 20 20">
        <rect x="0" y="0" width="18" height="18" rx="2" ry="2"/>
      </svg>
    </button>
    
    <a href="/" id="home2" title="Home" style="margin-left:10px;display:none;"><img src="../BannerLogo2.png" style="background:transparent; height: 32px;"></a>
    <svg xmlns="http://www.w3.org/2000/svg" width="5" height="36" viewBox="0 0 5 24" fill="none" style="margin-left:5px;margin-right:5px;"><line x1="2" y1="0" x2="2" y2="24" stroke="#999" stroke-width="2" stroke-linecap="round"/></svg>
    <button class="shape-btn" data-shape="brush" id="brushBtn" title="Brush (b)">
      <svg xmlns="http://www.w3.org/2000/svg" 
           width="20" height="20" 
           viewBox="5 4 18 18" 
           fill="black">
        <path d="M20.71 4.63a2 2 0 0 0-2.83 0l-9.9 9.9a3 3 0 0 0-.78 1.37l-.69 2.76a1 1 0 0 0 1.21 1.21l2.76-.69a3 3 0 0 0 1.37-.78l9.9-9.9a2 2 0 0 0 0-2.83zm-11.24 11.3l-.88.22.22-.88 9.19-9.19.66.66z"/>
      </svg>
    </button>
    <button class="shape-btn" data-shape="rectangle" id="rectBtn" title="Rectangle (r)">
      <svg xmlns="http://www.w3.org/2000/svg" 
           width="20" height="20" viewBox="0 0 20 20" 
           fill="none"
           stroke = "black" stroke-width = "5">
        <path d="M0 0 H 20 V 20 H 0 V -20"/>
      </svg>
    </button>
    <button class="shape-btn" data-shape="line" id="lineBtn" title="Line (l)">
      <svg xmlns="http://www.w3.org/2000/svg" 
           width="20" height="20" viewBox="0 0 20 20" 
           fill="none"
           stroke = "black" stroke-width = "3">
        <path d="M20 0 L 0 20"/>
      </svg>
    </button>
    <button class="shape-btn" data-shape="image" id="imageBtn" title="Image Overlay (i)">
      <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="#333" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="18" cy="6" r="3" fill="#333" stroke="none"/>
        <polygon points="1,20 8,10 15,20" fill="#333"/>
        <polygon points="8,20 15,12 23,20" fill="#333"/>
      </svg>
    </button>
    <input type="file" id="overlayFile" accept="image/*" style="display:none;">
    <svg xmlns="http://www.w3.org/2000/svg" width="5" height="36" viewBox="0 0 5 24" fill="none" style="margin-left:5px;margin-right:5px;"><line x1="2" y1="0" x2="2" y2="24" stroke="#999" stroke-width="2" stroke-linecap="round"/></svg>
    <button class="tool-btn" data-tool="color" id="colorBtn" title="Color (c)">
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="#333">
        <circle cx="12" cy="12" r="9"/>
      </svg>
    </button>
    <button class="tool-btn" data-tool="blur" id="blurBtn" title="Blur (u)">
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="#333">
        <path d="M12 2C12 2 7 10 7 14a5 5 0 0 0 10 0c0-4-5-12-5-12z"/>
      </svg>
    </button>
    <button class="tool-btn" data-tool="eraser" id="eraserBtn" title="Eraser (e)">
      <svg width="20" height="20" viewBox="-1 -1 16 16">
        <path d="M5,0 L0,5 L5,10 L10,5 Z " fill="#333" stroke="#333" stroke-width="1"/>
        <path d="M5,10 L10,5 L15,10 L12,13 L8,13 Z" fill="white" stroke="#333" stroke-width="1"/>
      </svg>
    </button>
    <button class="tool-btn" data-tool="amplifier" id="amplifierBtn" title="Amplifier / Reducer (a)">
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 20 20" fill="none">
        <path d="M2 8V12C2 12.55 2.45 13 3 13H5L7 17C7.18 17.36 7.56 17.59 7.95 17.59C8.63 17.59 9.08 16.86 8.79 16.25L7.2 13H9L16 17V3L9 7H5V7H3C2.45 7 2 7.45 2 8Z" fill="#333"/>
        <path d="M18 7C18.55 7 19 7.45 19 8V12C19 12.55 18.55 13 18 13" stroke="#333" stroke-width="1.2" stroke-linecap="round"/>
      </svg>
    </button>
    <button class="tool-btn" data-tool="noiseRemover" id="noiseRemoverBtn" title="Noise Remover (x)">
      <img src="../assets/toothbrush.svg"></button>
    <svg xmlns="http://www.w3.org/2000/svg" width="5" height="36" viewBox="0 0 5 24" fill="none" style="margin-left:5px;margin-right:5px;"><line x1="2" y1="0" x2="2" y2="24" stroke="#999" stroke-width="2" stroke-linecap="round"/></svg>
    <button id="trueScale" title="Use true aspect ratio" class="top-btn">
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" aria-hidden="true" role="img">
        <g fill="none" stroke="black" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M3 9V3h6" />
          <path d="M21 15v6h-6" />
        </g>
      </svg>
    </button>
    <button id="yAxisMode" title="Toggle Y axis label mode (y)" class="top-btn">
      <svg xmlns="http://www.w3.org/2000/svg" 
         width="28" height="28" viewBox="0 0 20 20" 
         fill="none" stroke="black" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
        <text x="0" y="18" font-size="8" fill="black" stroke-width="0.5">1.0k</text>
        <text x="10" y="6" font-size="8" fill="black" stroke-width="0.5">a5</text>
        <line x1="4" y1="4" x2="18" y2="14" />
      </svg>
    </button>
    <svg xmlns="http://www.w3.org/2000/svg" width="5" height="36" viewBox="0 0 5 24" fill="none" style="margin-left:5px;margin-right:5px;"><line x1="2" y1="0" x2="2" y2="24" stroke="#999" stroke-width="2" stroke-linecap="round"/></svg>
    <button id="downloadWav" title="Download audio (ctrl + s)" class="top-btn">
      <svg width="20" height="20" viewBox="2 2 20 21" fill="none" stroke="#333" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M4 14v-2a8 8 0 0 1 16 0v2" />
        <path d="M5 14v4h2v-4H6z" />
        <path d="M17 14v4h2v-4h-2z" />
        <path d="M12 12v10" />
        <path d="M9 19l3 3 3 -3" />
      </svg>
    </button>
    <button id="downloadSpectrogram" title="Download spectrogram (ctrl + shift + s)" class="top-btn">
      <svg width="20" height="20" viewBox="2 2 20 21" fill="none" stroke="#333" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <rect x="3" y="3" width="18" height="14" rx="2" ry="2" />
        <circle cx="17" cy="7" r="2" />
        <polyline points="3 17 10 10 14 14 21 7" />
        <path d="M12 12v10" />
        <path d="M9 19l3 3 3 -3" />
      </svg>
    </button>
    <button id="downloadVideo" title="Download video" class="top-btn">
      <svg width="20" height="20" viewBox="0 0 22 22" fill="none" stroke="#333" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="11" cy="11" r="9" stroke="#333" stroke-width="1.8" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
        <polygon points="8,6.5 16,11 8,15.5" fill="#333" stroke="none" />
        <g transform="translate(11,15)" stroke="#333" stroke-width="1.8" fill="none" stroke-linecap="round" stroke-linejoin="round">
          <path d="M0 -2 V4" />
          <path d="M-3 1 L0 5 L3 1" />
        </g>
      </svg>
    </button>
    <button id="resetButton" onClick="onReset();" title="Reset audio" class="top-btn">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#333" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <rect x="5" y="7" width="14" height="14" rx="2" ry="2" />
        <line x1="8" x2="8" y1="11" y2 = "17" stroke-width="1"/>
        <line x1="12" x2="12" y1="11" y2 = "17" stroke-width="1"/>
        <line x1="16" x2="16" y1="11" y2 = "17" stroke-width="1"/>
        <rect x="3" y="4" width="18" height="3" rx="2" ry="2" />
        <rect x="8" y="1" width="8" height="2" rx="2" ry="2" stroke-width="1"/>
      </svg>
    </button>
    <button id="undoBtn" title="Undo (Ctrl+Z)" class="top-btn">
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="black" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M9 14H5V10"/>
        <path d="M20 20a9 9 0 0 0-15-6.7L5 10"/>
      </svg>
    </button>
    <button id="redoBtn" title="Redo (Ctrl+Y)" class="top-btn">
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="black" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M15 14h4v-4"/>
        <path d="M4 20a9 9 0 0 1 15-6.7L19 10"/>
      </svg>
    </button>
    <div title="Master Volume" style="display:flex;" id="masterVolumeDiv">
        <label class="h2">Volume</label>
        <input id="masterVolume" style="max-width:100px;" type="range" min="0" max="1" value="1" step="0.01">
        <input id="masterVolumeInput" style="width:45px;"type="number" value="1" min="0" max="1">
    </div>
  </header>
  <aside class="left-bar">
    <button class="panel-btn" id="settingsBtn" title="Project info (g)" data-tool="1">
      <svg xmlns="http://www.w3.org/2000/svg" 
          width="20" height="20" viewBox="0 0 24 24" 
          fill="none" stroke="white" stroke-width="2" 
          stroke-linecap="round" stroke-linejoin="round">
        <circle cx="12" cy="12" r="3"/>
        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 
                1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 
                1 1-4 0v-.09a1.65 1.65 0 0 0-1-1.51 
                1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 
                1 1-2.83-2.83l.06-.06a1.65 
                1.65 0 0 0 .33-1.82 1.65 
                1.65 0 0 0-1.51-1H3a2 2 0 
                1 1 0-4h.09a1.65 1.65 0 
                0 0 1.51-1 1.65 1.65 0 
                0 0-.33-1.82l-.06-.06a2 
                2 0 1 1 2.83-2.83l.06.06a1.65 
                1.65 0 0 0 1.82.33H9a1.65 
                1.65 0 0 0 1-1.51V3a2 2 
                0 1 1 4 0v.09a1.65 1.65 0 
                0 0 1 1.51 1.65 1.65 0 
                0 0 1.82-.33l.06-.06a2 
                2 0 1 1 2.83 2.83l-.06.06a1.65 
                1.65 0 0 0-.33 1.82V9c0 
                .69.28 1.35.77 1.82.49.47 
                1.15.77 1.82.77h.09a2 2 
                0 1 1 0 4h-.09c-.69 0-1.35.28-1.82.77z"/>
      </svg>
    </button>

    <!--Sprite-->
    <button class="panel-btn" id="spritesBtn" title="Sprites" data-tool="2">
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <polygon points="12,3 20,7 20,17 12,21 4,17 4,7" />
        <line x1="12" y1="11" x2="12" y2="21" />
        <line x1="4" y1="7" x2="12" y2="11" />
        <line x1="20" y1="7" x2="12" y2="11" />
      </svg>
    </button>

    <!--Uploads-->
    <button class="panel-btn" id="uploadsBtn" title="Uploads" data-tool="3">
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 22 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M2 6h18v11a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V6z" />
        <path d="M2 6V3h9v2" />
      </svg>
    </button>

    <!-- Midi -->
    <button class="panel-btn" id="pianoBtn" title="Piano (p)" data-tool="4">
      <svg xmlns="http://www.w3.org/2000/svg" 
          width="24" height="24" viewBox="0 0 24 22" 
          fill="none" stroke="white" stroke-width="2" 
          stroke-linecap="round" stroke-linejoin="round">
        <rect x="2" y="2" width="20" height="20" rx="2" ry="2"/>
        <line x1="7" y1="4" x2="7" y2="15" stroke-width="3"/>
        <line x1="17" y1="4" x2="17" y2="15" stroke-width="3"/>
        <line x1="12" y1="4" x2="12" y2="15" stroke-width="3"/>
      </svg>
    </button>

    <!-- EQ curve -->
    <button class="panel-btn" id="eqBtn" title="Equalizer (q)" data-tool="5">
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M3 17c2-4 4-6 8-6s6 4 10 4"/>
        <circle cx="3" cy="17" r="1.5" fill="white"/>
        <circle cx="11" cy="11" r="1.5" fill="white"/>
        <circle cx="21" cy="15" r="1.5" fill="white"/>
      </svg>
    </button>

    <!--Layers-->
    <button class="panel-btn" id="layersBtn" title="Layers" data-tool="6">
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <line x1="6"  y1="3" x2="6"  y2="21" />
        <line x1="12" y1="3" x2="12" y2="21" />
        <line x1="18" y1="3" x2="18" y2="21" />
        <rect x="2"  y="10.5" width="8"  height="3" rx="1.5" fill="white" stroke="white" stroke-width="1"/>
        <rect x="8"  y="5.5"  width="8"  height="3" rx="1.5" fill="white" stroke="white" stroke-width="1"/>
        <rect x="14" y="14.5" width="8"  height="3" rx="1.5" fill="white" stroke="white" stroke-width="1"/>
      </svg>
    </button>
    
  </aside>

  <aside class="left-panel" id="leftPanelAside" style="position:relative;">
    <div style="border:1px solid #888; padding: 4px; margin-top:-11px" id="midiv" title="Hold 'n' to preview pitch"><label id="mouseInfo">Pitch: 0hz<br>Time: 0.0<br>Loudness: -inf dB</label><br></div>
    <div id="d1">
      <h2 style="margin-bottom:10px;margin-top:10px;">General</h2>
      <div class="slider-row" title="Playback volume">
          <label class="h2">Playback volume</label>
          <input id="playbackVolume"  type="range" min="0" max="1" value="1" step="0.01">
          <input id="playbackVolumeInput" type="number" value="1" min="0" max="1">
      </div>
      <div class="slider-row" title="Oscillator Volume while drawing">
          <label class="h2">Draw volume</label>
          <input id="drawVolume"  type="range" min="0" max="1" value="1" step="0.01">
          <input id="drawVolumeInput" type="number" value="1" min="0" max="1">
      </div>
      <div id="fftParameters">
        <label class="h1">FFT Parameters
          <a id="fftLearnMore" class="learn-more" href="/faq/fft/#notes" title="Learn more about FFT / STFT" target="_blank" rel="noopener noreferrer" style="color:#777;font-size:10px;display:inline-block;transform:translateY(-1px)">Learn more</a>
        </label>
        <div class="slider-row">
          <label class="h2" title="Height of spectrogram in pixels.">Pitch resolution:</label>
          <select id="fftSize" style="margin-left:87px;">
            <option value="16384">16384</option>
            <option value="8192">8192</option>
            <option value="4096" selected>4096</option>
            <option value="2048">2048</option>
            <option value="1024">1024</option>
            <option value="512">512</option>
            <option value="256">256</option>
            <option value="128">128</option>
            <option value="64">64</option>
          </select>
        </div>
        <div class="slider-row" style="align-items:center;">
          <label class="h2" title="Number of audio samples given to each frame (x pixel).">Time resolution:</label>
          <button id="lockHopBtn" class="lock-btn" aria-pressed="true" title="Lock time resolution to prevent phase interference" style="background:none; border:none; margin-left:55px;" onclick="toggleLockHop();"></button>
          <input id="hopSize" type="number" value="1024" step="1" min="1" style="margin-left: 8px;">
        </div>
      </div>
      <label class="h1">Preset Audio<audio src=""></audio><br>
      </label>
      <label class="h2" for="presets">Use presets</label>
      <select id="presets">
        <option value="silence">Silence</option>
        <option value="male">Male sing</option>
        <option value="female">Female sing</option>
        <option value="dog">Dog</option>
        <option value="birdChirp">Bird chirp</option>
        <option value="lionRoar">Lion roar</option>
        <option value="seaLion">Sea lion</option>
        <option value="violin">Violin</option>
        <option value="trumpet">Trumpet</option>
        <option value="timpani">Timpani</option>
        <option value="piano">Piano</option>
        <option value="flute">Flute</option>
        <option value="cymbal">Cymbal</option>
        <option value="computerBeeps">Computer beeps</option>
        <option value="scream">Scream</option>
        <option value="bomb">Bomb</option>
        <option value="engine">Engine</option>
        <option value="fullSpectra">Loud noise</option>
        <option value="bass808">808 bass</option>
        <option value="hardstyle">Hardstyle</option>
        <option value="kick">Kick</option>
        <option value="hihat">Hihat</option>
        <option value="clap">Clap</option>
        <option value="cave14">Cave14.ogg</option>
        <option value="sine">Sine wave</option>
        <option value="triangle">Triangle wave</option>
        <option value="square">Square wave</option>
        <option value="saw">Saw wave</option>
      </select>
      <div id ="es" class="slider-row" title="Empty audio seconds">
        <label class="h2">Empty audio seconds</label>
        <input id="emptyAudioLength" type="range" min="0.01" max="100" step="0.01" value="10">
        <input id="emptyAudioLengthInput" type="number" value="10" min="0.01" max="100">
      </div>
      <div id="brushSettings">
        <label class="h1">Brush settings</label>
        <canvas id="strokePreview" width="300" height="100" style="border:1px solid #ccc; display:block; margin-top:10px;"></canvas>
        <div class="slider-row" title="Brush size/image size" id="brushSizeDiv">
          <label class="h2">Brush Size</label>
          <input id="brushSize" type="range" min="1" max="200" value="40">
          <input id="brushSizeInput" type="number" value="40" min="1" max="200">
        </div>
        <div class="slider-row" title="Brightness" id="brushBrightnessDiv">
            <label class="h2">Brush Brightness</label>
            <input id="brushBrightness" type="range" min="0" max="255" value="255">
            <input id="brushBrightnessInput" type="number" value="255" min="0" max="255">
        </div>
        <div class="slider-row" title="Blur Radius" style="display:none;" id="blurRadiusDiv">
            <label class="h2">Blur Radius</label>
            <input id="blurRadius"  type="range" min="0" max="10" value="1.5" step="0.1">
            <input id="blurRadiusInput" type="number" value="1.5" min="0" max="10">
        </div>
        <div class="slider-row" title="Blur Radius" style="display:none;" id="amplifyDiv">
            <label class="h2">Amplifier</label>
            <input id="amp"  type="range" min="0" max="2" value="2" step="0.01">
            <input id="ampInput" type="number" value="2" min="0" max="2">
        </div>
        <div class="slider-row" title="Remove noise below this threshold" style="display:none;" id="noiseFloorDiv">
            <label class="h2">Noise Threshold (dB)</label>
            <input id="noiseRemoveFloor"  type="range" min="-60" max="0" value="-10" step="0.1">
            <input id="noiseRemoveFloorInput" type="number" value="-10" min="-60" max="0">
        </div>
        <div id="ev" class="slider-row" title="Phase texture">
          <label class="h2" for="phaseTexture">Phase texture</label>
          <select id="phaseTexture">
            <option value="Static" selected>Static</option>
            <option value="Harmonics">Harmonics</option>
            <option value="Flat">Flat</option>

            <!-- Drum-friendly / creative phase textures -->
            <option value="ImpulseAlign">Custom Impulse</option>
            <option value="FrameAlignedImpulse">Frame Impulse</option>
            <option value="ExpectedAdvance">Expected Advance</option>
            <option value="PhasePropagate">Phase Propagate</option>
            <option value="RandomSmall">Random Small</option>
            <option value="HarmonicStack">Harmonic Stack</option>
            <option value="LinearDelay">Linear Delay</option>
            <option value="Chirp">Chirp</option>
            <option value="CopyFromRef">Reference frame</option>

            <option value="HopArtifact">Hop Artifact</option>
          </select>
        </div>
        <div class="slider-row" title="Phase" id="phaseSettingsDiv" style="display:none;">
            <label class="h2" id="phaseSettingsLabel"></label>
            <input id="phaseSettings"  type="range" min="0" max="0" value="0" step="0.01">
            <input id="phaseSettingsInput" type="number" value="0" min="0" max="0">
        </div>
        <div class="slider-row" title="Phase" id="phaseDiv">
            <label class="h2">Phase shift</label>
            <input id="phaseShift"  type="range" min="0" max="6.283" value="0" step="0.0001">
            <input id="phaseShiftInput" type="number" value="0" min="0" max="6.283">
        </div>
        <div class="slider-row" title="Phase strength" id="phaseStrengthDiv">
            <label class="h2">Phase Strength</label>
            <input id="phaseStrength"  type="range" min="0" max="100" value="100">
            <input id="phaseStrengthInput" type="number" value="100" min="0" max="100">
        </div>
        <div class="slider-row" title="Brightness strength">
            <label class="h2">Opacity</label>
            <input id="brushOpacity"  type="range" min="0" max="100" value="100">
            <input id="brushOpacityInput" type="number" value="100" min="0" max="100">
        </div>
        <div class="slider-row" title="Softness" id="softnessDiv">
            <label class="h2">Softness</label>
            <input id="softness"  type="range" min="0" max="1" value="0" step="0.01">
            <input id="softnessInput" type="number" value="0" min="0" max="1">
        </div>
      </div>


      <hr>
      <h3>Quick Effects</h3>
      <table id="globalXYTools"style="width:100%;">
        <thead>
          <div style="display:flex;flex-direction:row;" id="gxycbsrow">
            <p style="height:30px;margin:0;margin-top:5px;margin-right:5px;">Affect:</p>
            <button id="globalUseMagsCheckbox" class="gxycbs">Mags</button>
            <button id="globalUsePhasesCheckbox" class="gxycbs">Phases</button>
          </div>
        </thead>
        <tbody style="font-size:20px;">
          <tr>
            <td><div style="cursor:default;">X:</div></td>
            <td><div id="x-stretch" title="X stretch">↔</div></td>
            <td><div id="x-x2" title="2x slower">x2</div></td>
            <td><div id="x-/2" title="2x faster">/2</div></td>
            <td><div id="x-flip" title="Reverse time">Flip</div></td>
            <td><div id="x-translate" title="X translate">⇆</div></td>
            <td><div id="x-quantize" title="X Quantize" style="display: flex; align-items: center; justify-content: center;">
              <svg width="26" height="26" viewBox="0 0 22 22" xmlns="http://www.w3.org/2000/svg">
                <rect x="1"  y="1" width="5"  height="20" fill="none" stroke="white" stroke-width="2"/>
                <rect x="6"  y="1" width="5"  height="20" fill="none" stroke="white" stroke-width="2"/>
                <rect x="11" y="1" width="5"  height="20" fill="none" stroke="white" stroke-width="2"/>
                <rect x="16" y="1" width="5"  height="20" fill="none" stroke="white" stroke-width="2"/>
              </svg>
            </div></td>
          </tr>
          <tr>
            <td><div style="cursor:default;">Y:</div></td>
            <td><div id="y-stretch" title="Y stretch">↕</div></td>
            <td><div id="y-x2" title="Space pitches out 2x">x2</div></td>
            <td><div id="y-/2" title="Compress pitches by 2x">/2</div></td>
            <td><div id="y-flip" title="Reverse pitch">Flip</div></td>
            <td><div id="y-translate" title="Y translate">⇅</div></td>
            <td><div id="y-quantize" title="Y Quantize" style="display: flex; align-items: center; justify-content: center;">
              <svg width="26" height="26" viewBox="0 0 22 22" xmlns="http://www.w3.org/2000/svg">
                <rect x="1"  y="1" width="20"  height="5" fill="none" stroke="white" stroke-width="2"/>
                <rect x="1"  y="6" width="20"  height="5" fill="none" stroke="white" stroke-width="2"/>
                <rect x="1" y="11" width="20"  height="5" fill="none" stroke="white" stroke-width="2"/>
                <rect x="1" y="16" width="20"  height="5" fill="none" stroke="white" stroke-width="2"/>
              </svg>
            </div></td>
          </tr>
        </tbody>
      </table>
    </div>
    <div id="d2" style="display:none;">
      <h3 style="margin:6px 0 10px 0;">Sprites</h3>
      <div id="spriteTableWrap">
        <table id="spriteTable" role="grid" aria-label="Sprites table">
          <thead>
            <tr>
              <th style="width:55%;">Name</th>
              <th style="width:15%;">Enabled</th>
              <th style="width:30%;">Effect</th>
            </tr>
          </thead>
          <tbody id="spriteTableBody">
            <!-- rows inserted dynamically -->
          </tbody>
        </table>
      </div>
      <div id="spriteEditor" disabled>
        <div class="spriteEditorRow" style="gap: 12px;align-items: center;height:3rem;">
          <button id="moveSpriteBtn" class="leftBtn">Move Sprite</button>
          <button id="deleteSpriteBtn" class="leftBtn" style="color:Red;">Delete Sprite</button>
        </div>
        <div class="slider-row"><label for="spriteName">Name:</label><input type="text" id="spriteName" value="No sprite selected"></input></div>
        <div class="slider-row"><label for="spriteEnabled">Enabled:</label><input type="checkbox" id="spriteEnabled"></input></div>
        <div class="slider-row"><label for="spriteEffect">Effect:</label><select id="spriteEffect">
          <option value="color">Color</option>
          <option value="blur">Blur</option>
          <option value="eraser">Eraser</option>
          <option value="amplifier">Amplify</option>
          <option value="noiseRemover">Noise Remover</option>
        </select></div>
        <div class="slider-row" id="spriteLayerDiv" style="display:none;"><label for="spriteLayer">Channel:</label><select id="spriteLayer">
          <option value="0">0</option>
          <option value="all">All</option>
        </select></div>
        <div id="spriteEffectSettings">
          <h3>
            Effect settings
            <button type="button"
                    class="section-toggle"
                    data-target="spriteEffectSettings"
                    aria-expanded="false"
                    aria-label="Toggle Effect settings"
                    id="effectSettingsToggleBtn"></button>
          </h3>
          <div class="slider-row" title="Brightness" id="sbrushBrightnessDiv">
              <label class="h2">Brush Brightness</label>
              <input id="sbrushBrightness" type="range" min="0" max="255" value="255">
              <input id="sbrushBrightnessInput" type="number" value="255" min="0" max="255">
          </div>
          <div class="slider-row" title="Blur Radius" id="sblurRadiusDiv">
              <label class="h2">Blur Radius</label>
              <input id="sblurRadius"  type="range" min="0" max="10" value="1.5" step="0.1">
              <input id="sblurRadiusInput" type="number" value="1.5" min="0" max="10">
          </div>
          <div class="slider-row" title="Blur Radius" id="samplifyDiv">
              <label class="h2">Amplifier</label>
              <input id="samp"  type="range" min="0" max="2" value="2" step="0.01">
              <input id="sampInput" type="number" value="2" min="0" max="2">
          </div>
          <div class="slider-row" title="Remove noise below this threshold" id="snoiseFloorDiv">
              <label class="h2">Noise Threshold (dB)</label>
              <input id="snoiseRemoveFloor"  type="range" min="-60" max="0" value="-10" step="0.1">
              <input id="snoiseRemoveFloorInput" type="number" value="-10" min="-60" max="0">
          </div>
          <div id="sev" class="slider-row" title="Phase texture">
            <label class="h2" for="sphaseTexture">Phase texture</label>
            <select id="sphaseTexture">
              <option value="Harmonics">Harmonics</option>
              <option value="Static">Static</option>
              <option value="Flat">Flat</option>
            </select>
          </div>
          <div class="slider-row" title="Phase" id="sphaseDiv">
              <label class="h2">Phase shift</label>
              <input id="sphaseShift"  type="range" min="0" max="6.283" value="0" step="0.0001">
              <input id="sphaseShiftInput" type="number" value="0" min="0" max="6.283">
          </div>
          <div class="slider-row" title="Brightness strength" id="sbrushOpacityDiv">
              <label class="h2">Opacity</label>
              <input id="sbrushOpacity"  type="range" min="0" max="1" value="1" step="0.01">
              <input id="sbrushOpacityInput" type="number" value="1" min="0" max="1">
          </div>
          <div class="slider-row" title="Phase strength" id="sphaseStrengthDiv">
              <label class="h2">Phase Strength</label>
              <input id="sphaseStrength"  type="range" min="0" max="1" value="0" step="0.01">
              <input id="sphaseStrengthInput" type="number" value="0" min="0" max="1">
          </div>
        </div>
        <div id="spriteFadeDiv">
          <h3>
            Fade
            <button type="button"
                    class="section-toggle"
                    data-target="spriteFadeDiv"
                    aria-expanded="true"
                    aria-label="Toggle Fade"></button>
          </h3>
          <canvas id="spriteFadeCanvas" style="border:1px solid #ccc; display:block; margin-top:10px;width:100%;"></canvas>
        </div>
      </div>
    </div>
    <div id="d3" style="display:none;">
      <h2 style="margin-bottom:10px;margin-top:10px;">Samples</h2>
      <!-- Upload / Drop box -->
      <div id="samples-upload" style="margin: 6px 0 12px 0;">
        <label class="upload-box" for="samplesUpload">
          <div class="upload-inner" style="border: 3px dotted white; cursor:pointer;border-radius:5px;background:#222;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:20px;">
            <svg viewBox="0 0 24 24" aria-hidden="true" width="48" height="48" style="margin-bottom:10px;">
              <path d="M12,3 v10 m0,-10 l-4,4 m4,-4 l4,4 M4,20 h16" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <div style="font-size:13px;">Drop files here or click to upload</div>
          </div>
        </label>
        <input id="samplesUpload" type="file" multiple accept="audio/*,image/*" style="display:none;">
      </div>

      <!-- Collapsible sections use same format as #spriteEffectSettings h3 -->
      <section class="sample-section">
        <div class="section-content" id="uploadsSection">
          <h3>
            Uploads
            <button type="button"
                    class="section-toggle"
                    data-target="uploadsSection"
                    aria-expanded="false"
                    aria-label="Toggle uploads">
            </button>
          </h3>
          <div id="uploadsWrapper"></div>
        </div>
      </section>

      <section class="sample-section">
        <div class="section-content" id="layersSection">
          <h3>
            Layers
            <button type="button"
                    class="section-toggle"
                    data-target="layersSection"
                    aria-expanded="true"
                    aria-label="Toggle layers">
            </button>
          </h3>
          <div id="layersSampleWrapper"></div>
        </div>
      </section>

      <section class="sample-section">
        <div class="section-content" id="imagesSection">
          <h3>
            Images
            <button type="button"
                    class="section-toggle"
                    data-target="imagesSection"
                    aria-expanded="true"
                    aria-label="Toggle images">
            </button>
          </h3>
          <div class="image-gallery" id="imageGallery" role="list" aria-label="Images gallery">
          </div>
        </div>
      </section>
    </div>
    <div id="d4" style="display:none;">
      <h2 style="margin-bottom:10px;margin-top:10px;">Piano</h2>
      <label class="h1">Brush Alignment</label>
      <!--Auto align pitch-->
      <button class="leftBtn" id="alignPitch" title="Auto align pitch (j)">Auto Align Pitch</button>
      <div id="pitchAlignDiv" style="display:none;">
        <div class="slider-row" title="Base Pitch">
          <label class="h2">Base Hz</label>
          <input id="startOnPitch" type="range" min="261.63" max="523.3" step="0.01" value="440">
          <input id="startOnPitchInput" type="number" value="440">
        </div>
        <!--Notes per octave (achieve with pitch bends)-->
        <div class="slider-row" title="Notes Per Octave">
          <label class="h2">Notes per octave</label>
          <input id="npo" type="range" min="1" max="48" step="1" value="12">
          <input id="npoInput" type="number" value="12" min="1" max="384">
        </div>
      </div>
      <!--Auto align time-->
      <button class="leftBtn" id="alignTime" title="Auto align time (k)">Auto Align Time</button>
      <div id ="timeAlignDiv" class="slider-row" title="BPM" style="display:none;">
        <label class="h2">BPM</label>
        <input id="bpm" type="range" min="0.001" max="500" step="0.01" value="120">
        <input id="bpmInput" type="number" value="120" min="0.001" max="5000">
      </div>
      <!--Remove harmonics button-->
      <button class="leftBtn" id="removeHarmonicsBtn" title="Auto Remove Harmonics" onClick="removeHarmonics()">Remove Harmonics</button>
      <label class="h1">MIDI Export</label>
      <input type="checkbox" id="useMidiAI" title="Use AI model (Ideal for songs)">Use BasicPitch AI</input>
      <div class="slider-row" title="Duration cutoff">
        <label class="h2">Duration cutoff (secs)</label>
        <input id="durationCutoff" type="range" min="0" max="1" step="0.001" value="0.05">
        <input id="durationCutoffInput" type="number" value="0.05" min="0" max="1">
      </div>
      <div id="nonAiMidiDiv">
        <!--Noise floor cutoff-->
        <div class="slider-row" title="Noise floor cutoff">
          <label class="h2">Noise floor (dB)</label>
          <input id="noiseFloorCutoff" type="range" min="-50" max="0" step="0.1" value="-30">
          <input id="noiseFloorCutoffInput" type="number" value="-30" min="-50" max="0">
        </div>
        <input type="checkbox" id="midiAlignTime" title="Midi export time filter" checked>Align to tempo</input>
        <div id="matOptions">
          <div id ="miditimeAlignDiv" class="slider-row" title="Note BPM">
            <label class="h2">BPM</label>
            <input id="midiBpm" type="range" min="0.001" max="500" step="0.01" value="120">
            <input id="midiBpmInput" type="number" value="120" min="0.001" max="5000">
          </div>
          <div id ="subBeatDiv" class="slider-row" title="Sub beats">
            <label class="h2">Sub beats</label>
            <input id="subBeat" type="range" min="1" max="24" step="1" value="8">
            <input id="subBeatInput" type="number" value="8" min="1" max="24">
          </div>
        </div>
        <button class="leftBtn" title="Use volume controllers (Not recommended)" id="useVolumeControllers">Use Volume Controllers</button>
      </div>
      <div id="AiMidiDiv" style="display:none;">
        <label class="h1">Time Quantize</label>
        <div class="slider-row" title="Time quantize strength">
          <label class="h2">Strength</label>
          <input id="tQs" type="range" min="0" max="100" step="1" value="0">
          <input id="tQsInput" type="number" value="0" min="0" max="100">
        </div>
        <div class="slider-row" title="Time quantize strength">
          <label class="h2">Tempo</label>
          <input id="tQt" type="range" min="1" max="300" step="1" value="120">
          <input id="tQtInput" type="number" value="120" min="1" max="300">
        </div>
        <div class="slider-row" title="Phase texture">
          <label class="h2" for="tQd">Time division</label>
          <select id="tQd">
            <option value="1">1/1</option>
            <option value="2">1/2</option>
            <option value="3">1/3</option>
            <option value="4">1/4</option>
            <option value="5">1/5</option>
            <option value="6">1/6</option>
            <option value="7">1/7</option>
            <option value="8" selected="selected">1/8</option>
            <option value="12">1/12</option>
            <option value="16">1/16</option>
            <option value="24">1/24</option>
            <option value="32">1/32</option>
          </select>
        </div>
      </div>
      <!--Export button-->
      <button class="leftBtn" id="exportMIDI" title="Export Midi (ctrl + m)" onclick="exportMidi()">Export MIDI</button>
    </div>
    <div id="d5" style="display:none; height: 80%">
      <h2 style="margin-bottom:10px;margin-top:10px;">Equalizer</h2>
      <h5 style="margin-top:0px; margin-bottom:10px;">Note: Does not update on the spectrogram to save lag</h5>
      <div class="slider-row" title="Global gain">
        <label class="h2">Global gain</label>
        <input id="globalGain" type="range" min="-30" max="30" step="0.1" value="0">
        <input id="globalGainInput" type="number" value="0" min="-30" max="30">
      </div>
      <div class="slider-row" title="EQ Presets">
        <label class="h2" for="eqPresets">Presets</label>
        <select id="eqPresets">
          <option value="Flat">Flat</option>
          <option value="Bass boost">Bass boost</option>
          <option value="Lowpass">Lowpass</option>
          <option value="Mid boost">Mid boost</option>
          <option value="Midpass">Midpass</option>
          <option value="High boost">High boost</option>
          <option value="Highpass">Highpass</option>
          <option value="Custom">Custom</option>
        </select>
      </div>
      <canvas id="eqCanvas" width="300" height="440" style="border:1px solid #ccc; display:block; margin-top:10px;"></canvas>
    </div>
    <div id="d6" style="display:none;">
      <h2 style="margin-bottom:10px;margin-top:10px;">Layers</h2>
      <div class="slider-row" title="Layer Display Height" id="chdiv">
        <label class="h2">Layer height</label>
        <input id="layerHeight" type="range" min="0" max="500" step="1" value="500">
        <input id="layerHeightInput" type="number" value="500" min="0" max="500">
      </div>
      <div class="slider-row" title="Sync actions to all layers">
          <label class="h2">Sync layers</label>
          <input id="syncLayers" type="checkbox">
      </div>
      <div id="layersMixerDiv" class="layerWrapper">
        <div style="display:flex;gap:10px;margin-top:5px;">
          <b>Layer 0</b>
          <input id="layerEnable-0" type="checkbox" checked aria-label="Enable layer 0">
          <label class="h2" style="margin-left:60px;" id="speakerLabel0">Speaker</label>
          <select id="audioDevices-0" class="layer-audio-devices" aria-label="Audio device for layer 0">
            <option value="both">Both</option>
          </select>
        </div>
        <div id="chsliders0">
          <div class="slider-row" title="Layer Volume">
            <label class="h2">Volume</label>
            <input id="layerVolume-0" type="range" min="0" max="1.25" step="0.01" value="1">
            <input id="layerVolumeInput-0" type="number" value="1" min="0" max="1.25" step="0.01">
          </div>
          <div class="slider-row" title="Layer Brush Pressure">
            <label class="h2">Brush Pressure</label>
            <input id="layerBrushPressure-0" type="range" min="0" max="1" step="0.01" value="1">
            <input id="layerBrushPressureInput-0" type="number" value="1" min="0" max="1" step="0.01">
          </div>
        </div>
      </div>
    </div>
  </aside>
  <div id="proOverlay" class="left-panel" style="
      display:none !important;
      background:rgba(0,0,0,0.5);
      color:white;
      z-index:10000;
      flex-direction:column !important;
      justify-content:center !important;
      align-items:center !important;
      text-align:center !important;
      height:100%;
  ">
    <h2>Pro Feature</h2>
    <p>This feature is available for Pro users only.</p>
    <button class="leftBtn" style="width:250px;height:50px;font-size:1rem;box-shadow: 0 0 8px #fff"><a href="https://spectrodraw.com/buy-pro/" style="color:black;text-decoration: none;">Get Pro for free, forever with the Early Access Deal!</a></button>
  </div>

  <main class="main-area">
    <div id="canvasWrapper" style="position:absolute; width:100%;">
      <canvas id="timeline" style="height:40px; background:#222; position: absolute;left:40px;z-index: 9998; top:0px"></canvas>
      <canvas id="canvas" style="cursor:crosshair; position: absolute; left: 40px; top:40px"></canvas>
      <canvas id="overlay" style="background: transparent; position:absolute; left:40px; pointer-events:none; z-index:10; top:40px"></canvas>
      <canvas id="freq" style="width:40px; background:#222; position:absolute; left:0; ; top:40px"></canvas>
      <canvas id="logscale" width=40 height = 40 style="position:absolute; top:0px; background: #111;z-index: 999; top:0px"></canvas>
    </div>
  </main>
</div>

<div id="status" style="position:absolute;bottom:0px;"></div>

<script>
  function syncNumberAndRange(numberInput, rangeInput) {
    numberInput.addEventListener('input', () => {
      let val = parseInt(numberInput.value);
      if (val < rangeInput.min) val = rangeInput.min;
      if (val > rangeInput.max) val = rangeInput.max;
      rangeInput.value = val;
      numberInput.value = val; 
    });

    rangeInput.addEventListener('input', () => {
      numberInput.value = rangeInput.value;
    });
  }

  const sliders = [
    [document.getElementById('emptyAudioLength'), document.getElementById('emptyAudioLengthInput'),true],
    [document.getElementById('brushSize'), document.getElementById('brushSizeInput')],
    [document.getElementById('brushBrightness'), document.getElementById('brushBrightnessInput')],
    [document.getElementById('phaseShift'), document.getElementById('phaseShiftInput')],
    [document.getElementById('brushOpacity'), document.getElementById('brushOpacityInput')],
    [document.getElementById('phaseStrength'), document.getElementById('phaseStrengthInput')],
    [document.getElementById('npo'), document.getElementById('npoInput')],
    [document.getElementById('noiseFloorCutoff'), document.getElementById('noiseFloorCutoffInput'), true],
    [document.getElementById('bpm'), document.getElementById('bpmInput')],
    [document.getElementById('startOnPitch'), document.getElementById('startOnPitchInput'), true],
    [document.getElementById('durationCutoff'), document.getElementById('durationCutoffInput'), true],
    [document.getElementById('globalGain'), document.getElementById('globalGainInput'), true],
    [document.getElementById('midiBpm'), document.getElementById('midiBpmInput'), true],
    [document.getElementById('subBeat'), document.getElementById('subBeatInput'), true],
    [document.getElementById('tQs'), document.getElementById('tQsInput'), true],
    [document.getElementById('tQt'), document.getElementById('tQtInput'), true],
    [document.getElementById('blurRadius'), document.getElementById('blurRadiusInput')],
    [document.getElementById('amp'), document.getElementById('ampInput')],
    [document.getElementById('noiseRemoveFloor'), document.getElementById('noiseRemoveFloorInput'),true],
    [document.getElementById('phaseSettings'), document.getElementById('phaseSettingsInput')],
    [document.getElementById('drawVolume'), document.getElementById('drawVolumeInput')],
    [document.getElementById('playbackVolume'), document.getElementById('playbackVolumeInput')],
    [document.getElementById('masterVolume'), document.getElementById('masterVolumeInput')],
    [document.getElementById('softness'), document.getElementById('softnessInput')],
  ];
  sliders.forEach(pair => {if (!pair[2]) syncNumberAndRange(pair[1], pair[0])});
</script>
<script src="fft.js"></script>
<script>

const fileEl=document.getElementById("file");
const canvas=document.getElementById("canvas");
const ctx=canvas.getContext("2d");
const overlayCanvas = document.getElementById("overlay");
const overlayCtx = overlayCanvas.getContext("2d");
const status=document.getElementById("status");
const fftSizeEl=document.getElementById("fftSize");
const hopSizeEl=document.getElementById("hopSize");
const brushSizeEl=document.getElementById("brushSize");
const brushOpacityEl=document.getElementById("brushOpacity");
const phaseStrengthEl=document.getElementById("phaseStrength");
const brushBrightnessEl=document.getElementById("brushBrightness");
const blurRadiusEl=document.getElementById("blurRadius");
const ampEl=document.getElementById("amp");
const noiseRemoveFloorEl=document.getElementById("noiseRemoveFloor");
const phaseShiftEl=document.getElementById("phaseShift");
const logscaleEl = document.getElementById("logscale");
const emptyAudioLengthEl = document.getElementById("emptyAudioLength");
const phaseTextureEl = document.getElementById("phaseTexture");
const recordBtn = document.getElementById("rec");
const preset = document.getElementById("presets");
const es = document.getElementById("es");
const ev = document.getElementById("ev");
const yAxis=document.getElementById("freq");
const yctx=yAxis.getContext("2d");
const yAxisMode=document.getElementById("yAxisMode");
const info = document.getElementById("mouseInfo");
const alignPitchBtn = document.getElementById("alignPitch");
const pitchAlignDiv = document.getElementById("pitchAlignDiv");
const alignTimeBtn = document.getElementById("alignTime");
const timeAlignDiv = document.getElementById("timeAlignDiv");
const midiAlignTimeBtn = document.getElementById("midiAlignTime");
const useAIEl = document.getElementById("useMidiAI");
const nonAIMidiOptions = document.getElementById("nonAiMidiDiv");
const matOptions = document.getElementById("matOptions");
const miditimeAlignDiv = document.getElementById("miditimeAlignDiv");
const subBeatDiv = document.getElementById("subBeatDiv");
const AIMidiOptions = document.getElementById("AiMidiDiv");
const tQs = document.getElementById("tQs");
const tQt = document.getElementById("tQt");
const tQd = document.getElementById("tQd");
const WORKLET_CODE = `
class RecorderProcessor extends AudioWorkletProcessor {
  process(inputs) {
    const input = inputs[0];
    if (input && input[0] && input[0].length > 0) {
      const chunk = new Float32Array(input[0].length);
      chunk.set(input[0]);

      this.port.postMessage(chunk, [chunk.buffer]);
    }
    return true;
  }
}
registerProcessor('recorder-processor', RecorderProcessor);
`;
const micHTML = `
<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="2 5 19 19" fill="none" stroke="#333" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
  <path d="M8 15a4 4 0 0 0 8 0" />
  <rect x="10" y="7" width="4" height="8" rx="2" ry="2" fill="black"/>
  <line x1="12" y1="18" x2="12" y2="17"/>
  <line x1="9" y1="21" x2="15" y2="21"/>
</svg>`;
const recHTML = `
<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="red">
  <circle cx="12" cy="12" r="8" />
</svg>`;
const lockHTML = `<svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true" focusable="false">
  <path d="M8 10a4 4 0 0 1 8 0" fill="none" stroke="white" stroke-width="2"/>
  <rect x="6" y="10" width="12" height="10" fill="white"/>
</svg>`;
const unlockHTML = `<svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true" focusable="false">
  <path d="M0 10a4 4 0 0 1 8 0" fill="none" stroke="white" stroke-width="2"/>
  <rect x="6" y="10" width="12" height="10" fill="white"/>
</svg>`;
const toolButtons = document.querySelectorAll(".tool-btn");
const shapeButtons = document.querySelectorAll(".shape-btn");
const panelButtons = document.querySelectorAll(".panel-btn");
const trueScale = document.getElementById("trueScale");
const overlayFile = document.getElementById("overlayFile");
const uvcb = document.getElementById("useVolumeControllers");
const EQcanvas = document.getElementById("eqCanvas");
const eCtx = EQcanvas.getContext("2d"); 
const eqPresets = document.getElementById("eqPresets");
const lockHopBtn = document.getElementById("lockHopBtn");

const historyStack = []; const redoStack = [];
const MAX_HISTORY_ENTRIES = 80;

let pcm=null, sampleRate=48000, pos=0, fftSize=1024, hop=512, win=hann(1024);
let framesTotal=0, x=0, rendering=false;
let imageBuffer=null;
let visited = null;
let currentCursorX = 0;
let iLow = null;
let iHigh = null;
let fLow = null;
let fHigh = null;
let specCanvas = document.createElement("canvas");
let specCtx = specCanvas.getContext("2d");
let logScaleVal = 1.12;

let mags = null;     
let phases = null;   
let specWidth = 0;
let specHeight = 0;
let pcmChunks = null;
let trueScaleVal=false;
let overlayImage = null;
let useHz = false;
let autoPlayOnFinish = true;
let alignPitch=false;let alignTime=false;midiAlignTime=true;useMidiAI=false;
let subBeat = 1;mSubBeat=16;midiBpm=120;
let tQTempo=120;tQStrength=0;
let useVolumeControllers = false;

let startX = null, startY = null;
let cx_ = null, cy_ = null;
let zooming = false;

let brushSize=parseInt(brushSizeEl.value);
let brushOpacity=parseInt(brushOpacityEl.value)/100;
let phaseStrength=parseInt(phaseStrengthEl.value)/100;
let brushBrightness=parseInt(brushBrightnessEl.value);
let blurRadius=parseInt(blurRadiusEl.value);
let amp=parseInt(ampEl.value);
let noiseRemoveFloor = parseInt(noiseRemoveFloorEl.value);
let phaseShift=parseInt(phaseShiftEl.value)/10000;
let currentTool = "color";
let currentShape = "brush";
let currentPanel = "1";
let bpm = 120; let npo = 12;
let noiseFloor = document.getElementById("noiseFloorCutoff").value; let startOnP = 440;
let dCutoff = document.getElementById("durationCutoff").value;
let globalGain = 0;
let playingTutorial = false;
let currentFrame = 0;
let lockHop = false;
let t0 = 0, tau = 1.0, sigma = 0.3, harmonicCenter = 8, userDelta = 0, refPhaseFrame = 0, chirpRate=0.0005;
let softness = 0, mouseVelocity=0;
sliders[0][0].addEventListener('input', () =>{sliders[0][1].value = sliders[0][0].value;});
sliders[0][1].addEventListener('keydown', (e) => {
  if (e.key === 'Enter') {
    let val = parseFloat(sliders[0][1].value);
    const min = parseFloat(sliders[0][0].min);
    const max = parseFloat(sliders[0][0].max);
    if (isNaN(val)) val = 0;      
    if (val < min) val = min;
    if (val > max) val = max;
    sliders[0][1].value = val;      
    sliders[0][0].value = val;
    initEmptyPCM();
  }
});
sliders[1][0].addEventListener("input", ()=>{brushSize   =parseInt  (sliders[1][0].value); updateBrushPreview();});
sliders[1][1].addEventListener("input", ()=>{brushSize   =parseInt  (sliders[1][1].value); updateBrushPreview();});
sliders[2][0].addEventListener("input", ()=>{brushBrightness  =parseInt  (sliders[2][0].value); updateBrushPreview();});
sliders[2][1].addEventListener("input", ()=>{brushBrightness  =parseInt  (sliders[2][1].value); updateBrushPreview();});
sliders[3][0].addEventListener("input", ()=>{phaseShift    =parseFloat(sliders[3][0].value); updateBrushPreview();});
sliders[3][1].addEventListener("input", ()=>{phaseShift    =parseFloat(sliders[3][1].value); updateBrushPreview();});
sliders[4][0].addEventListener("input", ()=>{brushOpacity=parseInt  (sliders[4][0].value)/100; updateBrushPreview();});
sliders[4][1].addEventListener("input", ()=>{brushOpacity=parseInt  (sliders[4][1].value)/100; updateBrushPreview();});
sliders[5][0].addEventListener("input", ()=>{phaseStrength=parseInt  (sliders[5][0].value)/100; updateBrushPreview();});
sliders[5][1].addEventListener("input", ()=>{phaseStrength=parseInt  (sliders[5][1].value)/100; updateBrushPreview();});
sliders[6][0].addEventListener("input", ()=>{npo         =parseInt  (sliders[6][0].value);});
sliders[6][1].addEventListener("input", ()=>{if (!isNaN(sliders[6][1].value)) npo=parseInt  (sliders[6][1].value);});
sliders[7][0].addEventListener('input', () =>{noiseFloor=parseFloat(sliders[7][0].value); sliders[7][1].value = noiseFloor;});
sliders[7][1].addEventListener('keydown', (e) => {if (e.key === 'Enter') {let val = parseFloat(sliders[7][1].value);const min = parseFloat(sliders[7][0].min);const max = parseFloat(sliders[7][0].max);
    if (isNaN(val)) val = noiseFloor;      if (val < min) val = min;if (val > max) val = max;sliders[7][1].value = val;sliders[7][0].value = val;noiseFloor = val;}});
sliders[8][0].addEventListener("input", ()=>{bpm         =parseFloat(sliders[8][0].value);drawCursor(true);});
sliders[8][1].addEventListener("input", ()=>{bpm         =parseFloat(sliders[8][1].value);drawCursor(true);});
sliders[9][0].addEventListener('input', () => {startOnP = parseFloat(sliders[9][0].value); sliders[9][1].value = startOnP;});
sliders[9][1].addEventListener('keydown', (e) => {if (e.key === 'Enter') {let val = parseFloat(sliders[9][1].value);const min = parseFloat(sliders[9][0].min);const max = parseFloat(sliders[9][0].max);
    if (isNaN(val)) val = startOnP;if (val < min) val = min;if (val > max) val = max;sliders[9][1].value = val;sliders[9][0].value = val;startOnP = val;}});
sliders[10][0].addEventListener('input', () => {dCutoff = parseFloat(sliders[10][0].value); sliders[10][1].value = dCutoff;});
sliders[10][1].addEventListener('keydown', (e) => {if (e.key === 'Enter') {let val = parseFloat(sliders[10][1].value);const min = parseFloat(sliders[10][0].min);const max = parseFloat(sliders[10][0].max);
    if (isNaN(val)) val = dCutoff;if (val < min) val = min;if (val > max) val = max;sliders[10][1].value = val;sliders[10][0].value = val;dCutoff = val;}});
sliders[11][0].addEventListener('input', () => {globalGain = parseFloat(sliders[11][0].value); sliders[11][1].value = globalGain; updateEQ();});
sliders[11][1].addEventListener('keydown', (e) => {if (e.key === 'Enter') {let val = parseFloat(sliders[11][1].value);const min = parseFloat(sliders[11][0].min);const max = parseFloat(sliders[11][0].max);
    if (isNaN(val)) val = globalGain;if (val < min) val = min;if (val > max) val = max;sliders[11][1].value = val;sliders[11][0].value = val;globalGain = val;updateEQ();}});
sliders[12][0].addEventListener('input', () => {midiBpm = parseFloat(sliders[12][0].value); sliders[12][1].value = midiBpm;});
sliders[12][1].addEventListener('keydown', (e) => {if (e.key === 'Enter') {let val = parseFloat(sliders[12][1].value);const min = parseFloat(sliders[12][0].min);const max = parseFloat(sliders[12][0].max);
    if (isNaN(val)) val = midiBpm;if (val < min) val = min;if (val > max) val = max;sliders[12][1].value = val;sliders[12][0].value = val;midiBpm = val;}}); 
sliders[13][0].addEventListener('input', () => {mSubBeat = parseFloat(sliders[13][0].value); sliders[13][1].value = mSubBeat;});
sliders[13][1].addEventListener('keydown', (e) => {if (e.key === 'Enter') {let val = parseFloat(sliders[13][1].value);const min = parseFloat(sliders[13][0].min);const max = parseFloat(sliders[13][0].max);
    if (isNaN(val)) val = mSubBeat;if (val < min) val = min;if (val > max) val = max;sliders[13][1].value = val;sliders[13][0].value = val;mSubBeat = val;}});
sliders[14][0].addEventListener('input', () => {tQStrength = parseFloat(sliders[14][0].value); sliders[14][1].value = tQStrength; updateEQ();});
sliders[14][1].addEventListener('keydown', (e) => {if (e.key === 'Enter') {let val = parseFloat(sliders[14][1].value);const min = parseFloat(sliders[14][0].min);const max = parseFloat(sliders[14][0].max);
    if (isNaN(val)) val = tQStrength;if (val < min) val = min;if (val > max) val = max;sliders[14][1].value = val;sliders[11][0].value = val;tQStrength = val;}});
sliders[15][0].addEventListener('input', () => {tQTempo = parseFloat(sliders[15][0].value); sliders[15][1].value = tQTempo;});
sliders[15][1].addEventListener('keydown', (e) => {if (e.key === 'Enter') {let val = parseFloat(sliders[15][1].value);const min = parseFloat(sliders[15][0].min);const max = parseFloat(sliders[15][0].max);
    if (isNaN(val)) val = tQTempo;if (val < min) val = min;if (val > max) val = max;sliders[15][1].value = val;sliders[15][0].value = val;tQTempo = val;}});
sliders[16][0].addEventListener("input", ()=>{blurRadius  =parseInt  (sliders[16][0].value); updateBrushPreview();});
sliders[16][1].addEventListener("input", ()=>{blurRadius  =parseInt  (sliders[16][1].value); updateBrushPreview();});
sliders[17][0].addEventListener("input", ()=>{amp  =  (sliders[17][0].value); updateBrushPreview();});
sliders[17][1].addEventListener("input", ()=>{amp  =  (sliders[17][1].value); updateBrushPreview();});
sliders[18][0].addEventListener('input', () => {noiseRemoveFloor = parseFloat(sliders[18][0].value); sliders[18][1].value = noiseRemoveFloor;updateBrushPreview();});
sliders[18][1].addEventListener('keydown', (e) => {if (e.key === 'Enter') {let val = parseFloat(sliders[18][1].value);const min = parseFloat(sliders[18][0].min);const max = parseFloat(sliders[18][0].max);
    if (isNaN(val)) val = noiseRemoveFloor;if (val < min) val = min;if (val > max) val = max;sliders[18][1].value = val;sliders[18][0].value = val;noiseRemoveFloor = val;updateBrushPreview();}});
sliders[23][0].addEventListener("input", ()=>{softness  =  (sliders[23][0].value); updateBrushPreview();});
sliders[23][1].addEventListener("input", ()=>{softness  =  (sliders[23][1].value); updateBrushPreview();});
function onPhaseSettingsChange(idx) {
  const v = sliders[19][idx].valueAsNumber;
  switch (phaseTextureEl.value) {
    case "ImpulseAlign":      t0 = v; break;
    case "LinearDelay":       tau = v; break;
    case "RandomSmall":       sigma = v; break;
    case "HarmonicStack":     harmonicCenter = v; break;
    case "CopyFromRef":       refPhaseFrame = v; break;
    case "PhasePropagate":    userDelta = v; break;
    case "Chirp":             chirpRate = v; break;
  }
  updateBrushPreview();
}
sliders[19][0].addEventListener("input", ()=>{onPhaseSettingsChange(0);});
sliders[19][1].addEventListener("input", ()=>{onPhaseSettingsChange(1);});
recordBtn.innerHTML = micHTML;
lockHopBtn.innerHTML = unlockHTML;
function updatePhaseTextureSettings(){
  const t = document.getElementById("phaseSettings");
  const u = document.getElementById("phaseSettingsInput");
  const div = document.getElementById("phaseSettingsDiv");
  div.style.display = "none";
  function c(v) {return phaseTextureEl.value === v}
  function d(variable,min,max,step,label) {
    t.min = min; t.max = max; t.step = step; t.value = variable;
    u.min = min; u.max = max; u.value = variable;
    document.getElementById("phaseSettingsLabel").innerText = label;
    div.style.display = "flex";
  }
       if (c("ImpulseAlign")) d(t0,0,pcm.length/sampleRate,0.001,"t0");
  else if (c("LinearDelay")) d(tau,0,10,0.01,"tau");
  else if (c("RandomSmall")) d(sigma,0,1,0.01,"sigma");
  else if (c("HarmonicStack")) d(harmonicCenter,0,128,0.01,"Harmonic Center");
  else if (c("PhasePropagate")) d(userDelta,0,1,0.01,"Delta");
  else if (c("CopyFromRef")) d(refPhaseFrame,0,framesTotal,1,"Reference Frame");
  else if (c("Chirp")) d(chirpRate,0,0.1,0.0001,"Chirp Rate");
}
phaseTextureEl.addEventListener("input",()=>{
  updatePhaseTextureSettings();
  updateBrushPreview();
});

function angleDiff(a, b) {
  const d = a - b;
  return Math.atan2(Math.sin(d), Math.cos(d));
}
function pushHistory(entry, clearRedo = true) {
  while (historyStack.length >= MAX_HISTORY_ENTRIES) historyStack.shift();
  historyStack.push(entry);
  if (clearRedo) redoStack.length = 0;
}
const g_useMagsEl = document.getElementById("globalUseMagsCheckbox");
const g_usePhasesEl = document.getElementById("globalUsePhasesCheckbox");
let g_useMags = true, g_usePhases = true;
g_useMagsEl.addEventListener("click",()=>{g_useMags = !g_useMags; g_useMagsEl.style.background=g_useMags?"#4af":"var(--accent-gradient)";})
g_usePhasesEl.addEventListener("click",()=>{g_usePhases = !g_usePhases; g_usePhasesEl.style.background=g_usePhases?"#4af":"var(--accent-gradient)";})
panelButtons.forEach(btn => {
  if(btn.dataset.tool === currentPanel) {
    btn.style.background = "#4af"; 
  }
});
panelButtons.forEach(btn => {
  btn.addEventListener("click", () => {
    currentPanel = btn.dataset.tool;
    panelButtons.forEach(b => b.style.background = "");
    btn.style.background = "#4af";
    for (let i = 1; i < 7; i++){
      document.getElementById("d"+i).style.display = (parseInt(currentPanel) === i) ? "block" : "none";
    }
    if (hasPro) {
      document.getElementById("proOverlay").innerHTML = `
      <h2>Pro Feature</h2>
      <p>Thanks for claiming Pro! This feature will unlock for you in</p>
      <p id="proOverlaycountdown" style="color:#9333ea;text-shadow: 0 0 20px rgba(250, 102, 234, 0.5);"></p>
      <button class="leftBtn" style="width:250px;height:50px;font-size:1rem;box-shadow: 0 0 8px #fff"><a href="https://spectrodraw.com/faq/pro-features/" style="color:black;text-decoration: none;">View Pro Features</a></button>
      `;
      const targetDate = new Date("February 15, 2026 00:00:00").getTime();
      const content = document.getElementById("proOverlaycountdown");
      function updateCountdown() {
        const now = Date.now();
        let diff = targetDate - now;
        const days = Math.floor(diff / (1000 * 60 * 60 * 24));
        diff %= 1000 * 60 * 60 * 24;
        const hours = Math.floor(diff / (1000 * 60 * 60));
        diff %= 1000 * 60 * 60;
        const minutes = Math.floor(diff / (1000 * 60));
        diff %= 1000 * 60;
        const seconds = Math.floor(diff / 1000);
        content.innerHTML = `${days}d ${hours}h ${minutes}m ${seconds}s`;
      }
      updateCountdown();
      const timer = setInterval(updateCountdown, 1000);
    }
    document.getElementById("proOverlay").style.display = (currentPanel == "2" || currentPanel == "3" || currentPanel == "6" || currentPanel == "7")?(window.innerWidth<=700?"block":"flex"):"none";
    if (currentPanel === "5") drawEQ();
  });
});
toolButtons.forEach(btn => {
  if(btn.dataset.tool === currentTool) {
    btn.style.background = "#4af"; 
  }
});
toolButtons.forEach(btn => {
  btn.addEventListener("click", () => {
    currentTool = btn.dataset.tool;
    toolButtons.forEach(b => b.style.background = "");
    btn.style.background = "#4af"; 
    if (currentTool === "blur") {
      document.getElementById("brushBrightnessDiv").style.display="none";
      document.getElementById("blurRadiusDiv").style.display="flex";
      document.getElementById("amplifyDiv").style.display="none";
      document.getElementById("noiseFloorDiv").style.display="none";
    } else if (currentTool === "amplifier") {
      document.getElementById("brushBrightnessDiv").style.display="none";
      document.getElementById("blurRadiusDiv").style.display="none";
      document.getElementById("amplifyDiv").style.display="flex";
      document.getElementById("noiseFloorDiv").style.display="none";
    } else if (currentTool === "noiseRemover") {
      document.getElementById("brushBrightnessDiv").style.display="none";
      document.getElementById("blurRadiusDiv").style.display="none";
      document.getElementById("amplifyDiv").style.display="none";
      document.getElementById("noiseFloorDiv").style.display="flex";
    } else {
      document.getElementById("brushBrightnessDiv").style.display="flex";
      document.getElementById("blurRadiusDiv").style.display="none";
      document.getElementById("amplifyDiv").style.display="none";
      document.getElementById("noiseFloorDiv").style.display="none";
    }
    if (currentTool === 'noiseRemover') {
      document.getElementById("ev").style.display="none";
      document.getElementById("phaseDiv").style.display="none";
      document.getElementById("phaseStrengthDiv").style.display="none";
    } else {
      document.getElementById("ev").style.display="flex";
      document.getElementById("phaseDiv").style.display="flex";
      document.getElementById("phaseStrengthDiv").style.display="flex";
    }
    document.getElementById("brushSizeDiv").style.display=(currentTool === 'rectangle')?"none":"flex";
    updateBrushPreview();
  });
});
shapeButtons.forEach(btn => {
  if(btn.dataset.shape === currentShape) {
    btn.style.background = "#4af"; 
  }
});
shapeButtons.forEach(btn => {
  btn.addEventListener("click", () => {
    currentShape = btn.dataset.shape;
    shapeButtons.forEach(b => b.style.background = "");
    btn.style.background = "#4af"; 
    if(currentShape === "image") overlayFile.click();
    document.getElementById("brushSizeDiv").style.display=(currentShape === 'rectangle')?"none":"flex";
    updateBrushPreview();
  });
});
uploadBtn.addEventListener("click", () => {
  file.click();
});
function showOrHideMasterVolume(){document.getElementById("masterVolumeDiv").style.display=(window.innerWidth<1400)?"none":"";};
showOrHideMasterVolume();
window.addEventListener("resize",showOrHideMasterVolume);
trueScale.addEventListener("click", () =>  {trueScaleVal = !trueScaleVal; trueScale.style.background = trueScaleVal?"#4af":"var(--accent-gradient)"; restartRender(false);});
yAxisMode.addEventListener("click", () =>  {useHz        = !useHz;        yAxisMode.style.background = useHz       ?"#4af":"var(--accent-gradient)"; drawYAxis();});
uvcb.addEventListener("click",()=>{useVolumeControllers=!useVolumeControllers;uvcb.style.background = useVolumeControllers?"#4af":"var(--accent-gradient)";});
alignPitchBtn.addEventListener("click",()=>{alignPitch=!alignPitch;alignPitchBtn.style.background = alignPitch?"#4af":"var(--accent-gradient)"; pitchAlignDiv.style.display=alignPitch?"block":"none";});
alignTimeBtn.addEventListener("click",()=>{alignTime=!alignTime;alignTimeBtn.style.background = alignTime?"#4af":"var(--accent-gradient)"; timeAlignDiv.style.display=alignTime?"block":"none";drawCursor(true);});
midiAlignTimeBtn.addEventListener("change",()=>{midiAlignTime=midiAlignTimeBtn.checked;midiAlignTimeBtn.style = midiAlignTime?"background:#4af;margin:none;":"background:var(--accent-gradient);margin-bottom:15px;";matOptions.style.display=midiAlignTime?"block":"none";});
useAIEl.addEventListener("change",()=>{useMidiAI=useAIEl.checked;nonAIMidiOptions.style.display=useMidiAI?"none":"block";AIMidiOptions.style.display=!useMidiAI?"none":"block";});
overlayFile.addEventListener("change", e => {
  const f = e.target.files[0];
  if (!f) return;
  const img = new Image();
  img.onload = () => {overlayImage = img; updateBrushPreview();}
  img.src = URL.createObjectURL(f);
});
let ogHSv = hopSizeEl.value;
function toggleLockHop() {
  if (lockHop) {
    lockHopBtn.innerHTML=unlockHTML;
    hopSize.classList.remove("disabled");
    hopSizeEl.value = ogHSv;
    iLow = 0; iHigh = Math.max(1, Math.floor((pcm.length - fftSize) / ogHSv) + 1);
    restartRender();
  } else {
    lockHopBtn.innerHTML=lockHTML;
    hopSize.classList.add("disabled");
    ogHSv = hopSizeEl.value;
    hopSizeEl.value = fftSizeEl.value;
    iLow = 0; iHigh = Math.max(1, Math.floor((pcm.length - fftSize) / fftSizeEl.value) + 1);
    restartRender();
  }
  lockHop = !lockHop;
}
let $x = 0, $y = 0;
document.addEventListener('mousemove', e=>{
  const {cx,cy,scaleX,scaleY} = getCanvasCoords(e,false);
  $x=cx;$y=cy;
  if (pressedN) {
    const realY = visibleToSpecY($y);
    if (sineOsc) {
      setSineFreq(realY);
    }
  }
});

function keyBind(event) {
  if (event.target.tagName === 'INPUT' || event.target.tagName === 'SELECT' || event.target.tagName === 'TEXTAREA') {
    return; 
  }
  const key = event.key.toLowerCase();
  if (key === 'b') {
    document.getElementById("brushBtn").click();
  } else if (key === 'e') {
    document.getElementById("eraserBtn").click();
  } else if (key === 'p') {
    document.getElementById("pianoBtn").click();
  } else if (key === 'g') {
    document.getElementById("settingsBtn").click();
  } else if (key === 'q') {
    document.getElementById("eqBtn").click();
  } else if (key === 'r') {
    document.getElementById("rectBtn").click();
  } else if (key === 'a') {
    document.getElementById("amplifierBtn").click();
  } else if (key === 'u') {
    document.getElementById("blurBtn").click();
  } else if (key === 'i' && !event.shiftKey && !event.ctrlKey && !event.metaKey) {
    document.getElementById("imageBtn").click();
  } else if (key === 'l') {
    document.getElementById("lineBtn").click();
  } else if ((event.ctrlKey || event.metaKey) && key === 'o') {
    event.preventDefault();
    fileEl.click();
  } else if ((event.ctrlKey || event.metaKey) && event.shiftKey && key === 's') {
    event.preventDefault();
    document.getElementById('downloadSpectrogram').click();
  } else if ((event.ctrlKey || event.metaKey) && key === 's') {
    event.preventDefault();
    document.getElementById('downloadWav').click();
  } else if ((event.ctrlKey || event.metaKey) && key === 'm') {
    exportMidi();
  } else if ((event.ctrlKey || event.metaKey) && key === ' ') {
    recordBtn.click();
  } else if (key === 'y' && !event.shiftKey && !event.ctrlKey && !event.metaKey) {
    yAxisMode.click();
  } else if (key === 'j') {
    alignPitchBtn.click();
  } else if (key === 'k') {
    alignTimeBtn.click();
  } else if (key === 'x') {
    document.getElementById("noiseRemoverBtn").click();
  }
}
document.addEventListener("keydown", (e) => {
  const active = document.activeElement;
  if (active && active.matches("input[type=range], .leftBtn")) {
    if (["ArrowLeft","ArrowRight","ArrowUp","ArrowDown","Tab"].includes(e.key)) {
      return; 
    }

    active.blur();
    setTimeout(() => {
      const evt = new KeyboardEvent('keydown', {
        key: e.key,
        code: e.code,
        keyCode: e.keyCode,
        bubbles: true,
        cancelable: true,
        ctrlKey: e.ctrlKey,
        shiftKey: e.shiftKey,
        altKey: e.altKey,
        metaKey: e.metaKey
      });
      document.dispatchEvent(evt);
    }, 0);

    e.preventDefault();
    e.stopPropagation();
  }
});
document.addEventListener('keydown', (event) => {
  keyBind(event);
});
let pressedN=false;
document.addEventListener('keydown', (e)=>{
  if (e.key==='n') {
    pressedN=true;
    if (!sineOsc) {
      const realY = visibleToSpecY($y);
      sineOsc = audioCtx.createOscillator();
      sineOsc.type = "sine";
      sineGain = audioCtx.createGain();
      sineGain.gain.value = 0.2;
      sineOsc.connect(sineGain).connect(audioCtx.destination);
      setSineFreq(realY); 
      sineOsc.start();
    }
  }
});
document.addEventListener('keyup', (e)=>{
  if (e.key==='n'){
    pressedN=false;
    if (sineOsc) {
      sineOsc.stop();
      sineOsc.disconnect();
      sineOsc = null;
      sineGain = null;
    }
  }
});

</script>
<script src="axes.js"></script>
<script src="midi.js"></script>
<script>

function initEmptyPCM() {
    const sampleRateLocal = 48000;
    let duration = emptyAudioLengthEl.value; 
    if (duration  < 0.01) duration = 10;
    const type = phaseTextureEl.value;
    const length = sampleRateLocal * duration; 
    const tinyNoiseAmplitude = 0.0001; 

    const pcmArray = new Float32Array(length);
    for (let i = 0; i < length; i++) {
      pcmArray[i] = (Math.random() * 2 - 1) * tinyNoiseAmplitude;
    }
    pcm = pcmArray;
    sampleRate = sampleRateLocal;

    iLow = null;
    minCol = 0; maxCol = 
    restartRender(false);
}
async function onReset() {
  snapshotMags=new Float32Array(mags);
  snapshotPhases=new Float32Array(phases);
  await initEmptyPCM();
  minCol = 0; maxCol = sampleRate/hop*emptyAudioLengthEl.value;
  newHistory();
}
function drawLogScale() {
  const lctx = logscaleEl.getContext("2d");

  const w = 40, h = 40;
  lctx.clearRect(0, 0, w, h);

  lctx.beginPath();
  const steps = 40;
  for (let i = 0; i <= steps; i++) {
    const x = i / steps;              
    const y = 1-Math.pow(0-(x-1), Math.pow(logScaleVal,2)); 
    const px = x * w;                 
    const py = h - y * h;             
    if (i === 0) lctx.moveTo(px, py);
    else lctx.lineTo(px, py);
  }
  lctx.strokeStyle = "white";
  lctx.lineWidth = 3;
  lctx.stroke();
}
let changingLogScale = false;
function getMouseXY(e,touch) {
  if (touch) {
    return [e.touches[0].clientX, e.touches[0].clientY];
  } else {
    return [e.clientX, e.clientY];
  }
}
logscaleEl.addEventListener("pointerdown", e=> {
  logScaleMouseDown(e,false);
});
logscaleEl.addEventListener("touchstart", e=> {
  logScaleMouseDown(e,true);
});
function logScaleMouseDown(e,touch) {
  if (!e||e.button !== 0) return;
  const rect= logscaleEl.getBoundingClientRect();
  changingLogScale = true;
  [startX, startY] = getMouseXY(e,touch);
  buildBinDisplayLookup();
  renderFullSpectrogramToImage();
  drawLogScale();
}

function logScaleMouseMove(e,touch) {
  logscaleEl.style.cursor = "n-resize";
  if (!changingLogScale) return;
  const rect= logscaleEl.getBoundingClientRect();
  logScaleVal -= (getMouseXY(e,touch)[1] - startY - (getMouseXY(e,touch)[0] - startX))/400;
  if (logScaleVal < 1) logScaleVal = 1;
  if (logScaleVal > 2) logScaleVal = 2;
  [startX, startY] = getMouseXY(e,touch);
  buildBinDisplayLookup();
  renderFullSpectrogramToImage();
  drawLogScale();
  drawYAxis();
}

document.addEventListener("mousemove", e=> {
  logScaleMouseMove(e,false);
});
document.addEventListener("touchmove", e=> {
  logScaleMouseMove(e,true);
});

logscaleEl.addEventListener("mousemove", e=> {
  logscaleEl.title = "Log scale: " + logScaleVal;
});

document.addEventListener("mouseup", e=>{changingLogScale=false;})
document.addEventListener("touchend", e=>{changingLogScale=false;})

emptyAudioLengthEl.addEventListener("input", ()=> {
  initEmptyPCM();
  iLow = 0;
  iHigh = framesTotal;
});

</script>
<script src="recordingAndPresets.js"></script>
<script>
if (lockHop) {hopSizeEl.value = parseInt(fftSizeEl.value);}
fftSizeEl.addEventListener("change",()=>{if (lockHop) {hopSizeEl.value = parseInt(fftSizeEl.value);}restartRender();buildBinDisplayLookup();});
hopSizeEl.addEventListener("change",()=>{restartRender();buildBinDisplayLookup();});

function restartRender(autoPlay, clear=true){
    if(!pcm) return;
    autoPlayOnFinish = !!playing || !!autoPlay;
    fftSize = parseInt(fftSizeEl.value);
    hop = Math.max(1, parseInt(hopSizeEl.value) || Math.floor(fftSize/2));
    win = hann(fftSize);

    framesTotal = Math.max(1, Math.floor((pcm.length - fftSize) / hop) + 1);
    iLow = 0;
    iHigh = framesTotal;
    const freqBins = Math.floor(fftSize / 2);
    canvas.width = framesTotal;
    canvas.height = freqBins;
    let marginHeight = (window.innerWidth<=700)?400:110;
    if (trueScaleVal) {
      const maxHeight = (window.innerHeight - marginHeight);
      const containerWidth = canvas.parentElement.clientWidth;
      const scaleX = containerWidth / framesTotal;
      const scaleY = maxHeight / freqBins;
      const scale = Math.min(scaleX, scaleY, 1);

      canvas.style.width = (canvas.width * scale) + "px";
      canvas.style.height = (canvas.height * scale) + "px";
    } else {
      canvas.style.width = "calc(100% - 40px)";
      let h = window.innerHeight - marginHeight;
      canvas.style.height = h+"px";
    }

    overlayCanvas.style.width = canvas.style.width;
    overlayCanvas.style.height = canvas.style.height;
    yAxis.height = 1024;
    yAxis.style.height = canvas.style.height;
    yAxis.width = 40;
    yAxis.style.height = canvas.style.height;

    specWidth = canvas.width;
    specHeight = canvas.height;

    syncOverlaySize();

    const timeline = document.getElementById('timeline');
    timeline.width = window.innerWidth*1.2;
    timeline.style.width = canvas.style.width;
    timeline.height = 40;

    imageBuffer = new ImageData(canvas.width, canvas.height);
    specWidth = canvas.width;
    specHeight = canvas.height;

    specCanvas.width = specWidth;
    specCanvas.height = specHeight;
    specCtx.clearRect(0, 0, specCanvas.width, specCanvas.height);
    specCtx.putImageData(imageBuffer, 0, 0);

    if (clear) mags = new Float32Array(specWidth * specHeight);
    if (clear) phases = new Float32Array(specWidth * specHeight);
    if (clear) for(let i=0;i<specWidth*specHeight;i++){ mags[i]=0; phases[i]=0; }

    let startFrame = calcMinMaxCol().minCol;
    if (startFrame == Infinity) startFrame = 0;
    pos = startFrame * hop;
    x = startFrame;
    rendering = true;

    ctx.fillStyle = "black";
    ctx.fillRect(0,0,canvas.width,canvas.height);

    startTime = performance.now();
    audioProcessed = 0;

    if (playing) stopSource(true);
    requestAnimationFrame(drawLoop);

    if (!autoPlay) {
        if (typeof drawTimeline === 'function') drawTimeline();
        else console.warn("drawTimeline() not defined yet — will run once axes.js loads");

        if (typeof drawYAxis === 'function') drawYAxis();
        else console.warn("drawYAxis() not defined yet — will run once axes.js loads");

        if (typeof drawLogScale === 'function') drawLogScale();
    }
}

function magPhaseToRGB(mag, phase){
    const hp = ((phase / (2*Math.PI) + 1) % 1)*6; 
    const v = Math.min(mag/60,1);
    const x = v*(1-Math.abs(hp%2-1));
    let r,g,b;
    if     (hp < 1){ r=v; g=x; b=0; }
    else if(hp < 2){ r=x; g=v; b=0; }
    else if(hp < 3){ r=0; g=v; b=x; }
    else if(hp < 4){ r=0; g=x; b=v; }
    else if(hp < 5){ r=x; g=0; b=v; }
    else           { r=v; g=0; b=x; }
    return [Math.floor(r*255), Math.floor(g*255), Math.floor(b*255)];
}

function rgbToMagPhase(r, g, b) {
    let rf=r/255,gf=g/255,bf=b/255;
    const mx=Math.max(rf,gf,bf), mn=Math.min(rf,gf,bf);
    const d=mx-mn;
    let h=0,s=0,v=mx;
    s=mx===0?0:d/mx;
    if(d!==0){
        if(mx===rf) h=((gf-bf)/d)%6;
        else if(mx===gf) h=(bf-rf)/d+2;
        else h=(rf-gf)/d+4;
        h/=6; if(h<0) h+=1;
    }
    const phase=h*2*Math.PI;
    const mag=v*60;
    return [mag, phase];
}

function getLogScaleSlider() { return Math.max(1, parseFloat(logScaleVal) || 1); }

function binToDisplayY(bin, h) {
    if (!h) return 0;
    const s = getLogScaleSlider();
    if (s <= 1.0000001) {
        return Math.round(h - 1 - bin); 
    } else {
        const a = s - 1;
        const denom = Math.log(1 + a * (h - 1));
        if (!isFinite(denom) || denom === 0) return Math.round(h - 1 - bin);
        const t = Math.log(1 + a * bin) / denom; 
        const y = (1 - t) * (h - 1);
        return Math.round(y);
    }
}

function displayYToBin(y, h) {
    if (!h) return 0;
    const s = getLogScaleSlider();
    if (s <= 1.0000001) {
        return Math.max(0, Math.min(h - 1, Math.round(h - 1 - y)));
    } else {
        const a = s - 1;
        const denom = Math.log(1 + a * (h - 1));
        if (!isFinite(denom) || denom === 0) return Math.max(0, Math.min(h - 1, Math.round(h - 1 - y)));
        const t = 1 - (y / (h - 1));
        const raw = (Math.exp(t * denom) - 1) / a;
        const clamped = Math.max(0, Math.min(h - 1, Math.round(raw)));
        return clamped;
    }
}

function drawFrame(w,h) {
    if (pos + fftSize > pcm.length) { rendering = false; status.style.display = "none"; return false; }

    const re = new Float32Array(fftSize);
    const im = new Float32Array(fftSize);
    for (let i = 0; i < fftSize; i++) { re[i] = (pcm[pos + i] || 0) * win[i]; im[i] = 0; }
    fft_inplace(re, im);

    for (let bin = 0; bin < h; bin++) {
        const mag = Math.hypot(re[bin] || 0, im[bin] || 0);
        const phase = Math.atan2(im[bin] || 0, re[bin] || 0);
        const idx = x * h + bin; 
        mags[idx] = mag;
        phases[idx] = phase;
    }

    for (let yy = 0; yy < h; yy+=recording?4:1) {
        const mappedBin = displayYToBin(yy, h);
        const idx = x * h + mappedBin;
        const mag = mags[idx] || 0;
        const phase = phases[idx] || 0;
        const [r, g, b] = magPhaseToRGB(mag, phase);
        for (let i = 0; i < (recording?4:1); i++) {       
          const pix = ((yy+i) * w + x) * 4; 
          imageBuffer.data[pix]     = r;
          imageBuffer.data[pix + 1] = g;
          imageBuffer.data[pix + 2] = b;
          imageBuffer.data[pix + 3] = 255;
        }
    }
    pos += hop; x++;
    audioProcessed += hop;
    if (x >= (maxCol==0?w:maxCol)) {
      rendering = false;
      if (pendingHistory && snapshotMags && snapshotPhases && mags && phases) {
        

        newHistory();

        const lastEntry = historyStack.length ? historyStack[historyStack.length - 1] : null;
        if (!pendingRecomputeDone) {
          if (lastEntry) {
            recomputePCMForCols(lastEntry.minCol, lastEntry.maxCol, { oldMags: snapshotMags, oldPhases: snapshotPhases });
          }
        } else {

          pendingRecomputeDone = false;
          pendingRecomputeMinCol = pendingRecomputeMaxCol = null;
        }

        snapshotMags = null;
        snapshotPhases = null;
      }
      if (pendingPlayAfterRender) {
        pendingPlayAfterRender = false;
        try {
          playing = true;
          playPause.innerHTML = pauseHtml;
          playPCM(false,currentFrame<specWidth*0.8?minCol:specWidth*0.8); 
        } catch (e) { console.warn("playPCM() failed after render:", e); }
        const playPauseEl = document.getElementById("playPause");
        if (playPauseEl) playPauseEl.innerHTML = pauseHtml;
      }

      if (!painting && autoPlayOnFinish) {
          autoPlayOnFinish = false;
          playing = true;
          playPause.innerHTML = pauseHtml;
          playPCM(true,currentFrame<specWidth*0.8?minCol:specWidth*0.8);
      }
      status.style.display = "none";
      minCol = Infinity;
      return false;
    }
    return true;
}

let requestSpecUpdate = false;      
let resolveSpecUpdate = null;       
const SPEC_UPDATE_TIMEOUT_MS = 2000; 

let pendingHistory = false;
let pendingPlayAfterRender = false;

let pendingRecomputeDone = false;
let pendingRecomputeMinCol = null;
let pendingRecomputeMaxCol = null;

function waitForSpecUpdate(timeout = SPEC_UPDATE_TIMEOUT_MS) {

  if (!rendering && !requestSpecUpdate) return Promise.resolve(true);

  return new Promise((resolve) => {

    resolveSpecUpdate = (ok = true) => {

      if (!resolveSpecUpdate) return;
      const r = resolve;
      resolveSpecUpdate = null;
      requestSpecUpdate = false;
      r(ok);
    };

    setTimeout(() => {
      if (resolveSpecUpdate) {
        resolveSpecUpdate(false); 
      }
    }, timeout);
  });
}

function drawLoop() {
    if (!rendering) return;

    const framesPerTick = 200;

    const h = specHeight;
    const w = specWidth;

    for (let f = 0; f < framesPerTick; f++) {
        if (!drawFrame(w,h)) break;
    }

    specCtx.putImageData(imageBuffer, 0, 0);
    renderView();
    drawCursor(true);

    if (requestSpecUpdate && typeof resolveSpecUpdate === 'function') {

      resolveSpecUpdate(true);

    }

    const elapsedMS = performance.now() - startTime;
    const elapsedSec = elapsedMS / 1000;
    const speed = audioProcessed / Math.max(1e-6, elapsedSec); 
    const audioSec = pcm.length / sampleRate; 
    const processedSec = audioProcessed / sampleRate;
    status.textContent = `Progress: ${(100*pos/pcm.length).toFixed(1)}% | ` 
        + `Elapsed: ${elapsedSec.toFixed(2)}s | `
        + `Audio processed: ${processedSec.toFixed(2)}/${audioSec.toFixed(2)}s | `
        + `Speed: ${(speed/sampleRate).toFixed(2)}x realtime`;
    if (rendering) {
      status.style.display = "block";
      requestAnimationFrame(() => drawLoop());
    }
}

function drawCursor(clear){
    if (previewingShape && clear) {
      previewShape($x, $y);
    } else {
      const x = (currentCursorX-iLow) * canvas.width / (iHigh-iLow);
      if (clear) overlayCtx.clearRect(0,0, canvas.width, canvas.height);
      overlayCtx.strokeStyle = "#0f0";
      overlayCtx.lineWidth = iWidth/500;
      overlayCtx.beginPath();
      overlayCtx.moveTo(x + 0.5, 0);
      overlayCtx.lineTo(x + 0.5, specHeight);
      overlayCtx.stroke();
      if (alignTime) {
        overlayCtx.strokeStyle = "#222";
        for (let i = 0; i < specWidth; i += (sampleRate/fftSize)/subBeat * (120/bpm)) {
          const x = (i-iLow)* canvas.width / (iHigh-iLow);
          overlayCtx.beginPath();
          overlayCtx.moveTo(x,0);
          overlayCtx.lineTo(x,specHeight);
          overlayCtx.stroke();
        }
      }
    }
}

function updateCanvasScroll() {
    if (!imageBuffer || !specCanvas) return;

    const viewWidth = Math.max(1, Math.floor(iHigh - iLow));
    const fStart = Math.max(0, Math.floor(specHeight * (1 - fHigh / (sampleRate/2))));
    const fEnd = Math.min(specHeight, Math.floor(specHeight * (1 - fLow / (sampleRate/2))));
    const viewHeight = Math.max(1, fEnd - fStart);

    canvas.width = viewWidth;
    canvas.height = viewHeight;

    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.drawImage(
        specCanvas,
        Math.max(0, Math.floor(iLow)), fStart, 
        viewWidth, viewHeight,                 
        0, 0,                                  
        canvas.width, canvas.height            
    );

    overlayCanvas.width = canvas.width;
    overlayCanvas.height = canvas.height;
    overlayCtx.clearRect(0, 0, overlayCanvas.width, overlayCanvas.height);

    drawCursor(true);
}

function renderView() {
    if (!specCanvas || !imageBuffer) return;

    const viewWidth = Math.max(1, Math.floor(iHigh - iLow));
    const fStart = Math.max(0, Math.floor(specHeight * (1 - fHigh / (sampleRate/2))));
    const fEnd = Math.min(specHeight, Math.floor(specHeight * (1 - fLow / (sampleRate/2))));
    const viewHeight = Math.max(1, fEnd - fStart);

    canvas.width = viewWidth;
    canvas.height = viewHeight;

    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.drawImage(
        specCanvas,
        Math.max(0, Math.floor(iLow)), fStart, 
        viewWidth, viewHeight,                 
        0, 0,                                  
        canvas.width, canvas.height            
    );

    overlayCanvas.width = canvas.width;
    overlayCanvas.height = canvas.height;
    overlayCanvas.style.width = canvas.style.width;
    overlayCanvas.style.height = canvas.style.height;
}

let painting=false;
let paintedPixels=null;

function getCanvasCoords(e,touch){
    const rect=canvas.getBoundingClientRect();
    const scaleX=canvas.width/rect.width;
    const scaleY=canvas.height/rect.height;
    let x; let y;
    if (touch && e.touches.length === 0) {
        x = _cx; y = _cy;
    } else {
        x = touch ? e.touches[0].clientX : e.clientX;
        y = touch ? e.touches[0].clientY : e.clientY;
        _cx = x; _cy = y;
    }
    return {cx:(x-rect.left)*scaleX, cy:(y-rect.top)*scaleY, scaleX, scaleY};
}

</script>
<script src="drawTools.js"></script>
<script>

function hzToNoteName(frequency) {
  if (frequency <= 0) return "0";
  const A4 = 440;
  const A4_MIDI = 69;
  const midi = Math.round(12 * Math.log2(frequency / A4) + A4_MIDI);
  const noteNames = ["C", "C#", "D", "D#", "E", "F", 
                     "F#", "G", "G#", "A", "A#", "B"];
  const note = noteNames[(midi+1200) % 12];
  const octave = Math.floor(midi / 12) - 1;
  const ret = `${note}${octave}`;
  return ret;
}
let sineOsc = null;
let sineGain = null;
function getSineFreq(cy) {
    const h = specHeight;
    const s = parseFloat(logScaleVal); 
    let bin;
    if (s <= 1.0000001) {
        bin = h - 1 - cy;
    } else {
        const a = s - 1;
        const denom = Math.log(1 + a * (h - 1));
        const t = 1 - cy / (h - 1);
        bin = (Math.exp(t * denom) - 1) / a;
    }
    bin = Math.max(0, Math.min(h - 1, bin));
    return bin * sampleRate / fftSize;
}
function setSineFreq(cy) {
    sineOsc.frequency.setTargetAtTime(getSineFreq(cy), audioCtx.currentTime, 0.01);
}
function visibleToSpecY(visY) {
    const fStart = Math.max(0, Math.floor(specHeight * (1 - fHigh / (sampleRate/2))));
    const fullY = Math.round(visY + fStart);
    return Math.max(0, Math.min(specHeight - 1, fullY));
}
let snapshotMags = null;
let snapshotPhases = null;

function cxToFrame(cx) {
  return Math.floor((cx/canvas.width*(iWidth/specWidth)+iLow)*specWidth);
}

function frameToCx(frame) {
  return ((frame-iLow)/(iWidth/specWidth)*1);
}
let sx2 = 0, sy2 = 0;

function canvasMouseDown(e,touch) {console.log(pendingHistory);
    if (!touch) zooming=false;
    if (!mags || !phases) return;
    if (!touch && e.button !== 0) return;
    if (pendingHistory) return; 

    painting = true;

    snapshotMags = new Float32Array(mags);
    snapshotPhases = new Float32Array(phases);

    visited = new Uint8Array(mags.length);
    stopSource();
    paintedPixels = new Set();
    const {cx,cy,scaleX,scaleY} = getCanvasCoords(e,touch);
    startX = cx; startY = cy;
    if (alignTime) {
      const snapSize = 30/bpm/subBeat;
      const startTime = Math.floor((cx/(sampleRate/hopSizeEl.value))/snapSize)*snapSize;
      const startFrame0 = Math.round((startTime*(sampleRate/hopSizeEl.value)) + iLow);
      sx2 = cx; sy2 = cy;
      startX = startFrame0 - iLow;
    }
    overlayCtx.clearRect(0,0,overlayCanvas.width, overlayCanvas.height);
    const realY = visibleToSpecY(cy);
    mouseVelocity=9999;
    if (!(currentShape === "rectangle" || currentShape === "line")) {
        paint(cx + iLow, realY);
    }
    currentFrame = Math.floor(cx);
    ensureAudioCtx();
    mouseDown = true;
    playFrame(currentFrame);

    if (!sineOsc) {
        sineOsc = audioCtx.createOscillator();
        sineOsc.type = "sine";
        sineGain = audioCtx.createGain();
        sineGain.gain.value = 0.2 * document.getElementById("drawVolume").value*document.getElementById('masterVolume').value;
        sineOsc.connect(sineGain).connect(audioCtx.destination);
        setSineFreq(realY); 
        sineOsc.start();
    }
}
canvas.addEventListener("mousedown", e=>{
    canvasMouseDown(e,false);
});
canvas.addEventListener("touchstart", e=>{
    canvasMouseDown(e,true);
});
let previewingShape = false;
let prevCx=0,prevCy=0;
function canvasMouseMove(e,touch) {
    if (zooming) return;
    const {cx,cy,scaleX,scaleY} = getCanvasCoords(e,touch);
    if (!recording) {
      const hz = getSineFreq(visibleToSpecY(cy));
      const secs = Math.floor(cx/(sampleRate/hopSizeEl.value)*10000)/10000;
      const hx = Math.floor(cx);
      const hy = Math.floor(hz/(sampleRate/fftSize));
      const i = hx*specHeight+hy;
      let normalizedMag = Math.min(1, mags[i] / 256);
      let db = (20 * Math.log10(normalizedMag)).toFixed(1);
      info.innerHTML=`Pitch: ${hz.toFixed(0)}hz (${hzToNoteName(hz)}) <br>Time: ${secs}<br>Loudness: ${db} db`
    }
    if (!painting && (currentShape === "brush" || currentShape === "image")) {
        previewShape(cx, cy);
        previewingShape = true;
        return;
    }
    if(!painting && currentTool != "image") return;
    
    mouseVelocity = Math.sqrt(Math.pow(cx-prevCx,2)+Math.pow(cy-prevCy,2));
    if (currentShape !== "brush") {
        previewShape(cx, cy);
        previewingShape = true;
    } else {
        overlayCtx.clearRect(0, 0, overlayCanvas.width, overlayCanvas.height);
        const realY = visibleToSpecY(cy);
        paint(cx + iLow, realY);
        drawCursor(true);
    }

    currentFrame = Math.floor(cx+iLow);
    if (mouseDown) {
        playFrame(currentFrame);
        if (sineOsc) setSineFreq( visibleToSpecY(cy) ); 
    }

    currentCursorX = currentFrame;
    prevCx=cx;prevCy=cy;
}
canvas.addEventListener("mousemove", e=>{
    canvasMouseMove(e,false);
});
canvas.addEventListener("touchmove", e=>{
    canvasMouseMove(e,true);
});

</script>
<script src="undoredo.js"></script>
<script>
function canvasMouseUp(e,touch) {
    previewingShape = false;
    if (zooming) return;
    if (!mags || !phases || !painting) return;
    minCol = Infinity; maxCol = -Infinity;
    visited = null;
    painting = false;
    paintedPixels = null;
    mouseDown = false;
    stopSource();
    if (sineOsc) {
        sineOsc.stop();
        sineOsc.disconnect();
        sineOsc = null;
        sineGain = null;
    }
    const { cx, cy } = getCanvasCoords(e,touch);
    if (currentShape === "rectangle" || currentShape === "line") {
        commitShape(cx, cy); 
        overlayCtx.clearRect(0,0,overlayCanvas.width,overlayCanvas.height);
    }
    if (alignTime && currentTool === "color") {
      const startFrame = Math.round(cx + iLow);
      const snapSize = 30/bpm/subBeat;
      const brushS = brushSize*fWidth/sampleRate*fftSize/512;

      let startTime = Math.floor((sx2/(sampleRate/hopSizeEl.value))/snapSize)*snapSize + ((cx<startX) ? snapSize : 0);
      let startFrame0 = Math.round((startTime*(sampleRate/hopSizeEl.value)) + iLow);
      line(startFrame0, sx2, visibleToSpecY(sy2), visibleToSpecY(sy2),brushS);

      startTime = Math.floor((cx/(sampleRate/hopSizeEl.value))/snapSize)*snapSize + ((cx>startX) ? snapSize : 0);
      startFrame0 = Math.round((startTime*(sampleRate/hopSizeEl.value)) + iLow);
      line(startFrame0, cx, visibleToSpecY(cy), visibleToSpecY(cy),brushS);
    }

    startX=startY=null;

    startTime = performance.now();
    audioProcessed = 0;

    if (snapshotMags && snapshotPhases && mags && phases) {

      autoRecomputePCM(-1,-1);

      pendingHistory = true;
      pendingPlayAfterRender = true; 
    } else {

      playPCM(startFrame = currentFrame);
      const playPauseEl = document.getElementById("playPause");
      if (playPauseEl) playPauseEl.innerHTML = pauseHtml;
    }

    let startFrame = calcMinMaxCol().minCol;
    if (startFrame == Infinity) startFrame = 0;
    pos = startFrame * hop;
    x = startFrame;
    rendering = true;
    requestAnimationFrame(() => drawLoop());

    startTime = performance.now();
    audioProcessed = 0;

}

let minCol = Infinity; maxCol = -Infinity;
function calcMinMaxCol() {
  if (minCol != Infinity) return {minCol,maxCol};
  if (snapshotMags == null || snapshotMags.length != mags.length) {minCol = 0;maxCol=specWidth;return {minCol,maxCol};}
  const epsMag = 1e-6;
  const epsPhase = 1e-3;
  const h = specHeight;
  const total = mags.length;
  for (let idx = 0; idx < total; idx++) {
    const oldM = (snapshotMags) ? snapshotMags[idx] : 0;
    const newM = mags[idx] ?? 0;
    if (Math.abs(oldM - newM) > epsMag) {
      const col = Math.floor(idx / h);
      if (col < minCol) minCol = col;
      if (col > maxCol) maxCol = col;
      continue;
    }
    const oldP = (snapshotPhases) ? snapshotPhases[idx] : 0;
    const newP = phases[idx] || 0;
    if (Math.abs(angleDiff(oldP, newP)) > epsPhase) {
      const col = Math.floor(idx / h);
      if (col < minCol) minCol = col;
      if (col > maxCol) maxCol = col;
    }
  }
  if (isFinite(minCol)) {
    minCol = Math.max(0, minCol);
    maxCol = Math.min(specWidth - 1, maxCol);
    const overlapCols = Math.ceil(fftSize / Math.max(1, hop)); // how many frames overlap a sample
    minCol = Math.max(0, minCol - overlapCols);
    maxCol = Math.min(specWidth - 1, maxCol + overlapCols);
  }
  return {minCol,maxCol};
}

function autoRecomputePCM(min,max) {
  let minCol, maxCol;
  if (min == -1) {
    let a = calcMinMaxCol();
    minCol=a.minCol;maxCol=a.maxCol;
  } else {
    minCol = min;
    maxCol = max;
  }

  if (isFinite(minCol)) {

    try {
      recomputePCMForCols(minCol, maxCol, { oldMags: snapshotMags, oldPhases: snapshotPhases });

      pendingRecomputeDone = true;
      pendingRecomputeMinCol = minCol;
      pendingRecomputeMaxCol = maxCol;
    } catch (e) {
      console.warn("Immediate recomputePCMForCols failed, will attempt recompute after render:", e);
      pendingRecomputeDone = false;
      pendingRecomputeMinCol = pendingRecomputeMaxCol = null;
    }
  } else {

    pendingRecomputeDone = false;
    pendingRecomputeMinCol = pendingRecomputeMaxCol = null;
  }
}

function newHistory() {
  pendingHistory = false; 
  const epsMag = 0.001;
  const epsPhase = 0.001;

  const changedIdxs = [];
  const prevMags = [];
  const prevPhases = [];

  const h = specHeight;
  const startF = minCol*fftSize/2
  const endF = maxCol*fftSize/2; 

  for (let idx = startF; idx < endF; idx++) {
    const oldM = snapshotMags[idx] || 0;
    const newM = mags[idx] || 0;
    if (Math.abs(oldM - newM) > epsMag) {
      changedIdxs.push(idx);
      prevMags.push(oldM);
      prevPhases.push(snapshotPhases[idx] || 0);
      continue;
    }

    const oldP = snapshotPhases[idx] || 0;
    const newP = phases[idx] || 0;
    if (Math.abs(angleDiff(oldP, newP)) > epsPhase) {
      changedIdxs.push(idx);
      prevMags.push(oldM);
      prevPhases.push(oldP);
    }
  }

  if (changedIdxs.length > 0) {

    let minCol = Infinity, maxCol = -Infinity;
    for (let k = 0; k < changedIdxs.length; k++) {
      const col = Math.floor(changedIdxs[k] / h);
      if (col < minCol) minCol = col;
      if (col > maxCol) maxCol = col;
    }
    if (!isFinite(minCol)) { minCol = 0; maxCol = 0; }

    const indicesArr = new Uint32Array(changedIdxs);
    const prevMagsArr = new Float32Array(prevMags);
    const prevPhasesArr = new Float32Array(prevPhases);

    pushHistory({
        type: 'paint',
        indices: indicesArr,
        prevMags: prevMagsArr,
        prevPhases: prevPhasesArr,
        minCol: Math.max(0, minCol),
        maxCol: Math.min(specWidth - 1, maxCol),
        maxSize: specWidth,
        hopSize: hopSizeEl.value,
        fftSize: fftSize
    });
  }
}

document.addEventListener("mouseup", e => {
    canvasMouseUp(e,false);
});
document.addEventListener("touchend", e => {
    canvasMouseUp(e,true);
});

let sourceNode = null;
let playing = false;
let mouseDown = false;
let pausedAtSample = null; 
let sourceStartTime = 0; 
let wasPlayingDuringDrag = false;

initEmptyPCM();

function updateCursorLoop() {
    if (playing && !painting && pcm && sourceNode) {
        const elapsed = audioCtx.currentTime - sourceStartTime; 
        let samplePos = elapsed * sampleRate;

        if (sourceNode.loop) {
            samplePos = samplePos % pcm.length; 
        }

        const frame = Math.floor(samplePos / hop);
        currentCursorX = Math.min(frame, specWidth - 1);

        specCtx.putImageData(imageBuffer, 0, 0);
        renderView();
        drawCursor(false);
        drawEQ();
    }
    requestAnimationFrame(updateCursorLoop);
}
updateCursorLoop();

function stopSource(preservePaused=false){
    if(sourceNode){
        try { sourceNode.stop(); } catch(e) {  }
        try { sourceNode.disconnect(); } catch(e) {  }
        sourceNode = null;
    }

    if (!preservePaused) pausedAtSample = null;
    playing = false;
}

function _getPlaybackTarget() {

  if (typeof curveEQ !== 'undefined' && curveEQ && curveEQ.inited && curveEQ.eqInput) {

    if (typeof updateCurveEQ === 'function') {
      try { updateCurveEQ(); } catch (e) {  }
    }
    return curveEQ.eqInput;
  }

  if (typeof eqInput !== 'undefined' && eqInput) return eqInput;

  return audioCtx.destination;
}


function showVolumeWarningModal() {
  return new Promise(resolve => {
    const overlay = document.createElement('div');
    overlay.innerHTML = `
      <div id="volwarn-overlay" style="
        position: fixed; inset: 0;
        display: flex; align-items: center; justify-content: center;
        background: rgba(0,0,0,0.5);
        z-index: 100000;">
        <div id="volwarn-box" style="
          background: #222;
          padding: 20px 24px;
          border-radius: 10px;
          box-shadow: 0 8px 30px rgba(0,0,0,0.9);
          max-width: 90%;
          width: 340px;
          color: #eee;
          text-align: center;">
          <h2 style="margin: 0 0 10px 0; font-size: 18px;">Volume warning</h2>
          <p style="margin: 0 0 16px 0;">Please turn down your volume.</p>
          <label style="display: flex; align-items: center; gap: 6px; justify-content: center; margin-bottom: 16px; cursor: pointer;">
            <input type="checkbox" id="volwarn-dontshow" />
            <span>Don't show again</span>
          </label>
          <button id="volwarn-ok" style="
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            background: var(--accent-gradient);
            box-shadow: 0 30px 30px rgba(20,0,20,0.3);
            color: black;
            cursor: pointer;
            font-size: 14px;">OK</button>
        </div>
      </div>
    `;
    document.body.appendChild(overlay);

    const okBtn = overlay.querySelector('#volwarn-ok');
    const dontShowBox = overlay.querySelector('#volwarn-dontshow');

    okBtn.addEventListener('click', () => {
      const dontShow = dontShowBox.checked;
      overlay.remove();
      resolve(dontShow);
    });

    overlay.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' || e.key === 'Escape') {
        e.preventDefault();
        okBtn.click();
      }
    });

    // focus for keyboard use
    okBtn.focus();
  });
}

async function playPCM(loop = true, startFrame = null) {
  if (!pcm) return;
  ensureAudioCtx();

  let max = -Infinity;
  for (const v of pcm) if (v > max) max = v;

  const disabled = !!localStorage.getItem('spectrodraw_volume_warning_disabled');
  if (max > 3 && !disabled) {
    const dontShowAgain = await showVolumeWarningModal();
    if (dontShowAgain) {
      try { localStorage.setItem('spectrodraw_volume_warning_disabled', '1'); } catch {}
    }
  }

  if (audioCtx.state === 'suspended') {
    try { await audioCtx.resume(); } catch (e) { console.warn("audioCtx.resume() failed:", e); }
  }

  stopSource(true);

  let startSample = 0;
  if (startFrame !== null && !isNaN(startFrame)) {
      startSample = Math.max(0, Math.min(pcm.length - 1, startFrame * hop));
  } else if (pausedAtSample !== null) {
      startSample = Math.max(0, Math.min(pcm.length - 1, pausedAtSample));
  }

  sourceNode = audioCtx.createBufferSource();
  const buffer = audioCtx.createBuffer(1, pcm.length, sampleRate);
  buffer.copyToChannel(pcm, 0);
  sourceNode.buffer = buffer;
  sourceNode.loop = !!loop;

  try {
    const targetNode = _getPlaybackTarget();
    const gainNode = audioCtx.createGain();
    gainNode.gain.setValueAtTime(document.getElementById("playbackVolume").value*document.getElementById('masterVolume').value, audioCtx.currentTime);

    sourceNode.connect(gainNode);
    gainNode.connect(targetNode);
  } catch (e) {
    try {
      sourceNode.connect(audioCtx.destination);
    } catch (e2) {
      console.warn("connect fallback failed", e2);
    }
  }


  const offsetSec = startSample / sampleRate;
  sourceStartTime = audioCtx.currentTime - offsetSec;
  try {
    sourceNode.start(0, offsetSec);
  } catch (e) {
    const remaining = pcm.length - startSample;
    const shortBuf = audioCtx.createBuffer(1, Math.max(1, remaining), sampleRate);
    shortBuf.copyToChannel(pcm.subarray(startSample, startSample + remaining), 0);
    try { sourceNode.stop(); } catch(_) {}
    try { sourceNode.disconnect(); } catch(_) {}
    sourceNode = audioCtx.createBufferSource();
    sourceNode.buffer = shortBuf;
    sourceNode.loop = !!loop;
    try {
      const targetNode = _getPlaybackTarget();
      sourceNode.connect(targetNode);
    } catch (e2) {
      try { sourceNode.connect(audioCtx.destination); } catch (_) {}
    }
    sourceStartTime = audioCtx.currentTime;
    sourceNode.start();
  }

  playing = true;
  pausedAtSample = null;
}

async function playFrame(frameX) {
  currentCursorX = frameX;
  if (!pcm) return;
  ensureAudioCtx();

  if (audioCtx.state === 'suspended') {
    try { await audioCtx.resume(); } catch (e) { console.warn("audioCtx.resume() failed:", e); }
  }

  stopSource(true);
  const start = frameX * hop;
  const end = Math.min(start + fftSize, pcm.length);
  if (end <= start) return;
  const frameLen = end - start;

  const buffer = audioCtx.createBuffer(1, frameLen, sampleRate);
  buffer.copyToChannel(pcm.subarray(start, end), 0);

  sourceNode = audioCtx.createBufferSource();
  sourceNode.buffer = buffer;
  sourceNode.loop = true; 

  try {
    const targetNode = _getPlaybackTarget();
    sourceNode.connect(targetNode);
  } catch (e) {
    try { sourceNode.connect(audioCtx.destination); } catch (_) {}
  }

  sourceStartTime = audioCtx.currentTime - (start / sampleRate);
  sourceNode.start();
  playing = true;
  pausedAtSample = null;
}

function renderFullSpectrogramToImage() {
    if (!imageBuffer || !mags || !phases) return;
    const w = specWidth, h = specHeight;
    for(let xx=0; xx<w; xx++){

        for(let yy=0; yy<h; yy++){

            const bin = displayYToBin(yy, h);
            const idx = xx * h + bin;
            const mag = mags[idx] || 0;
            const phase = phases[idx] || 0;
            const [r,g,b] = magPhaseToRGB(mag, phase);
            const pix = (yy * w + xx) * 4;
            imageBuffer.data[pix] = r;
            imageBuffer.data[pix+1] = g;
            imageBuffer.data[pix+2] = b;
            imageBuffer.data[pix+3] = 255;
        }
    }
    specCtx.putImageData(imageBuffer, 0, 0);
    renderView();
}

</script>
<script src="downloads.js"></script>
<script>

function processPendingFramesLive(){

  if (!pcm || !fftSize) return;

  while (pos + fftSize <= pcm.length) {
    if (!drawFrame(specWidth, specHeight)) break;
  }

  if (imageBuffer && specCtx) specCtx.putImageData(imageBuffer, 0, 0);
  renderView();
  drawCursor(true);
}

</script>
<script src="brushPreview.js"></script>
<script src="rightClick.js"></script>
<script>

buildBinDisplayLookup();
updateBrushPreview();
updateTimelineCursor();

drawTimeline();
drawYAxis();
drawLogScale();
renderFullSpectrogramToImage();
window.addEventListener('beforeunload', function (e) {
    // Standard message browsers show, custom text is ignored in most browsers
    const confirmationMessage = "Changes may not be saved.";

    e.preventDefault(); // Some browsers require this
    e.returnValue = confirmationMessage; // Standard way to trigger the dialog
});
</script>
<script src="eq.js"></script>
<!-- Tutorial overlay (single-page buttons + per-step dialogs) -->

<div id="tutorialDialog" class="tutorial-dialog hide" role="dialog" aria-live="polite">
    <h3 id="tdTitle">Title</h3>
    <p id="tdText">Text</p>
    <div class="tutorial-actions" id="tdActions">
      <!-- Buttons created dynamically per-step -->
    </div>
  </div>

<script src="tutorial.js"></script>
</body>
</html>