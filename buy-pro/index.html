<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>FFT - SpectroDraw</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#07080b;
      --panel:#0f1720;
      --muted:#9aa4b2;
      --text:#e6eefc;
      --accent1:#4f46e5;
      --accent2:#9333ea;
      --accent3:#ec4899;
      --soft-border: rgba(255,255,255,0.04);
      --card-glow: 0 6px 30px rgba(147,51,234,0.12);
      --card-glow2: 0 6px 30px rgba(255, 255, 255, 0.5);
      --glass-2: rgba(255,255,255,0.02);
      --cta-grad: linear-gradient(90deg,var(--accent1),var(--accent2),var(--accent3));
    }

    *{box-sizing:border-box}
    html,body{
      height:100%;
      margin:0;
      background: radial-gradient(ellipse at 10% 10%, #0b0c14 0%, #090a10 30%, var(--bg) 100%);
      color:var(--text);
      font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;
      line-height:1.6;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }

    nav{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:1rem 2rem;
      position:sticky;
      top:0;
      z-index:40;
      backdrop-filter: blur(8px);
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.06));
      border-bottom: 1px solid var(--soft-border);
    }
    .nav-left{display:flex;align-items:center;gap:1rem}
    .brand{font-weight:800;letter-spacing:0.2px;color:white;text-decoration:none;font-size:1.05rem}
    .nav-right{display:flex;gap:1rem;align-items:center}
    .nav-right a{
      font-weight:600;
      text-decoration:none;
      color:#dfe7ff;
      opacity:0.95;
      padding:.45rem .6rem;
      border-radius:8px
    }
    .nav-right a:hover{
      color:white;
      background:linear-gradient(90deg, rgba(79,70,229,0.12), rgba(147,51,234,0.06));
      box-shadow:0 8px 30px rgba(79,70,229,0.12);
    }

    header.hero{
      position:relative;
      padding:56px 20px;
      display:flex;
      justify-content:center;
      align-items:center;
      overflow:hidden;
    }
    .hero-inner{
      max-width:980px;
      width:100%;
      text-align:center;
      padding:28px;
      border-radius:14px;
      background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005));
      box-shadow:var(--card-glow);
      border:1px solid var(--glass-2);
    }
    .title{
      font-size:2.1rem;
      font-weight:800;
      margin:6px 0 8px 0;
      background:var(--cta-grad);
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
      text-shadow:0 8px 30px rgba(147,51,234,0.08);
    }

    main{
      padding:36px 20px;
      max-width:1100px;
      margin:0 auto 36px;
    }
    .wrap{max-width:980px;margin:18px auto;padding:24px;}
    p{margin:12px 0;color:#d0d9e9}
    strong{color:#fff}
    .section{padding:18px 0;border-top:1px solid var(--soft-border);}
    .section:first-of-type{border-top:0;padding-top:8px}

    .fade-in{animation:fadeIn .7s ease both}
    @keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}

    footer{
      padding:2rem 1rem;
      text-align:center;
      color:var(--muted);
      margin-top:2rem;
      border-top:1px solid var(--soft-border);
      font-size:.95rem
    }
    footer a{color:#cfe3ff;text-decoration:none}
    footer a:hover{text-decoration:underline}
    .star {font-size:28px;padding:none;margin-top:-5px;border:1px solid transparent;background:transparent;cursor:pointer;color:white;}
    button:not(.star, .nav-btn, .primary, .google, .link-btn, .modal-close) {padding:.55rem .9rem;border-radius:8px;border:0;background:linear-gradient(90deg,var(--accent1),var(--accent2));cursor:pointer;color:white;}
    button:disabled{background:#555;color:#333;cursor:not-allowed;}
    a{color:#cfe3ff;}
  </style>
</head>
<body>
  <nav class="nav">
    <div class="nav-left">
      <a href="/" class="brand">SpectroDraw</a>
      <div class="tagline">Interactive Spectrogram Editor</div>
    </div>
    <div class="nav-right">
      <a href="/app" class="nav-link">Launch App</a>
      <a href="/faq" class="nav-link">FAQ</a>
      <a href="/pricing" class="nav-link">Pricing</a>
      <a href="#" id="signup-link" class="nav-link">Sign up</a>
      <a href="#" id="signin-link" class="nav-link">Sign in</a>
      <div id="account-wrap" style="display:none; position:relative;">
        <button id="account-btn" class="nav-btn" aria-haspopup="true" aria-expanded="false" aria-controls="account-menu">
          <span class="acct-avatar" aria-hidden="true">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
              <path d="M12 12c2.761 0 5-2.239 5-5s-2.239-5-5-5-5 2.239-5 5 2.239 5 5 5z" fill="currentColor" />
              <path d="M4 22c0-4.418 3.582-8 8-8s8 3.582 8 8" fill="currentColor" />
            </svg>
          </span>
          <span id="account-email" class="acct-email">you@example.com</span>
          <span class="acct-arrow" aria-hidden="true">▾</span>
        </button>
        <div id="account-menu" class="account-menu" role="menu" aria-hidden="true" style="display:none;">
          <a href="/products" id="my-products" role="menuitem" class="menu-item">My products</a>
          <a id="account-logout" role="menuitem" class="menu-item">Log out</a>
        </div>
      </div>
    </div>
  </nav>
  <div id="login-panel" class="modal-overlay" aria-hidden="true">
    <div id="login-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="login-title">
      <button class="modal-close" aria-label="Close">&times;</button>

      <h2 id="login-title">Sign in</h2>

      <form id="login-form" autocomplete="on">
        <div class="field">
          <label class="label-text" for="email">Email</label>
          <input id="email" name="email" type="email" required placeholder="you@example.com" />
        </div>
        <div class="field signup-only" style="display:none;">
          <label class="label-text" for="username">Username</label>
          <input id="username" name="username" type="text" placeholder="pick-a-username" />
        </div>
        <div class="field">
          <label class="label-text" for="password">Password</label>
          <input id="password" name="password" type="password" required placeholder="Password" />
        </div>
        <div class="field signup-only" style="display:none;">
          <label class="label-text" for="confirm-password">Confirm Password</label>
          <input id="confirm-password" name="confirm-password" type="password" placeholder="Confirm password" />
        </div>
        <button id="primary-btn" type="submit" class="primary">Sign in</button>
        <div class="aux">
          <button id="toggle-signup" type="button" class="link-btn">New? Sign up</button>
          <button id="google-login" type="button" class="google">
            <span class="g-icon" aria-hidden="true">
              <img src="/assets/Google__G__logo.svg" alt="">
            </span>
            <span id="google-btn-text">Log in with Google</span>
          </button>
        </div>
        <div id="login-error" role="alert" class="error" style="display:none;"></div>
      </form>
    </div>
  </div>
  <link rel="stylesheet" type="text/css" href="/accounts.css">
  <script src="/accounts.js"></script>

  <header class="hero">
    <div class="hero-inner fade-in">
      <h1 class="title">Claim Free Early Access</h1>
    </div>
  </header>

<main class="wrap">
  <!-- Placeholder text body the user will fill later -->
  <section class="section body-copy">
    <h2>Why early access matters</h2>
    <p id="body-placeholder">[Write your promotional / explanatory copy here — the text that explains the early-access deal, what users get, expectations, etc.]</p>
  </section>
  <!-- Progress / "checkout" style flow -->
  <section class="section" aria-labelledby="progress-title" style="margin-top:18px;">
    <div id="requireSignin" style="font-size:.95rem;color:var(--muted);">You must be signed in to claim Pro. <a id="signin-cta" href="#">Sign in</a> / <a id="signin-cta" href="#">Sign up</a></div>
    <h3 id="progress-title" style="margin:0 0 20px 0;">Claim SpectroDraw Pro for Free — complete these 2 quick steps</h3>
    <div id="progress-wrap" style="display:flex;flex-direction:column;gap:18px;align-items:stretch;">
      <!-- Visual progress bar (same as before) -->
      <div id="progress-bar" style="position:relative;padding:18px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00));border-radius:12px;border:1px solid var(--soft-border);box-shadow:var(--card-glow2);">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;">
          <div class="node" data-step="1" style="flex:1;text-align:center;">
            <div class="node-circle" id="node-1" style="width:56px;height:56px;border-radius:16px;display:inline-flex;align-items:center;justify-content:center;font-weight:800;background:rgba(255,255,255,0.02);border:1px solid var(--soft-border);">1</div>
            <div style="margin-top:8px;font-weight:700">Write a review</div>
            <div style="color:var(--muted);font-size:.9rem">Star rating + text</div>
          </div>
          <div style="flex-basis:20%;height:6px;align-self:center;">
            <div id="connector-1" style="width:100%;height:6px;border-radius:999px;background:rgba(255,255,255,0.03);overflow:hidden;">
              <div id="connector-1-fill" style="width:0%;height:100%;border-radius:999px;background:var(--accent1);transition:width .4s ease;"></div>
            </div>
          </div>
          <div class="node" data-step="2" style="flex:1;text-align:center;">
            <div class="node-circle" id="node-2" style="width:56px;height:56px;border-radius:16px;display:inline-flex;align-items:center;justify-content:center;font-weight:800;background:rgba(255,255,255,0.02);border:1px solid var(--soft-border);">2</div>
            <div style="margin-top:8px;font-weight:700">Share with a friend</div>
            <div style="color:var(--muted);font-size:.9rem">Send invite or copy link</div>
          </div>
          <div style="flex-basis:20%;height:6px;align-self:center;">
            <div id="connector-2" style="width:100%;height:6px;border-radius:999px;background:rgba(255,255,255,0.03);overflow:hidden;">
              <div id="connector-2-fill" style="width:0%;height:100%;border-radius:999px;background:var(--accent2);transition:width .4s ease;"></div>
            </div>
          </div>
          <div class="node" data-step="3" style="flex:1;text-align:center;">
            <div class="node-circle" id="node-3" style="width:56px;height:56px;border-radius:16px;display:inline-flex;align-items:center;justify-content:center;font-weight:800;background:rgba(255,255,255,0.02);border:1px solid var(--soft-border);">3</div>
            <div style="margin-top:8px;font-weight:700">Claim Pro</div>
            <div style="color:var(--muted);font-size:.9rem">Activate for your account</div>
          </div>
        </div>
        <!--REVIEW-->
        <section id="inline-review" class="section" aria-label="Write a review" style="margin-top:18px;">
          <div style="display:flex;gap:18px;align-items:flex-start;flex-wrap:wrap;">
            <!-- Left: image drag/upload square -->
            <div id="image-area" style="flex:0 0 220px;max-width:220px;">
              <label for="review-image-input" style="display:block;font-weight:700;margin-bottom:8px;text-align:center;">Upload images (Optional)</label>
              <div id="image-drop" tabindex="0" role="button"
                style="width:220px;height:280px;border-radius:12px;border:2px dashed var(--soft-border);background:rgba(255,255,255,0.05);display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;overflow:hidden;">
                <div id="image-preview" style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;color:var(--muted);font-size:.95rem;padding:12px;box-sizing:border-box; text-align:center;">
                  Drag & drop an image here or click to select
                </div>
                <!-- hidden file input -->
                <input id="review-image" type="file" accept="image/*" multiple style="display:none" />
              </div>
            </div>

            <!-- Right: stars top, text + actions below -->
            <div style="flex:1;min-width:280px;display:flex;flex-direction:column;gap:12px;">
              <div>
                <label style="display:block;font-weight:700;margin-bottom:8px;">Your rating</label>
                <div id="star-wrap-inline" style="display:flex;align-items:center;gap:8px;">
                  <div id="stars-inline" role="radiogroup" aria-label="Star rating" style="display:inline-flex;gap:6px;">
                    <button type="button" class="star" data-value="1" aria-checked="false" role="radio" title="1 star">☆</button>
                    <button type="button" class="star" data-value="2" aria-checked="false" role="radio" title="2 stars">☆</button>
                    <button type="button" class="star" data-value="3" aria-checked="false" role="radio" title="3 stars">☆</button>
                    <button type="button" class="star" data-value="4" aria-checked="false" role="radio" title="4 stars">☆</button>
                    <button type="button" class="star" data-value="5" aria-checked="false" role="radio" title="5 stars">☆</button>
                  </div>
                  <div id="selected-rating-inline" style="color:var(--muted);font-size:.95rem;">No rating yet</div>
                </div>
              </div>

              <div>
                <label for="review-text-inline" style="display:block;font-weight:700;margin-bottom:8px;">Your review</label>
                <textarea id="review-text" name="review" rows="6" placeholder="Share a few details to help others (and us) improve..." style="width:100%;height:140px;padding:12px;border-radius:10px;background:rgba(255,255,255,0.05);border:1px solid var(--soft-border);color:var(--text);resize:vertical;font-family:'Inter', 'Segoe UI', sans-serif;"></textarea>
              </div>

              <!-- Actions area (moved here, aligned to right of image input) -->
              <div id="actions" style="display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin-top:4px;">
                <div style="flex:1;margin-top:-6px;">
                  <div id="review-error" role="alert" style="display:none;color:#ffb4b4;align-self:center"></div>
                  <button id="submit-review" type="button" style="width:100%;margin-top:6px;">Submit review</button>
                </div>
                <button id="claim-btn" type="button" disabled>Next Step</button>
                <div id="progress-legend" style="min-width:220px;font-size:.95rem;color:var(--muted);display:flex;gap:8px;align-items:center;">
                  <div id="progress-percent" style="font-weight:700">0%</div>
                  <div style="color:var(--muted)">complete</div>
                </div>
              </div>
            </div>
          </div>
        </section>
        <!--SHARE-->
        <section id="inline-share" class="section" aria-label="Share with a friend" style="display:none; margin-top:18px;">
          <div style="display:flex;flex-direction:column;gap:12px;padding:18px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00));border-radius:12px;border:1px solid var(--soft-border);box-shadow:var(--card-glow);">
            <div style="display:flex;justify-content:space-between;align-items:center;">
              <h3 style="margin:0;">Share SpectroDraw</h3>
            </div>

            <p style="margin:0;color:var(--muted)">Share the product to unlock your claim. Click a social button below — if you're logged in to that service the composer will be pre-filled.</p>

            <div id="social-row" style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px;">
              <button class="social-btn" data-provider="facebook" style="padding:.5rem .8rem;border-radius:8px;border:1px solid var(--soft-border);background:transparent;cursor:pointer">Facebook</button>
              <button class="social-btn" data-provider="X" style="padding:.5rem .8rem;border-radius:8px;border:1px solid var(--soft-border);background:transparent;cursor:pointer">X</button>
              <button class="social-btn" data-provider="pinterest" style="padding:.5rem .8rem;border-radius:8px;border:1px solid var(--soft-border);background:transparent;cursor:pointer">Pinterest</button>
              <button class="social-btn" data-provider="linkedin" style="padding:.5rem .8rem;border-radius:8px;border:1px solid var(--soft-border);background:transparent;cursor:pointer">LinkedIn</button>
              <button class="social-btn" data-provider="reddit" style="padding:.5rem .8rem;border-radius:8px;border:1px solid var(--soft-border);background:transparent;cursor:pointer">Reddit</button>
            </div>

            <div id="social-status" style="margin-top:8px;color:var(--muted);font-size:.95rem"></div>

            <div style="display:flex;gap:8px;align-items:center;margin-top:6px;">
              <input id="share-link" readonly value="https://spectrodraw.com/" style="flex:1;padding:.55rem;border-radius:8px;border:1px solid var(--soft-border);background:transparent;color:var(--text)"/>
              <button id="copy-link" type="button" style="padding:.45rem .8rem;border-radius:8px;border:1px solid var(--soft-border);background:transparent;cursor:pointer">Copy</button>
              <button id="native-share" type="button" style="padding:.45rem .8rem;border-radius:8px;border:1px solid var(--soft-border);background:transparent;cursor:pointer">Share</button>
            </div>

            <div style="display:flex;gap:8px;align-items:center;margin-top:6px;">
              <button id="manual-verify" type="button" style="padding:.5rem .8rem;border-radius:8px;border:1px solid var(--soft-border);background:transparent;cursor:pointer">I shared — verify</button>
              <button id="done-close" type="button" style="margin-left:auto;padding:.5rem .8rem;border-radius:8px;border:1px solid var(--soft-border);background:transparent;cursor:pointer">Done</button>
            </div>
          </div>
        </section>


      </div>
    </div>
  </section>
</main>

  <!-- Updated JS for inline review (put before closing body tag) -->
  <!-- REPLACE the old inline script with this one -->
<script>
(function(){
  /* ---------- per-user state key handling ---------- */
  const stateKeyBase = 'sd_earlyAccess_progress_v1';
  let currentUserId = null; // will be set in checkAuth/loadState
  function getCurrentUserId() {
    try {
      const raw = localStorage.getItem('spectrodraw_user');
      if (!raw) return null;
      const parsed = JSON.parse(raw);
      // try common fields; fallback to raw string
      return parsed?.id || parsed?.user_id || parsed?.email || parsed || null;
    } catch (e) {
      return null;
    }
  }
  function stateKeyFor(userId) {
    return `${stateKeyBase}_${userId ? String(userId) : 'anon'}`;
  }

  /* ---------- default progress structure ---------- */
  let progress = {
    loggedIn: false,
    reviewSubmitted: false,
    shareSent: false,        // verified share
    shareTentative: false,   // popup closed but not verified
    claimed: false,
    rating: 0,
    reviewText: '',
    inviteEmails: []
  };

  /* ---------- elements ---------- */
  const reviewSection = document.getElementById('inline-review');
  const submitReviewBtn = document.getElementById('submit-review');
  const starsInline = document.querySelectorAll('#stars-inline .star');
  const selectedRatingInline = document.getElementById('selected-rating-inline');
  const reviewTextEl = document.getElementById('review-text');
  const reviewImageInput = document.getElementById('review-image');
  const imageDrop = document.getElementById('image-drop');
  const imagePreview = document.getElementById('image-preview');
  const reviewError = document.getElementById('review-error');

  const progressPercentEl = document.getElementById('progress-percent');
  const claimBtn = document.getElementById('claim-btn');
  const node1 = document.getElementById('node-1');
  const node2 = document.getElementById('node-2');
  const node3 = document.getElementById('node-3');
  const connector1Fill = document.getElementById('connector-1-fill');
  const connector2Fill = document.getElementById('connector-2-fill');

  const shareSection = document.getElementById('inline-share');
  const socialRow = document.getElementById('social-row');
  const socialStatus = document.getElementById('social-status');
  const copyLinkBtn = document.getElementById('copy-link');
  const shareLinkInput = document.getElementById('share-link');
  const nativeShareBtn = document.getElementById('native-share');
  const manualVerifyBtn = document.getElementById('manual-verify');
  const doneCloseBtn = document.getElementById('done-close');
  let mediaLink = '';

  const postText = "I'm claiming SpectroDraw Pro — try SpectroDraw for creative sound design!";

  /* ---------- storage helpers (per-user) ---------- */
  function loadStateForCurrentUser(){
    const key = stateKeyFor(currentUserId);
    try{
      const raw = localStorage.getItem(key);
      if(raw){
        const parsed = JSON.parse(raw);
        // merge parsed into progress (preserve missing fields)
        progress = Object.assign({
          loggedIn:false, reviewSubmitted:false, shareSent:false,
          shareTentative:false, claimed:false, rating:0, reviewText:'', inviteEmails:[]
        }, parsed);
      } else {
        // keep defaults but ensure loggedIn reflects currentUserId
        progress = Object.assign({
          loggedIn:false, reviewSubmitted:false, shareSent:false,
          shareTentative:false, claimed:false, rating:0, reviewText:'', inviteEmails:[]
        }, progress);
      }
    }catch(e){
      // ignore error and keep defaults
    }
    // make sure loggedIn matches currentUserId presence
    progress.loggedIn = !!currentUserId;
  }

  function saveStateForCurrentUser(){
    const key = stateKeyFor(currentUserId);
    try{
      localStorage.setItem(key, JSON.stringify(progress));
    }catch(e){}
  }

  /* ---------- auth detection & switching users ---------- */
  function checkAuth(){
    const newUserId = getCurrentUserId();
    // if user changed, persist old user's state then load new user's state
    if(newUserId !== currentUserId){
      // Save existing state for previous user
      if(currentUserId !== null){
        try{ localStorage.setItem(stateKeyFor(currentUserId), JSON.stringify(progress)); }catch(e){}
      }
      // set new current user
      currentUserId = newUserId;
      loadStateForCurrentUser();
    }
    render();
  }

  // call this externally if your accounts.js performs sign-in/out
  window.sdAuthChanged = function(){
    checkAuth();
  };

  /* ---------- UI render ---------- */
  function render(){
    // progress percent (two main steps: review + share) + small bonus for claimed
    const base = ((progress.reviewSubmitted ? 1 : 0) + (progress.shareSent ? 1 : 0)) / 2;
    const percent = Math.round(base * 100 * 0.9) + (progress.claimed ? 10 : 0);
    progressPercentEl.textContent = percent + '%';

    setNodeVisual(node1, progress.reviewSubmitted);
    setNodeVisual(node2, progress.shareSent || progress.shareTentative);
    setNodeVisual(node3, progress.claimed);

    connector1Fill.style.width = progress.reviewSubmitted ? '100%' : '0%';
    connector2Fill.style.width = (progress.reviewSubmitted && (progress.shareSent || progress.shareTentative)) ? '100%' : '0%';

    updateClaimButtonState();

    // signin requirement banner
    const statusEl = document.getElementById('requireSignin');
    if(!progress.loggedIn){
      if(statusEl) statusEl.style.display = "block";
      const newSignin = document.getElementById('signin-cta');
      if(newSignin) newSignin.addEventListener('click', (e)=>{ e.preventDefault(); document.getElementById('signin-link').click(); });
    } else {
      if(statusEl) statusEl.style.display = "none";
    }

    updateStarUI();
    if(progress.reviewText && !reviewTextEl.value) reviewTextEl.value = progress.reviewText;

    // If shareTentative is true but shareSent is false, inform the status
    if(progress.shareTentative && !progress.shareSent){
      socialStatus.style.color = '';
      socialStatus.textContent = 'Share popup closed — click "I shared — verify" or click Next to continue.';
    }

    saveStateForCurrentUser();
  }

  function setNodeVisual(el, done){
    if(!el) return;
    if(done){
      el.style.background = 'linear-gradient(90deg,var(--accent1),var(--accent2))';
      el.style.color = '#fff';
    } else {
      el.style.background = 'rgba(255,255,255,0.02)';
      el.style.color = 'inherit';
    }
  }

  function updateClaimButtonState(){
    if(progress.claimed){
      claimBtn.disabled = true;
      claimBtn.style.cursor = 'default';
      claimBtn.textContent = 'Claimed ✓';
      return;
    }
    // must submit review first
    if(!progress.reviewSubmitted){
      claimBtn.disabled = true;
      claimBtn.style.cursor = 'not-allowed';
      claimBtn.textContent = 'Next Step';
      return;
    }
    // If review submitted then allow Next. If share verified then show Claim text.
    // Also allow Next if shareTentative true (popup closed) so user can continue manually.
    if(!progress.shareSent){
      // enable Next so user can go to / verify share
      claimBtn.disabled = false;
      claimBtn.style.cursor = 'pointer';
      claimBtn.textContent = progress.shareTentative ? 'Next: Verify Share' : 'Next: Share';
      return;
    }
    // share sent and review submitted -> allow claim
    claimBtn.disabled = false;
    claimBtn.style.cursor = 'pointer';
    claimBtn.textContent = 'Claim SpectroDraw Pro';
  }

  /* ---------- STAR / IMAGE / REVIEW ---------- */
  document.querySelectorAll('#stars-inline .star').forEach(s => {
    s.addEventListener('click', () => {
      const v = parseInt(s.dataset.value, 10);
      progress.rating = v;
      updateStarUI();
      saveStateForCurrentUser();
      render();
    });
  });

  function updateStarUI(){
    document.querySelectorAll('#stars-inline .star').forEach(s => {
      if(parseInt(s.dataset.value,10) <= progress.rating) s.textContent = '★';
      else s.textContent = '☆';
    });
    selectedRatingInline.textContent = progress.rating ? progress.rating + ' / 5' : 'No rating yet';
  }

  imageDrop.addEventListener('click', ()=> reviewImageInput.click());
  imageDrop.addEventListener('keydown', (e)=>{ if(e.key === 'Enter' || e.key === ' ') { e.preventDefault(); reviewImageInput.click(); } });
  imageDrop.addEventListener('dragover', (e)=>{ e.preventDefault(); imageDrop.style.borderColor = 'rgba(79,70,229,0.9)'; });
  imageDrop.addEventListener('dragleave', (e)=>{ e.preventDefault(); imageDrop.style.borderColor = 'var(--soft-border)'; });
  imageDrop.addEventListener('drop', (e)=>{ e.preventDefault(); imageDrop.style.borderColor = 'var(--soft-border)'; const files = e.dataTransfer.files; if(files && files[0]) handleFiles(files); });
  reviewImageInput.addEventListener('change', (e)=>{ const files = e.target.files; if(files && files[0]) handleFiles(files); });

  function handleFiles(files){
    const file = files[0];
    if(!file || !file.type.startsWith('image/')) return;
    const reader = new FileReader();
    reader.onload = (ev)=>{
      imagePreview.style.backgroundImage = `url(${ev.target.result})`;
      imagePreview.style.backgroundSize = 'cover';
      imagePreview.style.backgroundPosition = 'center';
      imagePreview.textContent = '';
    };
    reader.readAsDataURL(file);
  }

  submitReviewBtn.addEventListener('click', async ()=>{
    reviewError.style.display = 'none';
    if(!progress.rating){
      reviewError.style.display = 'block';
      reviewError.textContent = 'Please select a star rating before submitting.';
      return;
    }
    if(!progress.loggedIn){
      reviewError.style.display = 'block';
      reviewError.textContent = 'You must be signed in to submit a review.';
      return;
    }

    submitReviewBtn.disabled = true;
    submitReviewBtn.textContent = 'Submitting...';

    const fd = new FormData();
    fd.append('rating', progress.rating);
    fd.append('text', reviewTextEl.value || '');
    const file = document.getElementById('review-image').files && document.getElementById('review-image').files[0];
    if(file) fd.append('image', file);

    try {
      const stored = (() => {
        try { return localStorage.getItem('spectrodraw_user'); } catch (e) { return null; }
      })();
      const res = await fetch('https://api.spectrodraw.com/api/reviews', {
        method: 'POST',
        credentials: 'include',
        body: fd,
        headers: {
          'X-Spectrodraw-User': stored
        }
      });
      if(!res.ok){
        const err = await res.json().catch(()=>({message:'Failed to submit review'}));
        throw new Error(err.message || 'Failed to submit review');
      }
      progress.reviewSubmitted = true;
      progress.reviewText = reviewTextEl.value || '';
      saveStateForCurrentUser();
      render();
      submitReviewBtn.textContent = 'Submitted ✓';
      setTimeout(()=>{ submitReviewBtn.textContent = 'Submit review'; }, 1500);
    } catch(err) {
      reviewError.style.display = 'block';
      reviewError.textContent = 'Error: ' + err.message;
    } finally {
      submitReviewBtn.disabled = false;
    }
  });

  /* ---------- SHARE - intent flow with tentative-share behavior ---------- */

  function shareIntentUrl(provider, link, text, media, title){
    const u = encodeURIComponent(link || window.location.href);
    const t = encodeURIComponent(text || '');
    const m = encodeURIComponent(media || '');
    const titleEnc = encodeURIComponent(title || '');
    switch(provider){
      case 'X':
        return `https://x.com/intent/tweet?text=${t}&url=${u}`;
      case 'facebook':
        return `https://www.facebook.com/sharer/sharer.php?u=${u}` + (t ? `&quote=${t}` : '');
      case 'pinterest':
        return `https://www.pinterest.com/pin/create/bookmarklet/?media=${m}&url=${u}&title=${titleEnc}&description=${t}`;
      case 'linkedin':
        return `https://www.linkedin.com/shareArticle?mini=true&url=${u}`;
      case 'reddit':
        const body = encodeURIComponent(
          [text || '', media ? `\n\n${media}` : ''].join('')
        );
        return `https://www.reddit.com/submit?url=${u}&title=${titleEnc || t}&text=${body}`;
      default:
        return null;
    }
  }

  function openPopup(url, title='Share', w=700, h=600){
    const left = Math.max(0, (screen.width/2) - (w/2));
    const top = Math.max(0, (screen.height/2) - (h/2));
    const opts = `width=${w},height=${h},top=${top},left=${left},toolbar=0,menubar=0,scrollbars=yes`;
    try { return window.open(url, title, opts); } catch (e) { return null; }
  }

  /* ---------- REPLACE the existing socialRow click handler with this block ---------- */
socialRow.addEventListener('click', async (ev) => {
  const btn = ev.target.closest('.social-btn');
  if (!btn) return;
  const provider = btn.dataset.provider;
  socialStatus.style.color = '';
  socialStatus.textContent = `Preparing ${provider}...`;

  if (!progress.loggedIn) {
    socialStatus.style.color = '#ffb4b4';
    socialStatus.textContent = 'Please sign in to SpectroDraw before sharing.';
    return;
  }

  // Pinterest keeps the existing flow (image picker + open pinterest composer)
  if (provider === 'pinterest') {
    socialStatus.textContent = 'Choose an image to pin...';
    try {
      const images = gatherCandidateImages();
      const chosen = await showImagePickerModal(images, {
        title: 'Choose an image to Pin'
      });
      if (!chosen) {
        socialStatus.textContent = 'Pinterest share canceled.';
        return;
      }
      mediaLink = chosen.uploadUrl || chosen.src;
      openPinterestShare(mediaLink);

      function openPinterestShare(mediaUrl) {
        socialStatus.textContent = 'Opening Pinterest composer...';
        const url = shareIntentUrl('pinterest', shareLinkInput.value, postText, mediaUrl, document.title);
        const popup = openPopup(url, 'Share to Pinterest', 800, 720);
        if (!popup) {
          socialStatus.style.color = '#ffb4b4';
          socialStatus.textContent = 'Popup blocked — allow popups for this site and try again.';
          return;
        }
        const poll = setInterval(() => {
          try {
            if (popup.closed) {
              clearInterval(poll);
              progress.shareTentative = true;
              saveStateForCurrentUser();
              socialStatus.style.color = '#b7ffd6';
              socialStatus.textContent = `Popup closed. If you completed a share on Pinterest, click "I shared — verify" or click Next.`;
              render();
            }
          } catch (e) {
            clearInterval(poll);
          }
        }, 600);
      }
    } catch (err) {
      console.error('Pinterest picker error', err);
      socialStatus.style.color = '#ffb4b4';
      socialStatus.textContent = 'Unable to show image picker.';
    }
    return;
  }

  // LinkedIn & Reddit: show text-copy modal then image-download modal, then open composer
  if (provider === 'linkedin' || provider === 'reddit') {
    socialStatus.textContent = `Preparing ${provider} share helper...`;

    try {
      const suggestedText = `I'm claiming SpectroDraw Pro — try SpectroDraw for creative sound design!\n\n${shareLinkInput.value || window.location.href}`;

      const proceedFromText = await showTextCopyModal({
        title: `Share to ${provider[0].toUpperCase() + provider.slice(1)}`,
        text: suggestedText
      });

      if (!proceedFromText) {
        socialStatus.textContent = `${provider[0].toUpperCase() + provider.slice(1)} share canceled.`;
        return;
      }

      const images = gatherCandidateImages();
      const proceedToPost = await showImageDownloadModal(images, {
        title: 'Choose an image for your post (optional)',
        note: 'Please use one of these images in your post (or use your own picture of SpectroDraw). Click an image to download it.'
      });

      if (proceedToPost === null || proceedToPost === false) {
        socialStatus.textContent = `${provider[0].toUpperCase() + provider.slice(1)} share canceled.`;
        return;
      }

      socialStatus.textContent = `Opening ${provider} composer...`;
      const url = shareIntentUrl(provider, shareLinkInput.value, suggestedText, '', document.title);
      if (!url) {
        socialStatus.style.color = '#ffb4b4';
        socialStatus.textContent = `${provider} sharing not supported here.`;
        return;
      }

      const popup = openPopup(url, `Share to ${provider}`, 900, 700);
      if (!popup) {
        socialStatus.style.color = '#ffb4b4';
        socialStatus.textContent = 'Popup blocked — allow popups for this site and try again.';
        return;
      }

      try {
        // Await detection directly (event handler is async so await is valid here)
        const posted = await detectPopupPost(popup, provider, { timeout: 30000 });
        if (posted) {
          socialStatus.style.color = '#b7ffd6';
          socialStatus.textContent = `Verified: post detected on ${provider}. Unlocking...`;
          markShared();
        } else {
          progress.shareTentative = true;
          saveStateForCurrentUser();
          socialStatus.style.color = '#b7ffd6';
          socialStatus.textContent = `Popup closed. If you completed a share on ${provider}, click "I shared — verify" or click Next.`;
          render();
        }
      } catch (err) {
        console.error('detectPopupPost error', err);
        // fallback behavior
        progress.shareTentative = true;
        saveStateForCurrentUser();
        socialStatus.style.color = '#b7ffd6';
        socialStatus.textContent = `Popup closed. If you completed a share on ${provider}, click "I shared — verify" or click Next.`;
        render();
      }
    } catch (err) {
      console.error('Share helper error', err);
      socialStatus.style.color = '#ffb4b4';
      socialStatus.textContent = 'Unable to prepare share helper.';
    }
    return;
  }

  // NEW: For Facebook & X, show the image-download modal (no text modal), then open composer
  if (provider === 'facebook' || provider === 'X') {
    socialStatus.textContent = `Preparing ${provider} image suggestions...`;
    try {
      const images = gatherCandidateImages();
      const proceedToPost = await showImageDownloadModal(images, {
        title: 'Choose an image for your post (optional)',
        note: 'Please use one of these images in your post (or use your own picture of SpectroDraw). Click an image to download it.'
      });

      if (proceedToPost === null || proceedToPost === false) {
        socialStatus.textContent = `${provider[0].toUpperCase() + provider.slice(1)} share canceled.`;
        return;
      }

      socialStatus.textContent = `Opening ${provider} composer...`;
      const suggestedText = `I'm claiming SpectroDraw Pro — try SpectroDraw for creative sound design!\n\n${shareLinkInput.value || window.location.href}`;
      const url = shareIntentUrl(provider, shareLinkInput.value, suggestedText, '', document.title);

      if (!url) {
        socialStatus.style.color = '#ffb4b4';
        socialStatus.textContent = `${provider} sharing not supported here.`;
        return;
      }

      const popup = openPopup(url, `Share to ${provider}`, 850, 650);
      if (!popup) {
        socialStatus.style.color = '#ffb4b4';
        socialStatus.textContent = 'Popup blocked — allow popups for this site and try again.';
        return;
      }

      try {
        // await detection directly
        const posted = await detectPopupPost(popup, provider, { timeout: 30000 });
        if (posted) {
          socialStatus.style.color = '#b7ffd6';
          socialStatus.textContent = `Verified: post detected on ${provider}. Unlocking...`;
          markShared();
        } else {
          progress.shareTentative = true;
          saveStateForCurrentUser();
          socialStatus.style.color = '#b7ffd6';
          socialStatus.textContent = `Popup closed. If you completed a share on ${provider}, click "I shared — verify" or click Next.`;
          render();
        }
      } catch (err) {
        console.error('detectPopupPost error', err);
        progress.shareTentative = true;
        saveStateForCurrentUser();
        socialStatus.style.color = '#b7ffd6';
        socialStatus.textContent = `Popup closed. If you completed a share on ${provider}, click "I shared — verify" or click Next.`;
        render();
      }

    } catch (err) {
      console.error('Facebook/X helper error', err);
      socialStatus.style.color = '#ffb4b4';
      socialStatus.textContent = 'Unable to prepare share helper.';
    }
    return;
  }
});

/* ---------- Helper: gather candidate images ---------- */
function gatherCandidateImages(){
  const imgs=['Sound effect creation', 'Eraser', 'Image overlay', '2-color spectrogram', 'Align pitch and time', 'Amplifier', 'Brush', 'Blur', 'Equalizer'];
  return imgs.map(f=>({src:`/assets/pinterestImages/${f}.jpg`,label:f,isLocal:false}));
}
function isDataUrl(url){
  return typeof url === 'string' && url.startsWith('data:');
}
function showTextCopyModal(opts = {}) {
  const esc = (s='') => String(s).replace(/[&<>"'`]/g, c => ({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;', '`':'&#96;' }[c]));
  return new Promise((resolve) => {
    const wrapper = document.createElement('div');
    wrapper.innerHTML = `
      <div role="dialog" aria-modal="true" style="position:fixed;inset:0;z-index:10000;display:flex;align-items:center;justify-content:center;background:rgba(3,6,12,0.6);backdrop-filter:blur(4px);padding:24px;">
        <div style="width:min(760px,calc(100% - 48px));max-height:85vh;overflow:auto;border-radius:12px;background:#0e0e0f;padding:18px;box-sizing:border-box;border:1px solid rgba(255,255,255,0.04);color:#fff">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
            <strong style="font-size:1.05rem">${esc(opts.title || 'Copy text')}</strong>
            <button id="sd-text-close" aria-label="Close" style="background:transparent;border:0;color:#fff;font-size:18px;cursor:pointer">✕</button>
          </div>
          <div style="margin-bottom:12px">
            <textarea id="sd-textarea" readonly style="width:100%;height:160px;padding:12px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:#0b0b0c;color:#eaeaea;font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;font-size:0.95rem">${esc(opts.text || '')}</textarea>
          </div>
          <div style="display:flex;gap:8px;justify-content:flex-end">
            <button id="sd-copy-btn" type="button" style="padding:.45rem .8rem;border-radius:8px;border:0;background:linear-gradient(90deg,var(--accent1),var(--accent2));color:#fff;cursor:pointer">Copy to clipboard</button>
            <button id="sd-proceed-btn" type="button" style="padding:.45rem .8rem;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:#fff;cursor:pointer">Proceed</button>
            <button id="sd-cancel-btn" type="button" style="padding:.45rem .8rem;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:#fff;cursor:pointer">Cancel</button>
          </div>
        </div>
      </div>
    `;
    document.body.appendChild(wrapper);

    const root = wrapper.firstElementChild;
    const cleanup = () => { try { wrapper.remove(); } catch(e){} };

    root.addEventListener('click', (e) => {
      if (e.target.id === 'sd-text-close' || e.target.id === 'sd-cancel-btn' || e.target === root) {
        cleanup();
        resolve(false);
      }
    });

    document.getElementById('sd-copy-btn').addEventListener('click', async () => {
      const txt = document.getElementById('sd-textarea').value;
      try {
        await navigator.clipboard.writeText(txt);
        socialStatus.style.color = '#b7ffd6';
        socialStatus.textContent = 'Copied text to clipboard.';
      } catch (err) {
        socialStatus.style.color = '#ffb4b4';
        socialStatus.textContent = 'Unable to copy automatically — please highlight and copy manually.';
        // still allow proceed
      }
    });

    document.getElementById('sd-proceed-btn').addEventListener('click', () => {
      cleanup();
      resolve(true);
    });

    document.addEventListener('keydown', function onKey(e) {
      if (e.key === 'Escape') {
        document.removeEventListener('keydown', onKey);
        cleanup();
        resolve(false);
      }
    }, { once: true });

    // focus textarea so user can manually select if needed
    setTimeout(()=> {
      const ta = document.getElementById('sd-textarea');
      if (ta) ta.select();
    }, 30);
  });
}

/* ---------- Helper: showImageDownloadModal(images, opts) ---------- */
/* images: array of { src, label } -> resolves true if user clicked proceed, false if canceled, or null if closed */
function showImageDownloadModal(images = [], opts = {}) {
  const esc = (s='') => String(s).replace(/[&<>"'`]/g, c => ({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;', '`':'&#96;' }[c]));
  return new Promise((resolve) => {
    const wrapper = document.createElement('div');
    wrapper.innerHTML = `
      <div role="dialog" aria-modal="true" style="position:fixed;inset:0;z-index:10000;display:flex;align-items:center;justify-content:center;background:rgba(3,6,12,0.6);backdrop-filter:blur(4px);padding:24px;">
        <div style="width:min(920px,calc(100% - 48px));max-height:85vh;overflow:auto;border-radius:12px;background:#0f0f10;padding:18px;box-sizing:border-box;border:1px solid rgba(255,255,255,0.04);color:#fff">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
            <strong style="font-size:1.05rem">${esc(opts.title || 'Images')}</strong>
            <button id="sd-img-close" aria-label="Close" style="background:transparent;border:0;color:#fff;font-size:18px;cursor:pointer">✕</button>
          </div>
          ${opts.note ? `<div style="color:var(--muted);margin-bottom:12px">${esc(opts.note)}</div>` : ''}
          <div id="sd-img-grid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:12px">
            ${images.map((img, idx) => `
              <div class="sd-img-card" data-idx="${idx}" tabindex="0" style="position:relative;cursor:pointer;border-radius:10px;overflow:hidden;border:1px solid rgba(255,255,255,0.04);background:#0b0b0c">
                <div class="sd-img-thumb" style="width:100%;height:110px;background-size:cover;background-position:center;background-image:url('${esc(img.src || '')}');"></div>
                <div style="padding:8px;font-size:.92rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${esc(img.label || ('Image ' + (idx+1)))}</div>
                <!-- overlay (hidden by default, shown on hover via JS) -->
                <div class="sd-img-overlay" style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.45);opacity:0;transition:opacity .12s">
                  <div style="padding:6px 10px;border-radius:8px;background:rgba(255,255,255,0.06);color:#fff;font-weight:600">Download</div>
                </div>
              </div>
            `).join('')}
          </div>

          <div style="display:flex;justify-content:space-between;align-items:center;margin-top:12px">
            <div style="color:var(--muted);font-size:.9rem">Click images to download them. Hover to reveal download overlay.</div>
            <div style="display:flex;gap:8px">
              <button id="sd-img-cancel" type="button" style="padding:.45rem .8rem;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:#fff;cursor:pointer">Cancel</button>
              <button id="sd-img-proceed" type="button" style="padding:.45rem .8rem;border-radius:8px;border:0;background:linear-gradient(90deg,var(--accent1),var(--accent2));color:#fff;cursor:pointer">Proceed to post</button>
            </div>
          </div>
        </div>
      </div>
    `;
    document.body.appendChild(wrapper);

    const root = wrapper.firstElementChild;
    const cleanup = () => { try { wrapper.remove(); } catch (e) {} };

    // bind hover overlay via event delegation
    root.addEventListener('mouseover', (e) => {
      const card = e.target.closest && e.target.closest('.sd-img-card');
      if (card && root.contains(card)) {
        const overlay = card.querySelector('.sd-img-overlay');
        if (overlay) overlay.style.opacity = '1';
      }
    });
    root.addEventListener('mouseout', (e) => {
      const card = e.target.closest && e.target.closest('.sd-img-card');
      if (card && root.contains(card)) {
        const overlay = card.querySelector('.sd-img-overlay');
        if (overlay) overlay.style.opacity = '0';
      }
    });

    // click to download
    root.addEventListener('click', async (e) => {
      const card = e.target.closest && e.target.closest('.sd-img-card');
      if (card && root.contains(card)) {
        const idx = parseInt(card.getAttribute('data-idx'), 10);
        const img = images[idx] || {};
        if (!img || !img.src) return;

        try {
          // Attempt a simple anchor download first (works if same-origin or CORS allows)
          const filename = (img.label && img.label.replace(/[^\w.-]+/g, '_')) || img.src.split('/').pop() || `image-${Date.now()}.jpg`;

          // If src is data: URL or same-origin, anchor download will work
          const a = document.createElement('a');
          a.style.display = 'none';
          a.href = img.src;
          a.download = filename;
          document.body.appendChild(a);

          // If it's cross-origin and the server doesn't set CORS, browser may navigate instead of downloading.
          // So attempt fetch+blob as fallback.
          let usedFetch = false;
          try {
            a.click();
            // remove afterwards
            setTimeout(()=>{ try { a.remove(); } catch(e){} }, 50);
          } catch (err) {
            // fallback to fetch
            usedFetch = true;
          }

          if (!usedFetch) {
            // We attempted anchor click; but to be more robust, also attempt fetch if anchor didn't start a download.
            // We'll try fetch if the link appears to be cross-origin (contains // and not same origin).
            const sameOrigin = (() => {
              try {
                const u = new URL(img.src, window.location.href);
                return u.origin === window.location.origin;
              } catch(e){ return false; }
            })();
            if (!sameOrigin) {
              // try fetch+blob
              usedFetch = true;
            }
          }

          if (usedFetch) {
            const res = await fetch(img.src, { mode: 'cors' });
            if (!res.ok) throw new Error('Failed to fetch image for download');
            const blob = await res.blob();
            const blobUrl = URL.createObjectURL(blob);
            const a2 = document.createElement('a');
            a2.style.display = 'none';
            a2.href = blobUrl;
            a2.download = filename;
            document.body.appendChild(a2);
            a2.click();
            setTimeout(()=> {
              try { a2.remove(); URL.revokeObjectURL(blobUrl); } catch(e){}
            }, 3000);
          }

          socialStatus.style.color = '#b7ffd6';
          socialStatus.textContent = 'Image download started.';
        } catch (err) {
          console.error('Download error', err);
          socialStatus.style.color = '#ffb4b4';
          socialStatus.textContent = 'Download failed — try right-click -> Save image as...';
        }

        return;
      }

      // close / cancel / click backdrop
      if (e.target.id === 'sd-img-close' || e.target.id === 'sd-img-cancel' || (e.target === root)) {
        cleanup();
        resolve(false);
        return;
      }

      if (e.target.id === 'sd-img-proceed') {
        cleanup();
        resolve(true);
        return;
      }
    });

    document.addEventListener('keydown', function onKey(e) {
      if (e.key === 'Escape') {
        document.removeEventListener('keydown', onKey);
        cleanup();
        resolve(null);
      }
    }, { once: true });

    // focus first image for keyboard users
    setTimeout(()=> {
      const first = root.querySelector('.sd-img-card');
      if (first) first.focus();
    }, 40);
  });
}
/* ---------- Helper: image-picker modal (returns a Promise that resolves to chosen image object or null) ---------- */
// compact innerHTML-based image picker
// replacement showImagePickerModal — compact, innerHTML, fixed delegation, upload button wired
function showImagePickerModal(images, opts = {}) {
  const esc = (s='') => String(s).replace(/[&<>"'`]/g, c => ({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;', '`':'&#96;' }[c]));
  return new Promise((resolve) => {
    const wrapper = document.createElement('div');
    wrapper.innerHTML = `
      <div id="sd-picker-overlay" role="dialog" aria-modal="true"
           style="position:fixed;inset:0;z-index:9999;display:flex;align-items:center;justify-content:center;
                  background:rgba(3,6,12,0.6);backdrop-filter:blur(4px);padding:24px;">
        <div id="sd-picker-box" style="width:min(580px,calc(100% - 48px));max-height:85vh;overflow:auto;
                 border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
                 padding:18px;box-sizing:border-box;border:1px solid rgba(255,255,255,0.04);background:#111">
          <div style="display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:12px">
            <div style="display:flex;gap:12px;align-items:center">
              <button id="sd-picker-upload" type="button" style="padding:.4rem .6rem;border-radius:8px;border:0;background:linear-gradient(90deg,var(--accent1),var(--accent2));color:#fff;cursor:pointer">Upload an image</button>
              <div style="color:var(--muted)">or choose an image to pin...</div>
            </div>
            <button id="sd-picker-close" aria-label="Close" style="background:transparent;border:0;cursor:pointer;font-size:20px">✕</button>
          </div>
          ${opts.note ? `<div style="color:var(--muted);margin-bottom:12px">${esc(opts.note)}</div>` : ''}
          <div id="sd-picker-grid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:12px">
            ${images.map((img, idx) => `
              <button class="sd-picker-card" data-idx="${idx}" type="button"
                      style="cursor:pointer;border:1px solid rgba(255,255,255,0.04);border-radius:10px;padding:8px;
                             background:transparent;text-align:left;display:flex;flex-direction:column;gap:8px;align-items:stretch">
                <div style="width:100%;height:100px;border-radius:8px;background-size:cover;background-position:center;
                            background-image:url('${esc(img.src || '')}')"></div>
                <div style="font-size:.95rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis" title="${esc(img.src || '')}">
                  ${esc(img.label || ('Image ' + (idx+1)))}
                </div>
              </button>
            `).join('')}
          </div>
          <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
            <p>Note: Please click "See it now" to verify your post.</p>
            <button id="sd-picker-cancel" type="button" style="background:transparent;border:1px solid rgba(255,255,255,0.04);
                    padding:.45rem .8rem;border-radius:8px;cursor:pointer">Cancel</button>
          </div>
        </div>
      </div>
    `;
    document.body.appendChild(wrapper);

    const root = wrapper.firstElementChild;
    if (!root) { wrapper.remove(); resolve(null); return; }

    let fileChangeHandler = null;

    const cleanup = () => {
      try { root.removeEventListener('click', onClick); } catch(e){}
      try { document.removeEventListener('keydown', onKey); } catch(e){}
      try { wrapper.remove(); } catch(e){}
      try { const inp = document.getElementById('review-image'); if (inp && fileChangeHandler) inp.removeEventListener('change', fileChangeHandler); } catch(e){}
    };

    const makeSiteBase = (siteOpt) => {
      if (!siteOpt) return window.location.protocol + '//' + window.location.host;
      if (/^https?:\/\//i.test(siteOpt)) return siteOpt.replace(/\/$/, '');
      return 'https://' + siteOpt.replace(/\/$/, '');
    };
    const siteBase = makeSiteBase(opts.site);

    const onClick = (e) => {
      const card = e.target.closest && e.target.closest('.sd-picker-card');
      if (card && root.contains(card)) {
        const idx = parseInt(card.getAttribute('data-idx'), 10);
        const img = images[idx] || {};

        let sourceName = img.source || img.label || '';
        if (!sourceName && img.src) {
          sourceName = img.src.split('/').pop();
        }
        if (!sourceName) sourceName = 'Image ' + (idx + 1);

        let resolved = Object.assign({}, img);
        if (typeof img.src === 'string' && !/^https?:\/\//i.test(img.src)) {
          resolved.uploadUrl = `${siteBase}/assets/pinterestImages/${encodeURIComponent(sourceName)}.jpg`;
        } else {
          resolved.uploadUrl = img.uploadUrl || img.src || '';
        }

        cleanup();
        resolve(resolved);
        return;
      }

      // close / cancel / click backdrop
      if (e.target.id === 'sd-picker-close' || e.target.id === 'sd-picker-cancel' || (e.target === root)) {
        cleanup();
        resolve(null);
        return;
      }

      // at top of function, after computing siteBase you can set default upload endpoint:
      const uploadEndpoint = opts.uploadEndpoint || 'https://api.spectrodraw.com/upload';

      // inside onClick, replace the sd-picker-upload branch with this:
      if (e.target.id === 'sd-picker-upload') {
        const inp = document.getElementById('review-image');
        if (!inp) { alert('Upload input not found'); return; }

        fileChangeHandler = async function () {
          if (!(inp.files && inp.files[0])) return;
          const f = inp.files[0];

          try {
            // Build form and POST to the worker at api.spectrodraw.com
            const fd = new FormData();
            fd.append('file', f, f.name);

            // optional: add metadata if your worker expects it
            // fd.append('originalName', f.name);

            const res = await fetch(uploadEndpoint, {
              method: 'POST',
              body: fd,
              // don't set content-type; browser will set multipart boundary
            });

            if (!res.ok) {
              const text = await res.text().catch(()=>null);
              throw new Error('Upload failed: ' + (text || res.status));
            }

            const j = await res.json();
            if (!j || !j.url) throw new Error('Upload response missing "url"');

            const publicUrl = j.url; // should be an HTTPS, public CDN url

            // return resolved object with src and uploadUrl set to the public CDN url
            cleanup();
            resolve({
              src: publicUrl,
              label: f.name || 'Local upload',
              isLocal: true,
              uploadUrl: publicUrl
            });
            return;
          } catch (err) {
            console.error('Upload error', err);
            alert('Upload failed: ' + (err.message || err));
            // leave modal open so user can retry
          }
        };

        inp.addEventListener('change', fileChangeHandler, { once: true });
        inp.click();
        return;
      }

    };

    const onKey = (e) => {
      if (e.key === 'Escape') { cleanup(); resolve(null); }
      if (e.key === 'Enter') {
        const active = document.activeElement;
        if (active && active.classList && active.classList.contains('sd-picker-card')) {
          const idx = parseInt(active.getAttribute('data-idx'), 10);
          const img = images[idx] || {};
          cleanup();
          resolve(img);
        }
      }
    };

    // NOTE: do NOT stop propagation on the box — delegation needs to see the clicks.
    root.addEventListener('click', onClick);
    document.addEventListener('keydown', onKey);

    setTimeout(()=> {
      const first = root.querySelector('.sd-picker-card');
      if (first) first.focus();
    }, 50);
  });
}
// Call: const posted = await detectPopupPost(popup, provider, { timeout: 30000 });
// If posted === true -> treat as verified share; if false -> treat as tentative/failed.

function detectPopupPost(popup, provider, opts = {}) {
  const { timeout = 30000, pollInterval = 500 } = opts;
  // Determine the "input" URL to compare against (the original intent URL)
  const inputUrl = shareIntentUrl(provider, shareLinkInput.value, postText, mediaLink, document.title)
  console.log(inputUrl);
  return new Promise((resolve) => {
    if (!popup) {
      console.debug('detectPopupPost: no popup provided -> fail');
      resolve(false);
      return;
    }

    let seenDifferent = false;
    let finished = false;

    // Safety timeout
    const kill = setTimeout(() => {
      if (finished) return;
      finished = true;
      console.debug('detectPopupPost: timeout -> resolve false (no URL change observed)');
      try { popup.close(); } catch (e) { /* ignore */ }
      resolve(false);
    }, timeout + 50);

    const stop = () => {
      if (!finished) {
        finished = true;
        clearTimeout(kill);
        clearInterval(timer);
      }
    };

    // If we don't have an inputUrl to compare to, we cannot follow your exact logic;
    // in that case we will just wait for close and return false (consistent with "no change observed").
    if (!inputUrl) {
      console.warn('detectPopupPost: no input intentUrl and could not build one; will return false on close or timeout.');
    }

    const timer = setInterval(() => {
      console.log('hi', inputUrl, popup.location);
      try {
        // 1) if we can read the href and it differs from the original input URL -> SUCCESS
        if (inputUrl) {
          try {
            // Accessing popup.location.href may throw if cross-origin
            const href = popup.location && popup.location.href;
            if (href && href !== inputUrl) {
              console.debug('detectPopupPost: observed href change:', href, 'vs', inputUrl);
              seenDifferent = true;
              stop();
              resolve(true);
              return;
            }
          } catch (e) {
            // cross-origin - cannot read href. We'll continue polling until close or possible same-origin navigation.
            // No-op here.
          }
        }

        // 2) If popup closed -> if we previously observed a different URL => success; else fail (per your logic)
        if (popup.closed) {
          console.debug('detectPopupPost: popup.closed detected. seenDifferent=', seenDifferent);
          stop();
          resolve(Boolean(seenDifferent));
          return;
        }

        // 3) keep polling otherwise
      } catch (err) {
        // Unexpected error -> stop and fail-safe to false
        console.error('detectPopupPost: unexpected error', err);
        stop();
        resolve(false);
      }
    }, pollInterval);
  });
}
  copyLinkBtn.addEventListener('click', async ()=>{
    try{
      await navigator.clipboard.writeText(shareLinkInput.value);
      socialStatus.style.color = '#b7ffd6';
      socialStatus.textContent = 'Copied share link to clipboard.';
    }catch(e){
      socialStatus.style.color = '#ffb4b4';
      socialStatus.textContent = 'Unable to copy automatically — highlight and copy manually.';
    }
  });

  nativeShareBtn.addEventListener('click', async ()=>{
    if(navigator.share){
      try{
        await navigator.share({ title: document.title, text: postText, url: shareLinkInput.value });
        // native share is considered verified immediately
        socialStatus.style.color = '#b7ffd6';
        socialStatus.textContent = 'Native share used — unlocking...';
        markShared(); // full verification
      }catch(e){
        socialStatus.style.color = '#ffb4b4';
        socialStatus.textContent = 'Share cancelled or failed.';
      }
    } else {
      socialStatus.style.color = '#ffb4b4';
      socialStatus.textContent = 'Native share not available on this device.';
    }
  });

  manualVerifyBtn.addEventListener('click', ()=>{
    socialStatus.style.color = '#b7ffd6';
    socialStatus.textContent = 'Thanks — verifying share...';
    markShared();
  });

  doneCloseBtn.addEventListener('click', ()=>{ shareSection.style.display = 'none'; reviewSection.style.display = ''; });

  function markShared(){
    // user-verified share
    progress.shareSent = true;
    progress.shareTentative = false;
    saveStateForCurrentUser();
    render();
    // hide the share UI after short delay
    setTimeout(()=>{ shareSection.style.display = 'none'; reviewSection.style.display = ''; }, 450);
  }

  /* ---------- CLAIM logic (same flow but uses per-user state) ---------- */
  async function performClaim(){
    if(!progress.loggedIn) { alert('Please sign in before claiming.'); return; }
    claimBtn.disabled = true;
    claimBtn.textContent = 'Claiming...';
    try{
      const res = await fetch('https://api.spectrodraw.com/api/claim', {
        method: 'POST',
        credentials: 'include',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({
          proof: {
            reviewSubmitted: progress.reviewSubmitted,
            shareSent: progress.shareSent,
            inviteEmails: progress.inviteEmails.slice(-3)
          }
        })
      });
      if(!res.ok){
        const j = await res.json().catch(()=>({message:'Unable to claim'}));
        throw new Error(j.message || 'Unable to claim');
      }
      const j = await res.json();
      if(j.claimed){
        progress.claimed = true;
        saveStateForCurrentUser();
        render();
        claimBtn.textContent = 'Claimed ✓';
        claimBtn.disabled = true;
        claimBtn.style.cursor = 'default';
      } else {
        throw new Error(j.message || 'Server denied claim');
      }
    }catch(err){
      alert('Claim failed: ' + err.message + '. Make sure you are signed in and completed the required steps.');
      claimBtn.disabled = false;
      claimBtn.textContent = 'Claim SpectroDraw Pro';
    }
  }

  claimBtn.addEventListener('click', async ()=>{
    if(claimBtn.disabled) return;

    // If review submitted but share not verified -> open the share panel for verification
    if(progress.reviewSubmitted && !progress.shareSent){
      // Show share UI — user can verify or use Next to proceed
      shareSection.style.display = 'block';
      reviewSection.style.display = 'none';
      shareSection.scrollIntoView({ behavior:'smooth', block:'center' });
      return;
    }

    // If review + share verified -> perform claim
    if(progress.shareSent && progress.loggedIn && !progress.claimed){
      await performClaim();
    }
  });

  /* ---------- NODE navigation (click nodes to switch) ---------- */
  async function gotoStep(n){
    if(n === 1){
      reviewSection.style.display = '';
      shareSection.style.display = 'none';
      reviewSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
      return;
    }
    if(n === 2){
      // If user hasn't submitted review, move to review first
      if(!progress.reviewSubmitted){
        reviewSection.style.display = '';
        shareSection.style.display = 'none';
        reviewSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
        return;
      }
      shareSection.style.display = 'block';
      reviewSection.style.display = 'none';
      shareSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
      return;
    }
    if(n === 3){
      // If already claimed - show message
      if(progress.claimed){
        alert('You have already claimed SpectroDraw Pro.');
        return;
      }
      // If prerequisites met, attempt claim
      if(progress.reviewSubmitted && progress.shareSent){
        await performClaim();
        return;
      }
      // otherwise show the next missing step
      if(!progress.reviewSubmitted){
        gotoStep(1);
        return;
      }
      if(!progress.shareSent){
        gotoStep(2);
        return;
      }
    }
  }

  // attach listeners to nodes (the clickable circles)
  [node1, node2, node3].forEach((node, idx)=>{
    if(!node) return;
    const step = idx + 1;
    node.style.cursor = 'pointer';
    node.addEventListener('click', ()=> gotoStep(step));
  });

  /* ---------- init ---------- */
  // load initial user and state
  currentUserId = getCurrentUserId();
  loadStateForCurrentUser();
  checkAuth();
  render();

  // debug hooks
  window.sdEarlyAccess = {
    getState: ()=>progress,
    setLoggedIn: (v)=>{ progress.loggedIn = !!v; saveStateForCurrentUser(); render(); },
    forceReloadState: ()=>{ loadStateForCurrentUser(); render(); }
  };

  /* ---------- server-session helper + enhanced storage listener ---------- */

  async function createServerSession(user) {
    if (!user || !user.email) return;
    try {
      const res = await fetch('https://api.spectrodraw.com/auth/session', {
        method: 'POST',
        credentials: 'include',            // IMPORTANT: accept Set-Cookie
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email: user.email, username: user.name || user.username || user.email })
      });
      if (!res.ok) {
        const j = await res.json().catch(()=>({message:'failed'}));
        console.warn('createServerSession failed', j);
        return false;
      }
      // server should have set cookie; update local state and re-check auth
      console.log('createServerSession succeeded for', user.email);
      checkAuth();
      return true;
    } catch (err) {
      console.error('createServerSession error', err);
      return false;
    }
  }

  async function clearServerSession() {
    try {
      await fetch('https://api.spectrodraw.com/auth/logout', {
        method: 'POST',
        credentials: 'include'
      });
      console.log('clearServerSession: logout requested');
    } catch (e) {
      console.warn('clearServerSession error', e);
    } finally {
      checkAuth();
    }
  }

  // watch for spectrodraw_user changes (accounts.js or popup will write this)
  // Replace your existing "message" handler with this:
  // Replace your existing "message" handler with this:
window.addEventListener('message', async (ev) => {
  try {
    if (!ev.data || ev.data.type !== 'oauth-success') return;
    const payload = ev.data;
    const user = payload.user || null;
    const provider = payload.provider || payload.providerName || 'oauth';
    const returnTo = payload.returnTo || payload.returnToUrl || null;

    if (!user || !user.email) {
      console.warn('oauth-success message missing user/email', payload);
      socialStatus.style.color = '#ffb4b4';
      socialStatus.textContent = 'Sign-in returned no user info. Try again.';
      return;
    }

    // 1) Persist a small client-side marker (so client UI can show logged-in immediately)
    const localUser = { email: user.email, name: user.name || user.username || user.email, provider };
    try {
      localStorage.setItem('spectrodraw_user', JSON.stringify(localUser));
    } catch (e) {
      console.warn('localStorage set failed', e);
    }

    // 2) Ask your auth worker to create a server-side session (this sets the session cookie)
    // NOTE: adjust the URL to match your auth host if different
    const authUrl = 'https://auth.spectrodraw.com/auth/session';
    socialStatus.textContent = 'Finalizing sign-in...';

    const createSessionResp = await fetch(authUrl, {
      method: 'POST',
      credentials: 'include',           // crucial: let browser receive Set-Cookie
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email: user.email, username: user.name || user.email })
    });

    if (!createSessionResp.ok) {
      const txt = await createSessionResp.text().catch(()=>'<no-body>');
      console.warn('auth session create failed', createSessionResp.status, txt);
      socialStatus.style.color = '#ffb4b4';
      socialStatus.textContent = 'Sign-in succeeded but creating site session failed. Try again.';
      return;
    }

    // 3) Success: notify UI & global hooks that user is logged in
    socialStatus.style.color = '#b7ffd6';
    socialStatus.textContent = `Signed in as ${user.email}`;

    // If you have a global hook to refresh auth state, call it
    if (typeof window.sdAuthChanged === 'function') {
      try { window.sdAuthChanged(); } catch(e){ /* ignore */ }
    }
    if (window.sdEarlyAccess && typeof window.sdEarlyAccess.setLoggedIn === 'function') {
      try { window.sdEarlyAccess.setLoggedIn(true); } catch(e){ /* ignore */ }
    }

    // if page that opened the popup requested a returnTo, navigate there
    if (returnTo) {
      // returnTo may have been encoded by the oauth worker
      try { window.location.href = returnTo; } catch (e) { /* ignore */ }
    }

  } catch (err) {
    console.error('oauth message handler error', err);
    socialStatus.style.color = '#ffb4b4';
    socialStatus.textContent = 'Sign-in error — try again.';
  }
});

})();
</script>



    
  <footer>
    © <span id="year"></span> SpectroDraw · Built for creative sound design<br>
    <small>Pitch detection powered by <a href="https://github.com/spotify/basic-pitch" target="_blank" rel="noopener">Basic Pitch</a> (© Spotify AB, Apache 2.0)</small><br>
    <a href="/privacy" style="color:white; margin-right:20px;">Privacy</a>
    <a href="/terms" style="color:white;">Terms</a>
  </footer>

  <script>
    document.getElementById('year').textContent = new Date().getFullYear();
  </script>
</body>
</html>