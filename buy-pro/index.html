<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>FFT - SpectroDraw</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#07080b;
      --panel:#0f1720;
      --muted:#9aa4b2;
      --text:#e6eefc;
      --accent1:#4f46e5;
      --accent2:#9333ea;
      --accent3:#ec4899;
      --soft-border: rgba(255,255,255,0.04);
      --card-glow: 0 6px 30px rgba(147,51,234,0.12);
      --card-glow2: 0 6px 30px rgba(255, 255, 255, 0.5);
      --glass-2: rgba(255,255,255,0.02);
      --cta-grad: linear-gradient(90deg,var(--accent1),var(--accent2),var(--accent3));
    }

    *{box-sizing:border-box}
    html,body{
      height:100%;
      margin:0;
      background: radial-gradient(ellipse at 10% 10%, #0b0c14 0%, #090a10 30%, var(--bg) 100%);
      color:var(--text);
      font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;
      line-height:1.6;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }

    nav{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:1rem 2rem;
      position:sticky;
      top:0;
      z-index:40;
      backdrop-filter: blur(8px);
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.06));
      border-bottom: 1px solid var(--soft-border);
    }
    .nav-left{display:flex;align-items:center;gap:1rem}
    .brand{font-weight:800;letter-spacing:0.2px;color:white;text-decoration:none;font-size:1.05rem}
    .nav-right{display:flex;gap:1rem;align-items:center}
    .nav-right a{
      font-weight:600;
      text-decoration:none;
      color:#dfe7ff;
      opacity:0.95;
      padding:.45rem .6rem;
      border-radius:8px
    }
    .nav-right a:hover{
      color:white;
      background:linear-gradient(90deg, rgba(79,70,229,0.12), rgba(147,51,234,0.06));
      box-shadow:0 8px 30px rgba(79,70,229,0.12);
    }

    header.hero{
      position:relative;
      padding:56px 20px;
      display:flex;
      justify-content:center;
      align-items:center;
      overflow:hidden;
    }
    .hero-inner{
      max-width:980px;
      width:100%;
      text-align:center;
      padding:28px;
      border-radius:14px;
      background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005));
      box-shadow:var(--card-glow);
      border:1px solid var(--glass-2);
    }
    .title{
      font-size:2.1rem;
      font-weight:800;
      margin:6px 0 8px 0;
      background:var(--cta-grad);
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
      text-shadow:0 8px 30px rgba(147,51,234,0.08);
    }

    main{
      padding:36px 20px;
      max-width:1100px;
      margin:0 auto 36px;
    }
    .wrap{max-width:980px;margin:18px auto;padding:24px;}
    p{margin:12px 0;color:#d0d9e9}
    strong{color:#fff}
    .section{padding:18px 0;border-top:1px solid var(--soft-border);}
    .section:first-of-type{border-top:0;padding-top:8px}

    .fade-in{animation:fadeIn .7s ease both}
    @keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}

    footer{
      padding:2rem 1rem;
      text-align:center;
      color:var(--muted);
      margin-top:2rem;
      border-top:1px solid var(--soft-border);
      font-size:.95rem
    }
    footer a{color:#cfe3ff;text-decoration:none}
    footer a:hover{text-decoration:underline}
    .star {font-size:28px;padding:none;margin-top:-5px;border:1px solid transparent;background:transparent;cursor:pointer;color:white;}
    button:not(.star, .nav-btn, .primary, .google, .link-btn, .modal-close) {padding:.55rem .9rem;border-radius:8px;border:0;background:linear-gradient(90deg,var(--accent1),var(--accent2));cursor:pointer;color:white;}
    button:disabled{background:#555;color:#333;cursor:not-allowed;}
    a{color:#cfe3ff;}
  </style>
</head>
<body>
  <nav class="nav">
    <div class="nav-left">
      <a href="/" class="brand">SpectroDraw</a>
      <div class="tagline">Interactive Spectrogram Editor</div>
    </div>
    <div class="nav-right">
      <a href="/app" class="nav-link">Launch App</a>
      <a href="/faq" class="nav-link">FAQ</a>
      <a href="/pricing" class="nav-link">Pricing</a>
      <a href="#" id="signup-link" class="nav-link">Sign up</a>
      <a href="#" id="signin-link" class="nav-link">Sign in</a>
      <div id="account-wrap" style="display:none; position:relative;">
        <button id="account-btn" class="nav-btn" aria-haspopup="true" aria-expanded="false" aria-controls="account-menu">
          <span class="acct-avatar" aria-hidden="true">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
              <path d="M12 12c2.761 0 5-2.239 5-5s-2.239-5-5-5-5 2.239-5 5 2.239 5 5 5z" fill="currentColor" />
              <path d="M4 22c0-4.418 3.582-8 8-8s8 3.582 8 8" fill="currentColor" />
            </svg>
          </span>
          <span id="account-email" class="acct-email">you@example.com</span>
          <span class="acct-arrow" aria-hidden="true">▾</span>
        </button>
        <div id="account-menu" class="account-menu" role="menu" aria-hidden="true" style="display:none;">
          <a href="/products" id="my-products" role="menuitem" class="menu-item">My products</a>
          <a id="account-logout" role="menuitem" class="menu-item">Log out</a>
        </div>
      </div>
    </div>
  </nav>
  <div id="login-panel" class="modal-overlay" aria-hidden="true">
    <div id="login-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="login-title">
      <button class="modal-close" aria-label="Close">&times;</button>

      <h2 id="login-title">Sign in</h2>

      <form id="login-form" autocomplete="on">
        <div class="field">
          <label class="label-text" for="email">Email</label>
          <input id="email" name="email" type="email" required placeholder="you@example.com" />
        </div>
        <div class="field signup-only" style="display:none;">
          <label class="label-text" for="username">Username</label>
          <input id="username" name="username" type="text" placeholder="pick-a-username" />
        </div>
        <div class="field">
          <label class="label-text" for="password">Password</label>
          <input id="password" name="password" type="password" required placeholder="Password" />
        </div>
        <div class="field signup-only" style="display:none;">
          <label class="label-text" for="confirm-password">Confirm Password</label>
          <input id="confirm-password" name="confirm-password" type="password" placeholder="Confirm password" />
        </div>
        <button id="primary-btn" type="submit" class="primary">Sign in</button>
        <div class="aux">
          <button id="toggle-signup" type="button" class="link-btn">New? Sign up</button>
          <button id="google-login" type="button" class="google">
            <span class="g-icon" aria-hidden="true">
              <img src="/assets/Google__G__logo.svg" alt="">
            </span>
            <span id="google-btn-text">Log in with Google</span>
          </button>
        </div>
        <div id="login-error" role="alert" class="error" style="display:none;"></div>
      </form>
    </div>
  </div>
  <link rel="stylesheet" type="text/css" href="/accounts.css">
  <script src="/accounts.js"></script>

  <header class="hero">
    <div class="hero-inner fade-in">
      <h1 class="title">Claim Free Early Access</h1>
    </div>
  </header>

<main class="wrap">
  <!-- Placeholder text body the user will fill later -->
  <section class="section body-copy">
    <h2>Why early access matters</h2>
    <p id="body-placeholder">[Write your promotional / explanatory copy here — the text that explains the early-access deal, what users get, expectations, etc.]</p>
  </section>
  <!-- Progress / "checkout" style flow -->
  <section class="section" aria-labelledby="progress-title" style="margin-top:18px;">
    <div id="requireSignin" style="font-size:.95rem;color:var(--muted);">You must be signed in to claim Pro. <a id="signin-cta" href="#">Sign in</a> / <a id="signin-cta" href="#">Sign up</a></div>
    <h3 id="progress-title" style="margin:0 0 20px 0;">Claim SpectroDraw Pro for Free — complete these 2 quick steps</h3>
    <div id="progress-wrap" style="display:flex;flex-direction:column;gap:18px;align-items:stretch;">
      <!-- Visual progress bar (same as before) -->
      <div id="progress-bar" style="position:relative;padding:18px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00));border-radius:12px;border:1px solid var(--soft-border);box-shadow:var(--card-glow2);">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;">
          <div class="node" data-step="1" style="flex:1;text-align:center;">
            <div class="node-circle" id="node-1" style="width:56px;height:56px;border-radius:16px;display:inline-flex;align-items:center;justify-content:center;font-weight:800;background:rgba(255,255,255,0.02);border:1px solid var(--soft-border);">1</div>
            <div style="margin-top:8px;font-weight:700">Write a review</div>
            <div style="color:var(--muted);font-size:.9rem">Star rating + text</div>
          </div>
          <div style="flex-basis:20%;height:6px;align-self:center;">
            <div id="connector-1" style="width:100%;height:6px;border-radius:999px;background:rgba(255,255,255,0.03);overflow:hidden;">
              <div id="connector-1-fill" style="width:0%;height:100%;border-radius:999px;background:var(--accent1);transition:width .4s ease;"></div>
            </div>
          </div>
          <div class="node" data-step="2" style="flex:1;text-align:center;">
            <div class="node-circle" id="node-2" style="width:56px;height:56px;border-radius:16px;display:inline-flex;align-items:center;justify-content:center;font-weight:800;background:rgba(255,255,255,0.02);border:1px solid var(--soft-border);">2</div>
            <div style="margin-top:8px;font-weight:700">Share with a friend</div>
            <div style="color:var(--muted);font-size:.9rem">Send invite or copy link</div>
          </div>
          <div style="flex-basis:20%;height:6px;align-self:center;">
            <div id="connector-2" style="width:100%;height:6px;border-radius:999px;background:rgba(255,255,255,0.03);overflow:hidden;">
              <div id="connector-2-fill" style="width:0%;height:100%;border-radius:999px;background:var(--accent2);transition:width .4s ease;"></div>
            </div>
          </div>
          <div class="node" data-step="3" style="flex:1;text-align:center;">
            <div class="node-circle" id="node-3" style="width:56px;height:56px;border-radius:16px;display:inline-flex;align-items:center;justify-content:center;font-weight:800;background:rgba(255,255,255,0.02);border:1px solid var(--soft-border);">3</div>
            <div style="margin-top:8px;font-weight:700">Claim Pro</div>
            <div style="color:var(--muted);font-size:.9rem">Activate for your account</div>
          </div>
        </div>
        <!--REVIEW-->
        <section id="inline-review" class="section" aria-label="Write a review" style="margin-top:18px;">
          <div style="display:flex;gap:18px;align-items:flex-start;flex-wrap:wrap;">
            <!-- Left: image drag/upload square -->
            <div id="image-area" style="flex:0 0 220px;max-width:220px;">
              <label for="review-image-input" style="display:block;font-weight:700;margin-bottom:8px;text-align:center;">Upload images (Optional)</label>
              <div id="image-drop" tabindex="0" role="button"
                style="width:220px;height:280px;border-radius:12px;border:2px dashed var(--soft-border);background:rgba(255,255,255,0.05);display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;overflow:hidden;">
                <div id="image-preview" style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;color:var(--muted);font-size:.95rem;padding:12px;box-sizing:border-box; text-align:center;">
                  Drag & drop an image here or click to select
                </div>
                <!-- hidden file input -->
                <input id="review-image" type="file" accept="image/*" multiple style="display:none" />
              </div>
            </div>

            <!-- Right: stars top, text + actions below -->
            <div style="flex:1;min-width:280px;display:flex;flex-direction:column;gap:12px;">
              <div>
                <label style="display:block;font-weight:700;margin-bottom:8px;">Your rating</label>
                <div id="star-wrap-inline" style="display:flex;align-items:center;gap:8px;">
                  <div id="stars-inline" role="radiogroup" aria-label="Star rating" style="display:inline-flex;gap:6px;">
                    <button type="button" class="star" data-value="1" aria-checked="false" role="radio" title="1 star">☆</button>
                    <button type="button" class="star" data-value="2" aria-checked="false" role="radio" title="2 stars">☆</button>
                    <button type="button" class="star" data-value="3" aria-checked="false" role="radio" title="3 stars">☆</button>
                    <button type="button" class="star" data-value="4" aria-checked="false" role="radio" title="4 stars">☆</button>
                    <button type="button" class="star" data-value="5" aria-checked="false" role="radio" title="5 stars">☆</button>
                  </div>
                  <div id="selected-rating-inline" style="color:var(--muted);font-size:.95rem;">No rating yet</div>
                </div>
              </div>

              <div>
                <label for="review-text-inline" style="display:block;font-weight:700;margin-bottom:8px;">Your review</label>
                <textarea id="review-text" name="review" rows="6" placeholder="Share a few details to help others (and us) improve..." style="width:100%;height:140px;padding:12px;border-radius:10px;background:rgba(255,255,255,0.05);border:1px solid var(--soft-border);color:var(--text);resize:vertical;font-family:'Inter', 'Segoe UI', sans-serif;"></textarea>
              </div>

              <!-- Actions area (moved here, aligned to right of image input) -->
              <div id="actions" style="display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin-top:4px;">
                <div style="flex:1;margin-top:-6px;">
                  <div id="review-error" role="alert" style="display:none;color:#ffb4b4;align-self:center"></div>
                  <button id="submit-review" type="button" style="width:100%;margin-top:6px;">Submit review</button>
                </div>
                <button id="claim-btn" type="button" disabled>Next Step</button>
                <div id="progress-legend" style="min-width:220px;font-size:.95rem;color:var(--muted);display:flex;gap:8px;align-items:center;">
                  <div id="progress-percent" style="font-weight:700">0%</div>
                  <div style="color:var(--muted)">complete</div>
                </div>
              </div>
            </div>
          </div>
        </section>
        <!--SHARE-->
        <section id="inline-share" class="section" aria-label="Share with a friend" style="display:none; margin-top:18px;">
          <div style="display:flex;flex-direction:column;gap:12px;padding:18px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00));border-radius:12px;border:1px solid var(--soft-border);box-shadow:var(--card-glow);">
            <div style="display:flex;justify-content:space-between;align-items:center;">
              <h3 style="margin:0;">Share SpectroDraw — unlock the next step</h3>
              <div style="display:flex;gap:8px;">
                <button id="close-share" aria-label="Close share" style="background:transparent;border:0;font-size:18px;cursor:pointer">✕</button>
              </div>
            </div>

            <p id="share-instructions" style="margin:0;color:var(--muted)">
              Choose a social service below. We'll ask you to sign in to that service and open a post composer pre-filled with text and a link.
            </p>

            <!-- Social Buttons Row -->
            <div id="social-row" style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px;">
              <button class="social-btn" data-provider="twitter" title="Share on Twitter">Twitter</button>
              <button class="social-btn" data-provider="facebook" title="Share on Facebook">Facebook</button>
              <button class="social-btn" data-provider="pinterest" title="Share on Pinterest">Pinterest</button>
              <button class="social-btn" data-provider="instagram" title="Share on Instagram">Instagram</button>
              <button class="social-btn" data-provider="youtube" title="Share on YouTube">YouTube</button>
            </div>

            <div id="social-status" style="min-height:28px;color:var(--muted);font-size:.95rem"></div>

            <div style="display:flex;gap:8px;align-items:center;">
              <input id="share-link" readonly value="https://spectrodraw.com/?ref=early-access-claim" style="flex:1;padding:.55rem;border-radius:8px;border:1px solid var(--soft-border);background:transparent;color:var(--text)"/>
              <button id="copy-link" type="button" style="padding:.45rem .8rem;border-radius:8px;border:1px solid var(--soft-border);background:transparent;cursor:pointer">Copy</button>
              <button id="native-share" type="button" style="padding:.45rem .8rem;border-radius:8px;border:1px solid var(--soft-border);background:transparent;cursor:pointer">Share</button>
            </div>

            <div style="display:flex;gap:8px;justify-content:flex-end;">
              <!-- Manual fallback when server verification not yet implemented -->
              <button id="manual-verify" type="button" style="background:transparent;border:1px solid var(--soft-border);padding:.45rem .8rem;border-radius:8px;cursor:pointer">I shared — verify</button>
              <button id="done-close" type="button" style="padding:.55rem .9rem;border-radius:8px;">Done</button>
            </div>
          </div>
        </section>

      </div>
    </div>
  </section>
</main>

  <!-- Updated JS for inline review (put before closing body tag) -->
  <script>
(function(){
  const stateKey = 'sd_earlyAccess_progress_v1';
  let progress = {
    loggedIn: false,
    reviewSubmitted: false,
    shareSent: false,
    claimed: false,
    rating: 0,
    reviewText: '',
    inviteEmails: []
  };

  // Elements
  
  const reviewSection = document.getElementById('inline-review');
  const submitReviewBtn = document.getElementById('submit-review');
  const starsInline = document.querySelectorAll('#stars-inline .star');
  const selectedRatingInline = document.getElementById('selected-rating-inline');
  const reviewText = document.getElementById('review-text');
  const reviewImageInput = document.getElementById('review-image');
  const imageDrop = document.getElementById('image-drop');
  const imagePreview = document.getElementById('image-preview');
  const reviewError = document.getElementById('review-error');

  const progressPercentEl = document.getElementById('progress-percent');
  const claimBtn = document.getElementById('claim-btn');
  const node1 = document.getElementById('node-1');
  const node2 = document.getElementById('node-2');
  const node3 = document.getElementById('node-3');
  const connector1Fill = document.getElementById('connector-1-fill');
  const connector2Fill = document.getElementById('connector-2-fill');

  // share modal controls
  const shareModal = document.getElementById('inline-share');

  // load/save state
  function loadState(){ try{ const raw = localStorage.getItem(stateKey); if(raw) Object.assign(progress, JSON.parse(raw)); }catch(e){} }
  function saveState(){ try{ localStorage.setItem(stateKey, JSON.stringify(progress)); }catch(e){} }

  // auth check (keeps old behavior)
  async function checkAuth(){
    progress.loggedIn = document.getElementById('signup-link').style.display == 'none';
    saveState();
    render();
  }

  function render(){
    // progress percent (same algorithm)
    const percent = Math.round(((progress.reviewSubmitted?1:0) + (progress.shareSent?1:0)) / 2 * 100 * 0.9) + (progress.claimed ? 10 : 0);
    progressPercentEl.textContent = percent + '%';

    setNodeState(node1, progress.reviewSubmitted);
    setNodeState(node2, progress.shareSent);
    setNodeState(node3, progress.claimed);

    connector1Fill.style.width = progress.reviewSubmitted ? '100%' : '0%';
    connector2Fill.style.width = (progress.reviewSubmitted && progress.shareSent) ? '100%' : '0%';

    updateClaimButtonState();

    const statusEl = document.getElementById('requireSignin');
    if(!progress.loggedIn){
      statusEl.style.display = "block";
      const newSignin = document.getElementById('signin-cta');
      if(newSignin) newSignin.addEventListener('click', (e)=>{ e.preventDefault(); document.getElementById('signin-link').click(); });
    } else {
      statusEl.style.display = "none";
    }

    updateStarUI();
    if(progress.reviewText && !reviewText.value) reviewText.value = progress.reviewText;
    saveState();
  }

  function setNodeState(el, done){
    if(!el) return;
    if(done){
      el.style.background = 'linear-gradient(90deg,var(--accent1),var(--accent2))';
      el.style.color = '#fff';
    } else {
      el.style.background = 'rgba(255,255,255,0.02)';
      el.style.color = 'inherit';
    }
  }

  // Claim button state & label logic
  function updateClaimButtonState(){
    if(progress.claimed){
      claimBtn.disabled = true;
      claimBtn.style.cursor = 'default';
      claimBtn.textContent = 'Claimed ✓';
      return;
    }
    // disabled until review submitted
    if(!progress.reviewSubmitted){
      claimBtn.disabled = true;
      claimBtn.style.cursor = 'not-allowed';
      claimBtn.textContent = 'Next Step';
      return;
    }

    // review submitted -> enable button
    claimBtn.disabled = false;
    claimBtn.style.cursor = 'pointer';
    if(!progress.shareSent){
      claimBtn.textContent = 'Next: Share';
    } else {
      // share already sent -> button becomes claim action
      claimBtn.textContent = 'Claim SpectroDraw Pro';
    }
  }

  // Star interactions (inline stars)
  document.querySelectorAll('#stars-inline .star').forEach(s => {
    s.addEventListener('click', () => {
      const v = parseInt(s.dataset.value, 10);
      progress.rating = v;
      updateStarUI();
      saveState();
      render(); // update claim button if needed
    });
  });

  function updateStarUI(){
    document.querySelectorAll('#stars-inline .star').forEach(s => {
      if(parseInt(s.dataset.value,10) <= progress.rating) s.textContent = '★';
      else s.textContent = '☆';
    });
    selectedRatingInline.textContent = progress.rating ? progress.rating + ' / 5' : 'No rating yet';
  }

  // Image drag & drop + click-to-select
  imageDrop.addEventListener('click', ()=> reviewImageInput.click());
  imageDrop.addEventListener('keydown', (e)=>{ if(e.key === 'Enter' || e.key === ' ') { e.preventDefault(); reviewImageInput.click(); } });

  imageDrop.addEventListener('dragover', (e)=>{ e.preventDefault(); imageDrop.style.borderColor = 'rgba(79,70,229,0.9)'; });
  imageDrop.addEventListener('dragleave', (e)=>{ e.preventDefault(); imageDrop.style.borderColor = 'var(--soft-border)'; });
  imageDrop.addEventListener('drop', (e)=>{
    e.preventDefault();
    imageDrop.style.borderColor = 'var(--soft-border)';
    const files = e.dataTransfer.files;
    if(files && files[0]) {
      handleFiles(files);
    }
  });

  reviewImageInput.addEventListener('change', (e)=>{
    const files = e.target.files;
    if(files && files[0]) handleFiles(files);
  });

  function handleFiles(files){
    const file = files[0];
    if(!file || !file.type.startsWith('image/')) return;
    const reader = new FileReader();
    reader.onload = (ev)=>{
      imagePreview.style.backgroundImage = `url(${ev.target.result})`;
      imagePreview.style.backgroundSize = 'cover';
      imagePreview.style.backgroundPosition = 'center';
      imagePreview.textContent = '';
    };
    reader.readAsDataURL(file);
  }

  // Submit review (POST to /api/reviews)
  submitReviewBtn.addEventListener('click', async ()=>{
    reviewError.style.display = 'none';
    if(!progress.rating){
      reviewError.style.display = 'block';
      reviewError.textContent = 'Please select a star rating before submitting.';
      return;
    }
    if(!progress.loggedIn){
      reviewError.style.display = 'block';
      reviewError.textContent = 'You must be signed in to submit a review.';
      return;
    }

    submitReviewBtn.disabled = true;
    submitReviewBtn.textContent = 'Submitting...';

    const fd = new FormData();
    fd.append('rating', progress.rating);
    fd.append('text', reviewText.value || '');
    const file = document.getElementById('review-image').files && document.getElementById('review-image').files[0];
    if(file) fd.append('image', file);

    try {
      const res = await fetch('https://api.spectrodraw.com/api/reviews', {
        method: 'POST',
        credentials: 'include',
        body: fd
      });
      if(!res.ok){
        const err = await res.json().catch(()=>({message:'Failed to submit review'}));
        throw new Error(err.message || 'Failed to submit review');
      }
      // mark completed
      progress.reviewSubmitted = true;
      progress.reviewText = reviewText.value || '';
      saveState();
      render();
      submitReviewBtn.textContent = 'Submitted ✓';
      setTimeout(()=>{ submitReviewBtn.textContent = 'Submit review'; }, 1500);
    } catch(err) {
      reviewError.style.display = 'block';
      reviewError.textContent = 'Error: ' + err.message;
    } finally {
      submitReviewBtn.disabled = false;
    }
  });

  // Share modal open/close wiring
  function openShareModal(){
    reviewSection.style.display = 'none';
    shareModal.style.display = 'flex';
    shareModal.setAttribute('aria-hidden', 'false');
  }

  // Updated claim button handler (routes to share modal or performs claim)
  claimBtn.addEventListener('click', async ()=>{
    if(claimBtn.disabled) return;

    // If review submitted but share not sent -> go to share step
    if(progress.reviewSubmitted && !progress.shareSent){
      openShareModal();
      return;
    }

    // If share sent already -> perform claim
    if(progress.shareSent && progress.loggedIn && !progress.claimed){
      claimBtn.disabled = true;
      claimBtn.textContent = 'Claiming...';
      try{
        const res = await fetch('https://api.spectrodraw.com/api/claim', {
          method: 'POST',
          credentials: 'include',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({
            proof: {
              reviewSubmitted: progress.reviewSubmitted,
              shareSentEmails: progress.inviteEmails.slice(-3),
            }
          })
        });
        if(!res.ok) {
          const j = await res.json().catch(()=>({message:'Unable to claim'}));
          throw new Error(j.message || 'Unable to claim');
        }
        const j = await res.json();
        if(j.claimed){
          progress.claimed = true;
          saveState();
          render();
          claimBtn.textContent = 'Claimed ✓';
          claimBtn.disabled = true;
          claimBtn.style.cursor = 'default';
        } else {
          throw new Error(j.message || 'Server denied claim');
        }
      }catch(err){
        alert('Claim failed: ' + err.message + '. Make sure you are signed in and completed the required steps.');
        claimBtn.disabled = false;
        claimBtn.textContent = 'Claim SpectroDraw Pro';
      }
      return;
    }

    // Otherwise (fallback) - no-op
  });

  // init
  loadState();
  render();
  checkAuth();

  // debug
  window.sdEarlyAccess = {
    getState: ()=>progress,
    setLoggedIn: (v)=>{ progress.loggedIn = !!v; saveState(); render(); }
  };

})();
</script>
<script>
/**
 * Social share + OAuth flow:
 *
 * Frontend responsibilities:
 * - Open provider OAuth popup to your oauth worker (e.g. https://oauth.spectrodraw.com/{provider}/login)
 * - Receive postMessage from popup with { type: 'oauth-success', provider, user } (popup must send this)
 * - Save minimal token/user marker in localStorage (so we know the provider is authorized)
 * - Open the provider's share intent URL (where supported) with prefilled text+url
 * - When the share popup closes, call /api/share/verify on your server with { provider, marker }
 *   The server should use the stored OAuth token (server-side) to verify the user actually posted
 * - If /api/share/verify isn't implemented, the manual-verify button exists as a fallback.
 *
 * Server-side TODOs:
 * - Implement OAuth flows for providers on your oauth worker (start -> provider -> callback).
 *   On success the popup should postMessage {type:'oauth-success', provider, marker} to window.opener.
 *   The "marker" is a small opaque ID the server uses to identify that user's token/session (not raw secret).
 * - Implement POST /api/share/verify: takes { provider, marker } and returns { shared: true } when the server
 *   confirms the user posted (provider-specific APIs needed).
 *
 * This file intentionally does not attempt to post on the user's behalf without their explicit action.
 */

(function () {
  const shareSection = document.getElementById('inline-share');
  const socialRow = document.getElementById('social-row');
  const socialStatus = document.getElementById('social-status');
  const closeShareBtn = document.getElementById('close-share');
  const copyLinkBtn = document.getElementById('copy-link');
  const shareLinkInput = document.getElementById('share-link');
  const nativeShareBtn = document.getElementById('native-share');
  const manualVerifyBtn = document.getElementById('manual-verify');
  const doneCloseBtn = document.getElementById('done-close');

  // Keep a small local map of provider -> marker (marker is a server-issued ID or token id)
  const PROVIDER_MARKER_KEY = 'sd_oauth_markers_v1';
  let providerMarkers = {}; // { twitter: 'marker123', facebook: 'marker456' }

  // Prefill text
  const PREFILL_TEXT = "I'm claiming SpectroDraw Pro — try SpectroDraw for creative sound design!";

  // Where to point OAuth popups (your oauth worker must support these paths)
  // e.g. https://oauth.spectrodraw.com/twitter/login?state={returnTo}
  const OAUTH_BASE = 'https://oauth.spectrodraw.com';

  function loadMarkers() {
    try {
      const raw = localStorage.getItem(PROVIDER_MARKER_KEY);
      if (raw) providerMarkers = JSON.parse(raw);
    } catch(e) {}
  }
  function saveMarkers() {
    try { localStorage.setItem(PROVIDER_MARKER_KEY, JSON.stringify(providerMarkers)); } catch(e) {}
  }

  // open popup centered
  function openPopup(url, title = 'Share', w = 600, h = 600) {
    const left = Math.max(0, (screen.width / 2) - (w / 2));
    const top = Math.max(0, (screen.height / 2) - (h / 2));
    const opts = `width=${w},height=${h},top=${top},left=${left},toolbar=0,menubar=0,scrollbars=yes`;
    return window.open(url, title, opts);
  }

  // Share intent URL mapping (prefills text & url when supported)
  function shareIntentUrl(provider, link, text) {
    const u = encodeURIComponent(link || window.location.href);
    const t = encodeURIComponent(text || '');
    switch(provider) {
      case 'twitter':
        return `https://twitter.com/intent/tweet?text=${t}&url=${u}`;
      case 'facebook':
        return `https://www.facebook.com/sharer/sharer.php?u=${u}`;
      case 'pinterest':
        return `https://pinterest.com/pin/create/button/?url=${u}&description=${t}`;
      case 'instagram':
        // Instagram web has no share-intent to prefill a new post; best we can do is open instagram.com
        return `https://www.instagram.com/`;
      case 'youtube':
        // YouTube doesn't have a direct "create post" intent for general links; open YouTube homepage
        return `https://www.youtube.com/`;
      default:
        return null;
    }
  }

  // Kick off OAuth for a provider: open oauth popup that will postMessage back a marker
  // We include a state param so popup can redirect to a simple page that postMessages to opener on success.
  function startProviderOAuth(provider) {
    // `state` could include a returnTo; keep small: provider name and timestamp
    const state = encodeURIComponent(JSON.stringify({ provider, t: Date.now() }));
    const url = `${OAUTH_BASE}/${provider}/login?state=${state}`;
    const popup = openPopup(url, `Login ${provider}`, 700, 700);
    if (!popup) {
      socialStatus.textContent = 'Popup blocked — allow popups for this site and try again.';
      return null;
    }
    socialStatus.textContent = `Please sign in to ${provider} in the popup...`;
    return popup;
  }

  // Called when social button clicked
  async function onSocialButtonClick(provider) {
    socialStatus.style.color = '';
    socialStatus.textContent = `Preparing ${provider}...`;

    // If we don't have a marker for this provider, start OAuth flow first
    if (!providerMarkers[provider]) {
      const popup = startProviderOAuth(provider);
      if (!popup) return;
      // Poll for popup close if the popup doesn't send a postMessage (but it should)
      const poll = setInterval(() => {
        if (popup.closed) {
          clearInterval(poll);
          // If user closed popup without completing OAuth, prompt them
          if (!providerMarkers[provider]) {
            socialStatus.style.color = '#ffb4b4';
            socialStatus.textContent = `Sign-in cancelled. Please try again to sign in to ${provider}.`;
          }
        }
      }, 500);
      return;
    }

    // If we have marker, open share intent prefilled
    const intent = shareIntentUrl(provider, shareLinkInput.value, PREFILL_TEXT);
    if (!intent) {
      socialStatus.style.color = '#ffb4b4';
      socialStatus.textContent = `Sharing to ${provider} is not supported in this browser-based demo.`;
      return;
    }

    socialStatus.style.color = '';
    socialStatus.textContent = `Opening ${provider} composer...`;

    const popup = openPopup(intent, `Share to ${provider}`, 700, 600);
    if (!popup) {
      socialStatus.style.color = '#ffb4b4';
      socialStatus.textContent = 'Popup blocked. Allow popups for this site and try again.';
      return;
    }

    // Poll for popup close; when closed, try server-side verification
    const checkInterval = setInterval(async () => {
      if (popup.closed) {
        clearInterval(checkInterval);
        socialStatus.textContent = `Verifying ${provider} share...`;
        try {
          // Ask your server to verify by provider + marker
          // Server endpoint must look up token for this marker and call provider API to verify posting
          const res = await fetch('/api/share/verify', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ provider, marker: providerMarkers[provider], url: shareLinkInput.value })
          });
          if (res.ok) {
            const j = await res.json();
            if (j.shared) {
              socialStatus.style.color = '#b7ffd6';
              socialStatus.textContent = `Thanks — share verified on ${provider}. Unlocking step...`;
              // mark as shared locally
              markShared();
              return;
            } else {
              // not verified — offer manual fallback
              socialStatus.style.color = '#ffb4b4';
              socialStatus.textContent = `We couldn't automatically verify the share on ${provider}. You can click "I shared — verify" to continue.`;
              return;
            }
          } else {
            socialStatus.style.color = '#ffb4b4';
            socialStatus.textContent = `Verification request failed (server). You can use the manual verify button.`;
            return;
          }
        } catch (err) {
          socialStatus.style.color = '#ffb4b4';
          socialStatus.textContent = `Verification error: ${err.message}. Use manual verify if needed.`;
        }
      }
    }, 700);
  }

  // Mark the share step complete locally (unlocks claim flow)
  function markShared() {
    try {
      // reuse the progress object on window if available
      if (window.sdEarlyAccess && typeof window.sdEarlyAccess.getState === 'function') {
        const state = window.sdEarlyAccess.getState();
        state.shareSent = true;
        // save into localStorage as your app expects
        localStorage.setItem('sd_earlyAccess_progress_v1', JSON.stringify(state));
        if (typeof window.sdEarlyAccess.setLoggedIn === 'function') {
          // re-render if possible
          window.sdEarlyAccess.setLoggedIn(state.loggedIn);
        } else {
          // fallback: reload to make UI reevaluate
          setTimeout(() => window.location.reload(), 600);
        }
      } else {
        // if no global state helper exist, set a simple flag
        localStorage.setItem('sd_share_sent', '1');
        setTimeout(() => window.location.reload(), 600);
      }
    } catch (e) {
      console.error('markShared error', e);
      setTimeout(() => window.location.reload(), 600);
    }
  }

  // Copy link behavior
  copyLinkBtn.addEventListener('click', async () => {
    try {
      await navigator.clipboard.writeText(shareLinkInput.value);
      socialStatus.style.color = '#b7ffd6';
      socialStatus.textContent = 'Copied share link to clipboard.';
    } catch (e) {
      socialStatus.style.color = '#ffb4b4';
      socialStatus.textContent = 'Unable to copy automatically — highlight and copy manually.';
    }
  });

  // Native share fallback
  nativeShareBtn.addEventListener('click', async () => {
    if (navigator.share) {
      try {
        await navigator.share({ title: 'SpectroDraw', text: PREFILL_TEXT, url: shareLinkInput.value });
        socialStatus.style.color = '#b7ffd6';
        socialStatus.textContent = 'Native share used — thank you. If verified server-side you will be unlocked.';
        // markShared() optionally here or wait for server verify/poll
      } catch (e) {
        socialStatus.style.color = '#ffb4b4';
        socialStatus.textContent = 'Share cancelled or failed.';
      }
    } else {
      socialStatus.style.color = '#ffb4b4';
      socialStatus.textContent = 'Native share not available on this device.';
    }
  });

  // Manual verify (user claims they shared)
  manualVerifyBtn.addEventListener('click', async () => {
    // Best-effort: attempt server-side verify if marker exists, otherwise allow manual.
    socialStatus.style.color = '';
    socialStatus.textContent = 'Attempting manual verification...';
    // Attempt server verification across any provider marker we have
    for (const provider of Object.keys(providerMarkers)) {
      try {
        const res = await fetch('/api/share/verify', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ provider, marker: providerMarkers[provider], url: shareLinkInput.value, manual: true })
        });
        if (res.ok) {
          const j = await res.json();
          if (j.shared) {
            socialStatus.style.color = '#b7ffd6';
            socialStatus.textContent = `Verified on ${provider}. Unlocking...`;
            markShared();
            return;
          }
        }
      } catch (e) {
        // ignore and continue to fallback manual accept
      }
    }

    // Fallback: accept user manual claim locally
    socialStatus.style.color = '#b7ffd6';
    socialStatus.textContent = `Thanks — proceeding based on your confirmation. If you abuse this, an admin could revoke access.`;
    markShared();
  });

  // Close/done button just hides the share section
  closeShareBtn.addEventListener('click', () => { shareSection.style.display = 'none'; });
  doneCloseBtn.addEventListener('click', () => { shareSection.style.display = 'none'; });

  // Wire social buttons
  socialRow.addEventListener('click', (ev) => {
    const btn = ev.target.closest('.social-btn');
    if (!btn) return;
    const provider = btn.dataset.provider;
    onSocialButtonClick(provider);
  });

  // Listen for oauth popup postMessage (the oauth worker must call window.opener.postMessage)
  window.addEventListener('message', (ev) => {
    try {
      if (!ev.data || ev.data.type !== 'oauth-success') return;
      const payload = ev.data;
      const prov = payload.provider;
      const marker = payload.marker || payload.tokenMarker || payload.token; // server should send a small marker id
      if (!prov || !marker) {
        console.warn('oauth-success missing provider or marker', payload);
        socialStatus.style.color = '#ffb4b4';
        socialStatus.textContent = 'OAuth returned missing data — please try again.';
        return;
      }
      // Save marker locally so future shares use it
      providerMarkers[prov] = marker;
      saveMarkers();
      socialStatus.style.color = '#b7ffd6';
      socialStatus.textContent = `Signed in to ${prov} as ${payload.user ? (payload.user.username || payload.user.name || payload.user.email) : 'connected account'}. Now click the ${prov} button to open the composer.`;
    } catch (e) {
      console.error('oauth message handling error', e);
    }
  });

  // load existing markers on start
  loadMarkers();

})();
</script>

    
  <footer>
    © <span id="year"></span> SpectroDraw · Built for creative sound design<br>
    <small>Pitch detection powered by <a href="https://github.com/spotify/basic-pitch" target="_blank" rel="noopener">Basic Pitch</a> (© Spotify AB, Apache 2.0)</small><br>
    <a href="/privacy" style="color:white; margin-right:20px;">Privacy</a>
    <a href="/terms" style="color:white;">Terms</a>
  </footer>

  <script>
    document.getElementById('year').textContent = new Date().getFullYear();
  </script>
</body>
</html>